å•æœº 8 å¡ 16Die, æ¯ä¸ª Die 16 ä¸ªä¸“å®¶ä¸ºä¾‹ è®­ç»ƒ " I have a cat"

å…±æœ‰ 8 ä¸ªç®­å¤´ä¸åŒæƒ…å†µã€‚æœ€å¥½çš„æ˜¯ local permutation. æœ€å·®çš„æ˜¯ç»è¿‡ mate è½¬å‘ P2P + D2D + P2P (OCS ç›®å‰æ–¹æ¡ˆ, preferredï¼‰ æˆ–è€… P2P + P2P + D2D ï¼ˆå¯èƒ½ä¸­é—´çš„ P2P ä¼šæˆä¸ºé˜»ç¢åé¢ D2D çš„ç“¶é¢ˆï¼‰ã€‚

# 1

token cat éœ€è¦è·¨ group, å¹¶ä¸”è¢«å¯¹æ–¹ group å¡å…¨éƒ¨ç”¨åˆ°ï¼Œ ä½†æ˜¯åªåœ¨ inter-group è½¬å‘ä¸€æ¬¡ã€‚

ç›¸æ¯” all gather æ— è®ºå¯¹æ–¹è¦ä¸è¦éƒ½å¡è¿‡å»ï¼ŒèŠ‚çœæ•°æ®é‡

UBBv2 ä¸ OCS TOPO ç›¸æ¯”è¦ç®€åŒ–ä¸å°‘ã€‚

å°¤å…¶æ˜¯æœºå†…è¦ç®€åŒ–

1ï¼Œ mate è§’åº¦ï¼š UBBv2 æ¯ä¸ª die éƒ½æ˜¯ inter-group çš„ mate ï¼Œè€Œ OCS åˆ™æ˜¯æŒ‘ dieã€‚ UBBv2 å°‘ä¸€æ¬¡ mate è·³è½¬

2ï¼Œ peer è§’åº¦ï¼š UBBv2 å…¨å¡å…¨ die äº’è”ã€‚å†å°‘ä¸€æ¬¡ peer çš„ è·³è½¬ã€‚

å°‘äº†ä¸¤æ¬¡è·³è½¬ã€‚å¤æ‚åº¦å¤§å¤§é™ä½ã€‚

> è¯´æ˜ï¼šæœ¬æ–‡æ¡£ç”¨äºè®ºè¯åœ¨ ubbv2+rdma æ¡ä»¶ä¸‹ï¼Œæ˜¯å¦æœ‰å¼€å‘çš„ä»·å€¼ï¼Œä»¥åŠé¢ä¸´çš„é—®é¢˜ç“¶é¢ˆã€‚

ä¸€ã€ç“¶é¢ˆ

1ã€reorder æ—¶é—´

- 56MBï¼Œè€—æ—¶ 2.25 ms

- 112MBï¼Œè€—æ—¶ 4.5 ms

- 224MBï¼Œè€—æ—¶ 9ms

2ã€æœºé—´ä¼ è¾“å¸¦å®½ç“¶é¢ˆ 10 - 12 GB/s

ï¼ˆVS. å•æœº EP16 allgather + permute: 16.5 msï¼‰

- 16 æœºï¼ŒTP1DP16PP8EP32ï¼ŒMB1ï¼Œæœºé—´éœ€è¦ä¼ è¾“çš„æ•°æ®é‡ 1 * 4096 * 7169 * sizeof(BF16) = 56 MBï¼Œè€—æ—¶ 56 MB / 11 GB/s = 4.9 msã€‚

- 32 æœºï¼ŒTP1DP16PP16EP32, MB2ï¼Œæœºé—´éœ€è¦ä¼ è¾“çš„æ•°æ®é‡ 2 * 4096 * 7168 * sizeof(BF16) = 112 MBï¼Œè€—æ—¶ 9.8 msã€‚

- 32 æœºï¼ŒTP1DP16PP16EP32, MB4ï¼Œæœºé—´éœ€è¦ä¼ è¾“çš„æ•°æ®é‡ 4 * 4096 * 7168 * sizeof(BF16) = 224 MBï¼Œè€—æ—¶ 19.6 msã€‚

3ã€æœºå†…è½¬å‘

- DMAï¼šå¦‚æœä»¥ token ä¸ºæœ€å°è½¬å‘å•ä½ï¼Œè°ƒç”¨æ¬¡æ•°ä¸Šåƒï¼Œæ­¤æ–¹æ¡ˆä¸å¯è¡Œã€‚

- SPCï¼šé‡‡ç”¨ DeepEP çš„æ–¹å¼ï¼Œéœ€è¦è½¬å‘çš„æ•°æ®é‡ 4 * (112 MB * 2) = 896 MBï¼Œè€—æ—¶ 896 MB / 100 GB/s = 8.96 msã€‚

4ã€å¦‚æœé‡‡ç”¨ï¼Œæœºé—´ç›´æ¥ send/recv colmajorï¼Œé€šä¿¡åï¼Œåœ¨é‡‡ç”¨ SPC DeepEP çš„æ–¹å¼è½¬å‘æ•°æ®ï¼Œåˆ™æ€»è€—æ—¶ï¼š9.8 + 4.4 * 2 = 18.6ï¼Œå¦‚æœæœºå†…ä¸€åŠå¯ä»¥å’Œæœºé—´ send/recv overlapï¼Œåˆ™æ€»è€—æ—¶ 14.2 msã€‚

äºŒã€å¯èƒ½çš„æ”¶ç›Š

1ã€é€šä¿¡å¹¶è¡Œåº¦æé«˜ï¼Œå‡å°‘é€šä¿¡è€—æ—¶ï¼Œè¾¾åˆ°é€šä¿¡è®¡ç®—æ¯” 1:1ï¼Œå†é€šè¿‡ dualpipeï¼Œè¿›è¡Œé€šä¿¡è®¡ç®— overlapã€‚

2ã€shape å˜å¤§ï¼Œç®—å­è®¡ç®—æ•ˆç‡æå‡ã€‚

3ã€æ˜¾å­˜é™ä½ï¼Œå‡å°‘ recomputeã€‚

ä¸‰ã€EP32 ç­–ç•¥

ä¸‹è¡¨ä¸­ç¬¬#1 è¡Œä¸º base caseï¼Œæ˜¾å­˜ä½¿ç”¨é‡çº¦ä¸º max reserved = 61264MBï¼Œå¯¹åº”ä¸‹è¡¨ä¸­è®¡ç®—å…¬å¼ä¸ºï¼ˆA + Mï¼‰ã€‚

|1|16|1|16|8|16|2|4|2048|16|A(tt) + M(lp)|t1|t2|t3|||

|2|16|1|32|16|8|1|8|2048|8|A/2 + M|t1/2|t2||||

|3|16|1|32|16|8|2|8|4096|8|A + 2M|t1|2t2||||

|||||||||||||||||

|4|32|1|32|16|16|1|4|2048|8|A/2 + M/2|t1/2|t2/2|t3|||

|5|32|1|32|16|16|2|4|4096|8|A + M|t1|t2||||

|6|32|1|32|16|16|4|4|8192|8|2A + 2M|2t1|2t2||||

|||||||||||||||||

|7|64|1|64|32|16|1|4|4096|4|A/2 + M/2|t1/2|t2/2||||

```
- #1ï¼šbase case

- #2ï¼šç•¥

- #3ï¼šæ˜¾å­˜å¤ªå…·æŒ‘æˆ˜ï¼Œå…ˆä¸è€ƒè™‘ã€‚

- #4ï¼š

- - æ˜¾å­˜å ç”¨åªæœ‰ "#1 base case" ä¸€åŠï¼Œæ ¹æ®â€œ[1.7offload with recompute]([https://conf01.birentech.com/display/solution/1.7offload+with+recompute](https://conf01.birentech.com/display/solution/1.7offload+with+recompute))â€è®¡ç®—ï¼Œå½“ activation å ç”¨ä»…ä¸ºä¸€åŠï¼Œå¯è€ƒè™‘å…³é—­ recomputeã€‚å•å±‚èƒ½å‡å°‘ 13ms çš„è®¡ç®—æ—¶é•¿ã€‚

- EP32 ç›¸å¯¹ EP16 çš„â€œ#1 base caseâ€ä¼šå¢åŠ æœºé—´åŒå·å¡ä¹‹é—´ 56MB çš„ send/recv è€—æ—¶ï¼Œçº¦ä¸º 4.9msã€‚è¿™ä¸€éƒ¨åˆ†å¯é€šè¿‡æœºé—´ send/recv ä¸æœºå†…çš„ allgather è¿›è¡Œé‡å æ¥æ¶ˆé™¤ï¼Œå¯å‚è€ƒâ€œ[3.UBBv2+RDMAç½‘ç»œä¸Šçš„DeepEP]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883)) ç¬¬äº”èŠ‚â€ã€‚

- ç›¸å¯¹ "#1 base case"ï¼Œpermute+unpermute çš„è¾“å…¥ã€è¾“å‡ºå¤§å°ä¸å˜ï¼Œä¸ä¼šå¢åŠ é¢å¤–çš„è€—æ—¶ã€‚

- #5ï¼šå¯ä»¥å°† TCore åˆ©ç”¨ç‡ä» 42% æé«˜åˆ° 53%ï¼Œèƒ½å‡å°‘ 1/4 çš„ Grouped-GEMM è®¡ç®—æ—¶é—´ã€‚

- #6ï¼šæ˜¾å­˜å¤ªå…·ä½“æŒ‘æˆ˜ï¼Œå…ˆä¸è€ƒè™‘ã€‚

- #7ï¼šæ˜æ˜¾æœ‰ç‚¹åœ¨äºä¸€ä¸ª DP ç»„å°±æœ‰ 512 å¡ï¼Œåœ¨æµ‹è¯•ç¯å¢ƒä¸­ï¼Œæ— é¡»å†æµ‹ DPã€‚æš‚æ—¶çœ‹åˆ°çš„æ€§èƒ½ç“¶é¢ˆç‚¹åœ¨äºï¼Œæœºé—´å’Œæœºå†…é€šä¿¡é‡ç›¸è¾ƒäº "#4 case" åŠ å€ã€‚
```
###

1.1ã€åˆæ­¥ä¼˜åŒ–

å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ topoï¼Œall2all ç®—æ³•æµç¨‹å¦‚ä¸‹ï¼ˆå¦‚ä¸‹æ­¥éª¤ä»…ç¤ºæ„å¦‚ä½•å°† GPU0 ä¸Šçš„æ•°æ®å‘é€åˆ°å…¶ä»–æ‰€æœ‰ GPUï¼Œæ‰€æœ‰ GPU æ“ä½œçš„æ¬¡åºå®Œå…¨ä¸€æ ·ï¼‰ï¼š

step-1ï¼šå¹¶è¡Œæ‰§è¡Œ GPU0â†’ GPU1,2,3,5ï¼Œå‘é€åˆ° GPU5 ä¸Šæ•°æ®åŒ…å«äº†éœ€è¦è½¬å‘åˆ° GPU4, 6,7 çš„æ•°æ®ã€‚

å› ä¸º GPU0â†’ GPU5 çš„æ•°æ®ä¸ºåˆ°å…¶ä»– GPU çš„ 4 å€ï¼Œ

step-2ï¼šå°†ç¼“å­˜åœ¨ GPU5 ä¸Šçš„æ•°æ®ï¼Œè½¬å‘åˆ° GPU4, 6, 7ã€‚

å¸¦å®½è®¡ç®—ï¼šS / tï¼Œå…¶ä¸­ï¼ŒS ä¸ºå‡åŒ€æƒ…å†µä¸‹æ¯ä¸ª rank ä¸Šå‘é€æˆ–æ¥æ”¶çš„æ•°æ®å¤§å°ã€‚step-1 è€—æ—¶ t1 = (S / 2) / Bï¼Œstep-2 è€—æ—¶ t2 = (S / 8) / Bã€‚B = 64 GB/s ä¸ºç›´è¿ GPU é—´ PCIe X16 çš„å•å‘å¸¦å®½ã€‚

é‚£ä¹ˆï¼Œç»¼åˆå¸¦å®½ Bâ€™ = S / (t1 + t2)ï¼Œå¸¦å…¥ t1ã€t2ï¼Œå¯å¾— B' = S/ (5 / 8B) = 8B / 5 = 102.4 GB/sã€‚

## 1.2ã€è¿›ä¸€æ­¥ä¼˜åŒ–

å¦‚ä¸Šå›¾ä¸­ä¸‹éƒ¨ä»½çš„è¡¨æ‰€ç¤ºï¼Œå¦‚æœå°†æ•°æ® d0_5 æœ€åå‘é€ï¼Œé‚£ä¹ˆå°±å¯ä»¥å°† d0_4ã€d0_6ã€d0_7 çš„ä¼ è¾“ä¸ 4GPU Group ç»„å†…çš„ä¼ è¾“ overlap èµ·æ¥ï¼Œä»è€Œæ¶ˆæ‰ step-2 çš„è€—æ—¶ã€‚

é‚£ä¹ˆï¼Œè€—æ—¶ t = (S / 2) / Bï¼Œç»¼åˆå¸¦å®½ B' = S / t = 2B = 128 GB/sã€‚

æ•°æ®é‡ä¼°ç®—ï¼ˆä¸‹é¢ä»…è€ƒè™‘ _**å•æœº**_ æƒ…å†µï¼‰ï¼š

- å•æœºä¸Šæ¯ä¸ª DP éœ€è¦å‘é€çš„æ•°æ® 2 * 4096 * 7168 * sizeof(BF16) * top(8 - 1)= 784 MB

- å‡è®¾å‡åˆ†åˆ°æ¯ä¸ªä¸“å®¶ï¼Œåˆ™éœ€è¦å‘é€åˆ°æ¯ä¸ªä¸“å®¶çš„æ•°æ® 896 MB / 256 = 3.5 MB

éœ€è¦æå‰å‘é€çš„å…ƒæ•°æ®ï¼š

- router: gating + topk

- cal_metadata(input: indices[2*4096, 8], output: all_expert[256])

- non-fused reducescatter(input: all_expert[256], output: local_expert[16])

å‘é€ token æ•°æ®ï¼š

- alltoallv(input: token[2 * 4096 * 7168], indices[2*4096, 8]; output: )

- å‘é€åˆ°æ¯ä¸ª EP Rank ä¸Šçš„æ•°æ® 3.5 MB * 16 = 56 MB

- å› ä¸ºå‘é€åˆ°åŒä¸€ä¸ª EP Rank ä¸Šçš„ token æ•°æ®å¯ä»¥åˆå¹¶ï¼Œä½†è¿™é‡Œå‡è®¾ top-8 ä¸ªä¸“å®¶æ˜¯å‡åŒ€åˆ†å¸ƒåœ¨ 16 ä¸ª EP Rank ä¸Šï¼Œè¿™é‡Œå…ˆå¯ä¸è€ƒè™‘è¿™ä¸ªä¼˜åŒ–ã€‚

- - å¦‚éœ€è€ƒè™‘è¿™ä¸ªä¼˜åŒ–åœ¨è¿›è¡Œ spc all2allv(..., indices[], ...) æ‹·è´æ“ä½œæ—¶ï¼Œè‹¥å‘ç° indices ä¸­ token_i: [1,2, ...] å­˜åœ¨å‘é€åˆ°åŒä¸€ä¸ª EP Rank çš„ä¸“å®¶æ—¶ï¼Œä¸è¦ä» remote pullï¼Œè€Œç›´æ¥è¿›è¡Œ local copyã€‚

# å…­ã€succl all2all åŸå§‹ç®—æ³•æµç¨‹

> referenceï¼š[[BR166] EP16 Alltoallvæ–¹æ¡ˆè®¾è®¡ä¸æ€§èƒ½è¯„ä¼°]([https://conf01.birentech.com/pages/viewpage.action?pageId=216674175](https://conf01.birentech.com/pages/viewpage.action?pageId=216674175))

succl åŸæ¥çš„ topo å®ç°æµç¨‹å¦‚

ç¬¬ä¸€æ­¥ï¼ˆsendï¼‰ï¼šrank 0 ç»™ 4 5 6 7 å‡†å¤‡æ•°æ®ï¼Œå°†å¯¹åº” 4 5 6 7 çš„ offset çš„æ•°æ® copy åˆ° staging bufferï¼›åŒæ—¶ï¼Œrank 8 9 10 11 ç»™ 4 5 6 7 å‡†å¤‡æ•°æ®ï¼Œ4 ä¸ª D2D å’Œ 4 ä¸ª Die2Die å¹¶è¡Œï¼› åˆ‡æµæ°´ï¼Œå‡è®¾ 4spc æ¯æ¬¡åªæ‹‰ 1M æ•°æ®ï¼Œ(0123)4 ä¸ª spc æ‹‰å®Œç¬¬ä¸€æ¬¡æµæ°´ä¹‹åï¼Œ(4567)4 ä¸ª spc å¼€å§‹ p2p å¹¶è¡Œæ‹‰æ•°æ®ï¼›

ç¬¬äºŒæ­¥ï¼ˆrecvï¼‰ï¼šrank 0 ä» 1 2 3 æ‹‰æ•°æ®ï¼Œæ‹‰çš„æ˜¯ 8 9 10 11 ç»™ 4 5 6 7 å‡†å¤‡çš„æ•°æ®ï¼Œå­˜åœ¨ Die2Die çš„ staging buffer ä¸Šï¼ŒåŒæ—¶ä» rank 4 æ‹‰ 1 ä»½æ•°æ® å­˜åˆ° output bufferï¼›4 ä¸ª P2P å¹¶è¡Œï¼›ï¼ˆæ­¤æ—¶ output buffer æœ‰äº† 4ï¼‰ï¼›

rank 4 ä¸Šè¿˜æœ‰ 5 6 7 ä¸‰åˆ†æ•°æ®ï¼Œéœ€è¦ä¸‰ä¸ª P2P ä¸²è¡Œï¼ŒåŒæ—¶ï¼Œrank 12 13 14 15 åœ¨åšå››æ¬¡ Die2Dieï¼Œç»™ rank 0 1 2 3 å‡†å¤‡æ•°æ®ï¼Œå››æ¬¡ DieDie è¦æ‹†å¼€æ¥å’Œä¸‰ä¸ªä¸²è¡Œ P2P å¹¶è¡Œï¼Œä¸ç„¶ä¼šå½±å“æ€§èƒ½ã€‚ï¼ˆä¸‰ä¸ª P2P ä¸²è¡Œç»“æŸä¹‹åï¼Œoutputbuffer æœ‰äº† 5 6 7ï¼‰ï¼›ï¼ˆæ‹‰ 0 1 2 3 çš„æ•°æ®ä¹Ÿå¯ä»¥æ’è¿›æ¥ è¿™ä¸ªä¸‰ä¸ª P2P å¯ä»¥å’ŒæŸä¸€ä¸ª P2P å¹¶è¡Œï¼‰

ç¬¬ä¸‰æ­¥ï¼ˆrecvï¼‰ï¼šrank 0 ä» 1 2 3 æ‹‰æ•°æ®ï¼ŒåŒæ—¶ä» rank 4 æ‹‰ 1 ä»½æ•°æ® å­˜åˆ° output bufferï¼›ï¼ˆæ­¤æ—¶ output buffer æœ‰äº† 12ï¼ŒåŒæ—¶ 13 14 15 çš„æ•°æ®ä¹Ÿå·²ç»åˆ°è¾¾ rank 4ï¼‰ï¼›4 ä¸ª P2Pï¼›

rank 4 ä¸Šè¿˜æœ‰ä¸‰ä»½æ•°æ®ï¼Œéœ€è¦ä¸‰ä¸ª P2P ä¸²è¡Œï¼ŒåŒæ—¶ rank 8 9 10 11 å†åšå››æ¬¡ Die2Die, ç»™ rank 0 1 2 3 å‡†å¤‡æ•°æ®ï¼Œå››æ¬¡ DieDie è¦æ‹†å¼€æ¥å’Œä¸‰ä¸ªä¸²è¡Œ P2P å¹¶è¡Œï¼Œä¸ç„¶ä¼šå½±å“æ€§èƒ½ã€‚ï¼ˆä¸‰ä¸ª P2P ä¸²è¡Œç»“æŸä¹‹åï¼Œoutputbuffer æœ‰äº† 13 14 15ï¼‰ï¼›

ç¬¬å››æ­¥ï¼ˆrecvï¼‰: åœ¨ä¸‰ä¸ª P2P ä¸²è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠ 0 ç›´æ¥ D2D åˆ° outputbufferï¼Œå†åšä¸€ä¸ª Die2Die, æŠŠ 8 çš„æ•°æ® readyï¼›

åˆ‡æµæ°´ï¼Œå‡è®¾ 4spc æ¯æ¬¡åªæ‹‰ 1M æ•°æ®ï¼Œ(0123)4 ä¸ª spc æ‹‰å®Œç¬¬ä¸€æ¬¡æµæ°´ä¹‹åï¼Œ(4567)4 ä¸ª spc å¼€å§‹ p2p å¹¶è¡Œæ‹‰æ•°æ®ï¼›

> ä¸‹é¢ä»…ä»¥ 2 æœº all2all dispatch ä¸ºä¾‹è¿›è¡Œè¯´æ˜ã€‚

1ã€æ•°æ®é‡

- NVï¼š2 * 4096 * 7168 * sizeof(FP8) = 56 MBã€‚

- BRï¼š2 * 4096 * 7168 * sizeof(BF16) = 112 MBã€‚

2ã€å¸¦å®½

> [SPC send recvæ€§èƒ½æ•°æ®å¯¹æ¯”]([https://conf01.birentech.com/pages/viewpage.action?pageId=209781377](https://conf01.birentech.com/pages/viewpage.action?pageId=209781377))

## 2 æœº 2 å¡ï¼šæ¯æœº 1 å¡

SUCCL_BUFF_SIZE=67108864

|1m|0.18|0.10|

|32m|3.88|2.16|

|64m|8.07|3.79|

|128m|7.55|6.37|

|256m|11.04|8.87|

|1G|12.19|11.00|

3ã€è€—æ—¶ä¼°è®¡

- åœ¨ NV ä¸Šï¼Œç”±äºæœºå†…é€šè¿‡ NVLink è½¬å‘çš„æ•°æ®é‡å¤§çº¦æ˜¯æœºé—´ IB å‘é€æ•°æ®é‡çš„ 3 å€â™£ï¼Œä½†æœºå†… NVLink çš„å¸¦å®½æ˜¯æœºé—´å¸¦å®½çš„ (160 GB/s / 50 GB/s = )3.2 å€ï¼Œæ‰€ä»¥ï¼Œ**ç“¶é¢ˆ**ä¸»è¦åœ¨æœºé—´å‘é€çš„ 56 MB æ•°æ®çš„å¸¦å®½ã€‚

- åœ¨ BR ä¸Šï¼Œæœºå†…æœºé—´çš„æ•°æ®å€ç‡å…³ç³»åŒä¸Šï¼Œæœºé—´ã€æœºå†…å¸¦å®½åˆ†åˆ«ä¸º 12 GB/sã€24 GB/sï¼ˆæœºå†…ä¸º DMA å¸¦å®½ï¼ŒSPC ç‰ˆæœ¬å¯ä»¥æ›´é«˜ï¼Œä¸Šé™ä¸º 32 GB/sï¼‰ï¼Œæœºå†…å¸¦å®½å˜ä¸ºæœºé—´å¸¦å®½çš„ 2 å€ï¼Œæ•…**ç“¶é¢ˆ**åŒæ ·æ˜¯æœºé—´å‘é€çš„ 112 MB æ•°æ®çš„å¸¦å®½ã€‚

- BR ä¸Šè€—æ—¶ï¼š112 MB / 12 GB/s = 9.11 msã€‚

ï¼ˆ3 å€â™£ï¼šæ¯ä¸ª token è½¬å‘çš„ top8 ä¸ªä¸“å®¶æœ€å°‘å¯èƒ½ä½äº 1 ä¸ª EP Rankï¼Œæœ€å¤šå¯èƒ½ä½äº 8 ä¸ª EP Rankï¼Œç®€å•å–å…¶å‡å€¼ ä¸º 4.5ï¼Œå³é¡»åœ¨æœºå†…è½¬å‘ 4.5 æ¬¡ï¼Œä½† DeepSeek V3 é™å®šæœ€å¤šå‘ç»™ 3 ä¸ªèŠ‚ç‚¹ï¼Œå–æœ€å°‘ 0 æ¬¡è·¨æœºè½¬å‘å’Œæœ€å¤š 3 æ¬¡è·¨æœºè½¬å‘çš„å‡å€¼ä¸º 1.5ï¼Œä»¥æ­¤ç®—å‡ºæœºå†…æ•°æ®ä¸ºæœºé—´æ•°æ®çš„ 3 å€ã€‚ï¼‰

> ç›®çš„ï¼šå¿«æ·å®ç°ï¼Œä»¥æ‰“é€šæ¨¡å‹å®Œæ•´çš„è·‘é€šè¿‡ç¨‹ï¼Œæ¥æ¶ˆé™¤å¯¹æ¨¡å‹å¾€ä¸‹å¼€å‘å’Œä¼˜åŒ–çš„å½±å“ã€‚

# ä¸€ã€æ‹“æ‰‘ä¸é‚»æ¥å…³ç³»ç®€ä»‹

## 1ã€æ‹“æ‰‘ä¸æ•°æ®ç»“æ„

## 2ã€é‚»æ¥å…³ç³»

peer1 peer2 peer3 mate1(blink) mate2(ib) mate3(port-10 or stranger)

GPU Rank0 GR1 GR2 GR3 GR5 GR8 GR12

GPU Rank1 GR0 GR2 GR3 GR4 GR9 GR13

GPU Rank2 GR0 GR1 GR3 GR7 GR10 GR14

GPU Rank3 GR0 GR1 GR2 GR6 GR11 GR15

GPU Rank4 GR5 GR6 GR7 GR1 GR12 GR8

GPU Rank5 GR4 GR6 GR7 GR0 GR13 GR9

GPU Rank6 GR4 GR5 GR7 GR3 GR14 GR10

GPU Rank7 GR4 GR5 GR6 GR2 GR15 GR11

GPU Rank8 GR9 GR10 GR11 GR13 GR0 GR4

GPU Rank9 GR8 GR10 GR11 GR12 GR1 GR5

GPU Rank10 GR8 GR9 GR11 GR15 GR2 GR6

GPU Rank11 GR8 GR9 GR10 GR14 GR3 GR7

GPU Rank12 GR13 GR14 GR15 GR9 GR4 GR0

GPU Rank13 GR12 GR14 GR15 GR8 GR5 GR1

GPU Rank14 GR12 GR13 GR15 GR11 GR6 GR2

GPU Rank15 GR12 GR13 GR14 GR10 GR7 GR3

# äºŒã€dispatch Layout ç»“æ„ä½“è¯´æ˜å’Œè®¡ç®—

## 1ã€without Port-10

dispatch æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œ**permute**ï¼šä»æœ¬å¡å’Œ peers ä¸Š pull æ•°æ®è¿›è¡Œ permuteã€‚å¦‚**GR0**ä» GR1ã€GR2ã€GR3 æ‹‰å–æ•°æ®åš permuteã€‚

- ç¬¬äºŒæ­¥ï¼Œä¸ç¬¬ä¸€æ­¥åŒæ­¥è¿›è¡Œï¼Œæœ¬å¡ä»è‡ªå·±çš„ mates æ‹‰å–æ•°æ®æ”¾åˆ° stagingbufferã€‚å¦‚ GR0 ä»å…¶ GR5ã€**GR8**æ‹‰å–æ•°æ®ï¼ŒGR1 ä» GR4ã€**GR9**æ‹‰å–æ•°æ®ï¼ŒGR2 ä» GR7ã€**GR10**ï¼ŒGR3 ä» GR6ã€**GR11**æ‹‰å–æ•°æ®ã€‚

- 2.1 **pullï¼ˆfrom mate1_innodeï¼‰**ï¼šGR0 ä»å…¶ GR5 æ‹‰å–æ•°æ®ï¼ŒGR1 ä» GR4 æ‹‰å–æ•°æ®ï¼ŒGR2 ä» GR7ï¼ŒGR3 ä» GR6 æ‹‰å–æ•°æ®ã€‚_ï¼ˆä¸ºç®€åŒ– layout è®¡ç®—ï¼Œç¬¬ä¸€ç‰ˆé‡‡ç”¨ 56 MB å…¨é‡æ•°æ®æ‹‰å–ï¼‰_

- 2.2 **pullï¼ˆfrom mate2_internodeï¼‰**ï¼šGR0 ä»å…¶**GR8**æ‹‰å–æ•°æ®ï¼ŒGR1 ä»**GR9**æ‹‰å–æ•°æ®ï¼ŒGR2 ä»**GR10**ï¼ŒGR3 ä»**GR11**æ‹‰å–æ•°æ®ã€‚_ï¼ˆ56 MB å…¨é‡æ•°æ®æ‹‰å–ï¼‰_

- _ç¬¬ä¸‰æ­¥ï¼Œç­‰å¾…ç¬¬äºŒæ­¥å®Œæˆï¼ŒGR0 å°†ä» GR0ã€GR1ã€GR2ã€GR3 çš„ stagingbuffer æ‹‰å–æ•°æ®ï¼Œç”±äºä»æœºå†… BLink å’Œ RDMA æ‹‰å–æ•°æ®çš„é€Ÿåº¦å¹¶ä¸ä¸€æ ·ï¼Œä¸¤æ¬¡ permute åœ¨å¼€å§‹æ—¶é—´ä¸Šæœ‰æ‰€å·®å¼‚ï¼š_

- _3.1 **permute**ï¼šGR0ã€GR1ã€GR2ã€GR3 ä» GR4ã€GR5ã€GR6ã€GR7 é€Ÿåº¦æ›´å¿«ï¼ˆ50 GB/sï¼‰ï¼Œæ•°æ®è¾¾åˆ°åï¼ŒGR0ã€GR1ã€GR2ã€GR3 é¦–å…ˆåšä¸€æ¬¡ permuteã€‚_

- _3.2 **permute**ï¼šGR0ã€GR1ã€GR2ã€GR3 ä» GR8ã€GR9ã€GR10ã€GR11 é€Ÿåº¦æ›´æ…¢ï¼ˆ13 GB/sï¼‰ï¼Œæ•°æ®è¾¾åˆ°åï¼ŒGR0ã€GR1ã€GR2ã€GR3 å†åšä¸€æ¬¡ permuteã€‚_

- _ç¬¬å››æ­¥ï¼Œ**pull**ï¼šä¸ç¬¬ 3.2 æ­¥åŒæ­¥è¿›è¡Œï¼ŒGR0ã€GR1ã€GR2ã€GR3 åˆ†åˆ«ä» GR4ã€GR5ã€GR6ã€GR7 çš„ stagingbuffer ä¸­æ‹‰å–æ¥è‡ª GR12ã€GR13ã€GR14ã€GR15 çš„æ•°æ®ã€‚ï¼ˆä¸ºç®€åŒ– layout è®¡ç®—ï¼Œç¬¬ä¸€ç‰ˆé‡‡ç”¨ 56 MB å…¨é‡æ•°æ®æ‹‰å–ï¼‰_

- ç¬¬äº”æ­¥ï¼Œ**permute**ï¼šç­‰å¾…ç¬¬å››æ­¥å®Œæˆï¼ŒGR0 å°†ä» GR0ã€GR1ã€GR2ã€GR3 çš„ stagingbuffer æ‹‰å–æ•°æ®å¹¶åš permuteã€‚

- ç¬¬å…­æ­¥ï¼Œreorderã€‚

dispatch_layout ç¤ºæ„å›¾ï¼š

dispatch_layout è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š

é¦–å…ˆé‡‡ç”¨ allgather æ‰€æœ‰çš„ indices ä¿¡æ¯ï¼Œåç»­æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼Œ

- allgather è¾“å…¥ï¼šindices [4096, 8]

- allgather è¾“å‡ºï¼šindices_list = 16 * indices [4096, 8]

- å¯¹ allgather çš„ç»“æœ indices_list è°ƒç”¨å‡½æ•° get_layout() ä»¥è®¡ç®—æœ€ç»ˆçš„ layout ä¿¡æ¯ï¼š

- permutation layout è®¡ç®—ï¼šè®¡ç®—é€»è¾‘ä¸ºä¾æ¬¡éå†æ”¶åˆ°çš„æ¯ä¸ªå¤§å°ä¸º [4096, 8] indicesï¼Œå¹¶å°†å±äºå½“å‰ GPU Rank ä¸Šçš„ expert çš„ token æ•°é‡è¿›è¡Œç´¯åŠ ï¼ŒåŒæ—¶è®¡ç®—å‡ºå…¶å¯¹åº”çš„ srcã€dest åœ°å€ã€‚

- pull layout è®¡ç®—ï¼šç”±äºé‡‡ç”¨äº†å…¨é‡æ•°æ® pullï¼Œæ¯æ¬¡ç›´æ¥æŠŠéœ€è¦ pull çš„æ•°æ®å…¨é‡ pull åˆ°å¯¹åº”çš„ stagingbuffer å³å¯ã€‚

æŠ˜å æºç 

| | |

|---|---|

|1<br><br>2<br><br>3<br><br>4<br><br>5<br><br>6<br><br>7<br><br>8<br><br>9<br><br>10<br><br>11<br><br>12<br><br>13<br><br>14<br><br>15<br><br>16<br><br>17<br><br>18<br><br>19<br><br>20<br><br>21<br><br>22<br><br>23<br><br>24<br><br>25<br><br>26<br><br>27<br><br>28<br><br>29<br><br>30<br><br>31<br><br>32<br><br>33|`from` `collections` `import` `namedtuple`<br><br>`# ç»“æ„ä½“å®šä¹‰`<br><br>`permuteinfo` `=` `namedtuple(``'token_num'``,` `'base_addr'``)`<br><br>`permutelayout` `=` `namedtuple(``'src'``,` `'dest'``,` `'prob'``)`<br><br>`# base_addrä¸­å››ä¸ªåœ°å€åˆ†åˆ«å­˜å‚¨æœ¬å¡ã€inner_mateã€inter_mateã€strangerç¼“å­˜åœ¨æœ¬æœºä¸Šstagingbufferçš„èµ·å§‹åœ°å€`<br><br>`base_addr` `=` `[localcard_addr, stagingbuffer1_addr, stagingbuffer2_addr, stagingbuffer3_addr]`<br><br>`# 16ä¸ªexpert bufferçš„èµ·å§‹åœ°å€`<br><br>`expertbuffer_base_addr` `=` `[addr1, addr2, addr3, addr4, addr5, ..., addr16]`<br><br>`def` `get_layout(indices_list, gpu_rank, layout_permute1, layout_permute2, layout_permute3, layout_permute4):`<br><br> `start_exp, end_exp` `=` `16` `*` `gpu_rank,` `16` `*` `(gpu_rank` `+` `1``)`<br><br> `def` `compute_layout(indices, base_addr, layout):`<br><br> `token_idx_in_expert` `=` `[``0``]` `*` `16`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `for` `exp` `in` `indices[i]:`<br><br> `if` `exp >``=` `start_exp` `and` `exp < end_exp:`<br><br> `src` `=` `base_addr` `+` `i` `*` `7168`<br><br> `dest` `=` `expertbuffer_base_addr[exp` `%` `16``]` `+` `token_idx_in_expert[exp]` `*` `7168`<br><br> `layout.push(permutelayout(src, dest, prob))`<br><br> `token_idx_in_expert[exp]` `+``=` `1`<br><br> `return` `permuteinfo(``sum``(token_idx_in_expert), base_addr), layout`<br><br> `# è®¡ç®—gpu_rankæ‰€åœ¨çš„VNodeä¸Šçš„å››ä¸ªgpu_rank`<br><br> `peer_list` `=` `[(gpu_rank` `%` `4``)` `+` `i` `for` `i` `in` `range``(``4``)]`<br><br> `compute_layout(indices_list[peer_list[``0``]], localcard_addr, layout_permute1)`<br><br> `compute_layout(indices_list[peer_list[``1``]], stagingbuffer1_addr, layout_permute2)`<br><br> `compute_layout(indices_list[peer_list[``2``]], stagingbuffer2_addr, layout_permute3)`<br><br> `compute_layout(indices_list[peer_list[``3``]], stagingbuffer3_addr, layout_permute4)`|

## 2ã€with Port-10

> ä¼ è¾“æ•°æ®é‡å˜ä¸º 1 - (3/4)^8 - (3/4)^8 = 0.8

dispatch æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼š

- ç¬¬ä¸€æ­¥ï¼Œpermuteï¼šä»æœ¬å¡å’Œ peers ä¸Š pull æ•°æ®è¿›è¡Œ permuteã€‚å¦‚**GR0**ä» GR1ã€GR2ã€GR3 æ‹‰å–æ•°æ®åš permuteã€‚

- ç¬¬äºŒæ­¥ï¼Œpull + pull + pullï¼šä¸ç¬¬ä¸€æ­¥åŒæ­¥è¿›è¡Œï¼Œæœ¬å¡ä»è‡ªå·±çš„ mates æ‹‰å–æ•°æ®æ”¾åˆ° stagingbufferã€‚å¦‚ GR0 ä»å…¶ GR5ã€GR12ã€**GR8**æ‹‰å–æ•°æ®ï¼ŒGR1 ä» GR4ã€GR13ã€**GR9**æ‹‰å–æ•°æ®ï¼ŒGR2 ä» GR7ã€GR14ã€**GR10**ï¼ŒGR3 ä» GR6ã€GR15ã€**GR11**æ‹‰å–æ•°æ®ã€‚

- _ç¬¬ä¸‰æ­¥ï¼Œç­‰å¾…ç¬¬äºŒæ­¥å®Œæˆï¼ŒGR0 å°†ä» GR0ã€GR1ã€GR2ã€GR3 çš„ stagingbuffer æ‹‰å–æ•°æ®ã€‚ç”±äºä»æœºå†… BLinkã€Port-10ã€RDMA æ‹‰å–æ•°æ®çš„é€Ÿåº¦å¹¶ä¸ä¸€æ ·ï¼Œä¸¤æ¬¡ permute æ—¶é—´ä¸Šæœ‰æ‰€å·®å¼‚_

- _3.1 **permute**ï¼šGR0ã€GR1ã€GR2ã€GR3 ä» GR4ã€GR5ã€GR6ã€GR7 é€Ÿåº¦æ›´å¿«ï¼ˆ50 GB/sï¼‰ï¼Œæ•°æ®è¾¾åˆ°åï¼ŒGR0ã€GR1ã€GR2ã€GR3 é¦–å…ˆåšä¸€æ¬¡ permuteã€‚_

- 3.2 **permute**ï¼š_GR0ã€GR1ã€GR2ã€GR3 ä» GR12ã€GR13ã€GR14ã€GR15 é€Ÿåº¦æ›´å¿«ï¼ˆ25 GB/sï¼‰ï¼Œæ•°æ®è¾¾åˆ°åï¼ŒGR0ã€GR1ã€GR2ã€GR3 é¦–å…ˆåšä¸€æ¬¡ permuteã€‚_

- _3.3 **permute**ï¼šGR0ã€GR1ã€GR2ã€GR3 ä» GR8ã€GR9ã€GR10ã€GR11 é€Ÿåº¦æ›´æ…¢ï¼ˆ13 GB/sï¼‰ï¼Œæ•°æ®è¾¾åˆ°åï¼ŒGR0ã€GR1ã€GR2ã€GR3 å†åšä¸€æ¬¡ permuteã€‚_

- ç¬¬å››æ­¥ï¼Œ_reorder_ã€‚

dispatch_layout è®¡ç®—æ­¥éª¤å¦‚ä¸‹ï¼š

é¦–å…ˆé‡‡ç”¨ allgather æ‰€æœ‰çš„ indices ä¿¡æ¯ï¼Œåç»­æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼Œ

- allgather è¾“å…¥ï¼šindices [4096, 8]

- allgather è¾“å‡ºï¼šindices_list = 16 * indices [4096, 8]

- å¯¹ allgather çš„ç»“æœ indices_list è°ƒç”¨å‡½æ•° get_layout() ä»¥è®¡ç®—æœ€ç»ˆçš„ layout ä¿¡æ¯

- pull layout è®¡ç®—ï¼šä»¥ GR0ã€GR1ã€GR2ã€GR3 æ‰€åœ¨çš„ VNode ä¸ºä¾‹ï¼Œæ¯ä¸ª GR(with mate1, mate2, mate3) éƒ½éœ€è¦ä¸ºå…¶ä»–ä¸‰ä¸ª GRs æ‹‰å–å¹¶ç¼“å­˜æ¥è‡ª (mate1ã€mate2ã€mate3) çš„ token ä¿¡æ¯ã€‚

- stagingbuffer è®¾è®¡ï¼šç”±äº VNode ä¸­çš„æ¯ä¸ª GR gr éƒ½éœ€è¦ä¸ºå…¶ä¸‰ä¸ª peers ç¼“å­˜ gr çš„ä¸‰ä¸ª mate çš„æ•°æ®ï¼Œé‚£ä¹ˆéœ€è¦æ€»å…± 9 ä¸ª stagingbufferã€‚

- token åœ¨ stagingbuffer ä¸­çš„ layout è®¾è®¡ï¼šstagingbuffer ä¸­ layout ä¸æœ€ç»ˆ permute è®¿é—®å…¶çš„ layout ä¸€è‡´ã€‚

- permutation layout è®¡ç®—ï¼šåŒæ ·ä»¥ GR0ã€GR1ã€GR2ã€GR3 æ‰€åœ¨çš„ VNode ä¸ºä¾‹ï¼Œé™¤ç¬¬ä¸€æ¬¡ permute éœ€è¦çš„æ•°æ®åœ¨æœ¬ VNode å¤–ï¼Œå‰©ä¸‹ä¸‰æ¬¡ permute éœ€è¦çš„æ•°æ®éƒ½æ˜¯é€šè¿‡ pull ä»å…¶ä»–ä¸‰ä¸ª VNode æ‹‰å–å¹¶ç¼“å­˜åœ¨å¯¹åº”çš„ stagingbuffer ä¸­ã€‚

æŠ˜å æºç 

| |

|---|

|`from` `collections` `import` `namedtuple`<br><br>`# ç»“æ„ä½“å®šä¹‰`<br><br>`permuteinfo` `=` `namedtuple(``'token_num'``,` `'base_addr'``)`<br><br>`permutelayout` `=` `namedtuple(``'src'``,` `'dest'``,` `'prob'``)`<br><br>`# base_addrä¸­å››ä¸ªåœ°å€åˆ†åˆ«å­˜å‚¨æœ¬å¡ã€inner_mateã€inter_mate1ã€inter_mate2çš„èµ·å§‹åœ°å€`<br><br>`# éœ€è¦é€šè¿‡é€šä¿¡å¾—åˆ°ï¼Œå½“ä¸‹GRçš„ä¸‰ä¸ªpeerï¼Œä¸‰ä¸ªmateå­˜å‚¨4096ä¸ªtokençš„èµ·å§‹åœ°å€`<br><br>`base_addr` `=` `[localcard_addr, peer1_addr, peer2_addr, peer3_addr, inner_mate1_addr, inter_mate2_addr, inter_mate3_addr]`<br><br>`ç¼“å­˜åœ¨æœ¬æœºä¸Šstagingbufferçš„èµ·å§‹åœ°å€`<br><br>`stagingbuffer_addr` `=` `[stagingbuffer_formate1_addr, stagingbuffer_formate2_addr, stagingbuffer_formate3_addr, ]`<br><br>`# 16ä¸ªexpert bufferçš„èµ·å§‹åœ°å€`<br><br>`expertbuffer_base_addr` `=` `[addr1, addr2, addr3, addr4, addr5, ..., addr16]`<br><br>`# forward token layout è®¡ç®—`<br><br>`# ä¸ºé¿å…å¤šä¼ æ•°æ®ï¼Œåœ¨æ¯ä¸ªVNodeä¸­ï¼Œå½“å‰GPU Rank géœ€è¦ä¸ºå®ƒçš„ä¸‰ä¸ªpeers(p1, p2, p3)å­˜å‚¨gçš„mate(m1, m2) forward åˆ°gä¸Šçš„tokenä¿¡æ¯`<br><br>`# è¿™æ ·éœ€è¦æ“ä½œ9ä¸ªstagingbufferåŠå…¶èµ·å§‹åœ°å€`<br><br>`# layout_pull1ï¼šä»¥GR0ä¸ºä¾‹ï¼Œåˆ†åˆ«ç”¨æ¥å­˜å‚¨ä¸ºpeer1, peer2, peer3éœ€è¦ä»GR4æ‹‰å–çš„tokenä¿¡æ¯`<br><br>`# layout_pull2ï¼šä»¥GR0ä¸ºä¾‹ï¼Œåˆ†åˆ«ç”¨æ¥å­˜å‚¨ä¸ºpeer1, peer2, peer3éœ€è¦ä»GR8æ‹‰å–çš„tokenä¿¡æ¯`<br><br>`# layout_pull3ï¼šä»¥GR0ä¸ºä¾‹ï¼Œåˆ†åˆ«ç”¨æ¥å­˜å‚¨ä¸ºpeer1, peer2, peer3éœ€è¦ä»GR12æ‹‰å–çš„tokenä¿¡æ¯`<br><br>`def` `get_pull_layout(indices_list, gpu_rank, layout_pull1, layout_pull2, layout_pull3):`<br><br> `peer_list` `=` `[(gpu_rank` `%` `4``)` `+` `i` `for` `i` `in` `range``(``4``)` `if` `(gpu_rank` `%` `4``)` `+` `i !``=` `gpu_rank]`<br><br> `peer1_start_exp, peer1_end_exp` `=` `peer_list[``0``]` `*` `16``, (peer_list[``0``]` `+` `1``)` `*` `16`<br><br> `peer2_start_exp, peer2_end_exp` `=` `peer_list[``1``]` `*` `16``, (peer_list[``1``]` `+` `1``)` `*` `16`<br><br> `peer3_start_exp, peer3_end_exp` `=` `peer_list[``2``]` `*` `16``, (peer_list[``2``]` `+` `1``)` `*` `16`<br><br> `# è®¡ç®—ä¼ å…¥çš„mate_indicesä¸­ï¼Œéœ€è¦forwardåˆ°å½“å‰GRçš„peer åœ¨åšpermuteçš„tokenä¿¡æ¯`<br><br> `def` `compute_layout(mate_indices, src_base_addr, dest_stagingbuffer_addr, layout):`<br><br> `token_count` `=` `0`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `for` `exp` `in` `mate_indices[i]:`<br><br> `if` `exp < peer1_start_exp` `or` `exp >``=` `peer3_end_exp:`<br><br> `continue`<br><br> `token_count` `+``=` `1`<br><br> `src` `=` `src_base_addr` `+` `i` `*` `7168`<br><br> `# ç”±äºè¿™é‡Œçš„æ•°æ®éœ€è¦å…ˆforwardä¸€æ¬¡ï¼Œæ‰€ä»¥destä¸ºå½“å‰GRçš„stagingbuffer`<br><br> `dest` `=` `dest_stagingbuffer_addr` `+` `token_count` `*` `7168`<br><br> `layout.push(permutelayout(src, dest, prob))` <br><br> `# è°ƒç”¨compute_layout()åˆ†åˆ«å¤„ç†å½“å‰GRçš„ä¸‰ä¸ªmateä¼ è¿‡æ¥çš„indices mate_rank1, mate_rank2, mate_rank3 = calc_mate_ranks() # è¿™é‡Œéœ€è¦è®¡ç®—å½“å‰GRçš„ä¸‰ä¸ªmateçš„rank`<br><br> `compute_layout(indices_list[mate_rank1], base_addr[``4``], stagingbuffer_addr[``1``], layout_pull1)`<br><br> `compute_layout(indices_list[mate_rank2], base_addr[``5``], stagingbuffer_addr[``2``], layout_pull2)`<br><br> `compute_layout(indices_list[mate_rank3], base_addr[``6``], stagingbuffer_addr[``3``], layout_pull3)`<br><br>`# permute layout è®¡ç®—, éœ€è¦è®¡ç®—å‡º4æ¬¡permuteçš„layoutä¿¡æ¯ï¼šå…¶ä¸­layout_permute1/2/3/4ä¸ºç¬¬ä¸€æ¬¡éœ€è¦è®¿é—®åœ°å€, layout_permute5/6/7ä¸ºæ¥ä¸‹æ¥ä¸‰æ¬¡çš„`<br><br>`# layout_permute1: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦local_cardä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute2: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦peer1ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute3: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦peer2ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute4: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦peer3ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute5: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦mate1(GR5)ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute6: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦mate2(GR8)ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`# layout_permute7: ä»¥GR0ä¸ºä¾‹ï¼Œéœ€è¦mate3(GR12)ä¸Šå±äºexpert0-expert16çš„tokenä¿¡æ¯ã€‚`<br><br>`def` `get_permute_layout(indices_list, gpu_rank, layout_permute1, layout_permute2, layout_permute3, layout_permute4ï¼Œ`<br><br> `layout_permute5, layout_permute6, layout_permute7):`<br><br> `start_exp, end_exp` `=` `16` `*` `gpu_rank,` `16` `*` `(gpu_rank` `+` `1``)`<br><br> `def` `compute_layout(indices, base_addr, layout):`<br><br> `token_idx_in_expert` `=` `[``0``]` `*` `16`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `for` `exp` `in` `indices[i]:`<br><br> `if` `exp >``=` `start_exp` `and` `exp < end_exp:`<br><br> `src` `=` `base_addr` `+` `i` `*` `7168`<br><br> `dest` `=` `expertbuffer_base_addr[exp` `%` `16``]` `+` `token_idx_in_expert[exp]` `*` `7168`<br><br> `layout.push(permutelayout(src, dest, prob))`<br><br> `token_idx_in_expert[exp]` `+``=` `1`<br><br> `return` `permuteinfo(``sum``(token_idx_in_expert), base_addr), layout`<br><br> `# è®¡ç®—gpu_rankæ‰€åœ¨çš„VNodeä¸Šçš„å››ä¸ªgpu_rank`<br><br> `peer_list` `=` `[(gpu_rank` `%` `4``)` `+` `i` `for` `i` `in` `range``(``4``)]`<br><br> `compute_layout(indices_list[peer_list[``0``]], localcard_addr, layout_permute1)`<br><br> `compute_layout(indices_list[peer_list[``1``]], stagingbuffer1_addr, layout_permute2)`<br><br> `compute_layout(indices_list[peer_list[``2``]], stagingbuffer2_addr, layout_permute3)`<br><br> `compute_layout(indices_list[peer_list[``3``]], stagingbuffer3_addr, layout_permute4)`<br><br> `# è®¡ç®—å½“ä¸‹GPU Rankå¯¹åº”çš„ä¸‰ä¸ªmateçš„gpu_rank`<br><br> `mate_list` `=` `[...]`<br><br> `compute_layout(indices_list[ mate_list[``0``]], localcard_addr, layout_permute5)`<br><br> `compute_layout(indices_list[ mate_list[``1``]], localcard_addr, layout_permute6)`<br><br> `compute_layout(indices_list[ mate_list[``2``]], localcard_addr, layout_permute7)`<br><br>`# æœ€ç»ˆéœ€è¦çš„layout, éœ€è¦åŒæ—¶å°†pull_layoutå†è¿›è¡Œé€šä¿¡ï¼Œå°†pull_layoutå’Œpermute_layoutè¿›è¡Œåˆå¹¶`|

# ä¸‰ã€combine Layout ç»“æ„ä½“è¯´æ˜å’Œè®¡ç®—

## 1ã€without Port-10

Combine çš„æ“ä½œæ­¥éª¤ï¼š

ç¬¬ä¸€æ­¥ï¼šå…ˆåœ¨å•å¡å†…ï¼Œå°†æ¥è‡ªä¸åŒ expert_buffer ä¸­åŒä¸€ä¸ª token è¿›è¡Œ reduce æ“ä½œï¼Œç»“æœæ”¾åˆ°äºŒç»´æ•°ç»„ local_card_reduce_buffer[16][n]ã€‚ï¼ˆlocal_card_reduce_buffer ç¬¬ä¸€ç»´ä¸º 16ï¼Œç”¨äºå­˜æ”¾æ¥è‡ªä¸åŒçš„ gpu rank ä¸Šçš„ token åœ¨æœ¬å¡çš„ reduce ç»“æœï¼‰

ä¸¾ä¾‹ï¼šä»¥ GR1 ä¸ºä¾‹ï¼Œä¾æ¬¡è¯»å– 16 ä¸ª expert_buffer ä¸­çš„ token è¿›è¡Œ reduceï¼Œå¹¶è¾“å‡ºåˆ° local_card_reduce_buffer[16] ä¸­ã€‚è¯»å–è§„åˆ™ä¸ºï¼šåˆ¤æ–­è®°å½• token åœ¨ 16 ä¸ª expert ä¸Šåˆ†å‘çš„ 16 ä¸ªäºŒè¿›åˆ¶ä¹¦ä¸­çš„å¯¹åº”ä½ï¼Œå¦‚æœæŸä¸ªä½ä¸º 1ï¼Œåˆ™ä»å¯¹åº” expert buffer ä¸Šè¯»å–ä¸€ä¸ª tokenï¼Œå°†ä»å¤šä¸ª expert ä¸Šè¯»å–çš„ token è¿›è¡Œ reduceï¼Œå¹¶è¾“å‡ºåˆ° local_card_reduce_bffer[][] ä¸­ã€‚

ç¬¬äºŒæ­¥ï¼šå¦‚ä¸‹ç¤ºæ„å›¾æ‰€ç¤ºï¼Œä»»ä½•ä¸€ä¸ª VNode ä¸­çš„å¡ä¸Šçš„ tokenï¼Œéœ€è¦é€šè¿‡ 4 æ¬¡å¡é—´ combineï¼Œä¸‹é¢ä»¥ GR12 ä¸ºä¾‹ï¼Œ

- 2.1 peer ä¹‹é—´è¿›è¡Œ reduceï¼Œå¹¶å°†å½“å‰ gpu rank åŠå…¶ mateã€stranger ä¸Š token çš„ reduce ç»“æœå†™å…¥åˆ° local_vnode_reduce_buffer[4][n]ã€‚ï¼ˆlocal_vnode_reduce_buffer ç¬¬ä¸€ç»´ä¸º 4ï¼Œlocal_vnode_reduce_buffer[0, 1, 2, 3] åˆ†åˆ«ç”¨äºå­˜æ”¾å½“ä¸‹ gpu rankã€mate_innodeã€mate_internodeã€stranger ä¸Šçš„ token çš„ reduce ç»“æœï¼‰

ä¸¾ä¾‹ï¼šä»¥ GR1 ä¸ºä¾‹ï¼ŒGR1 ä¼šä»å®ƒçš„ Peerï¼ˆGR0ã€GR1ã€GR2ã€GR3ï¼‰çš„ local_card_reduce_buffer[1]ã€local_card_reduce_buffer[4]ã€local_card_reduce_buffer[9]ã€local_card_reduce_buffer[12] ä¸Šä¾æ¬¡è¿›è¡Œè¯»å–ã€‚è¯»å–çš„è§„åˆ™ä¸ºï¼šåˆ¤æ–­åŒ…å«å››ä¸ªäºŒè¿›åˆ¶ä½ 0000-1111 çš„æ•°ä¸­ï¼ŒæŸä¸ªå¯¹åº”ä½ä¸ºæ˜¯å¦ä¸º 1ï¼Œä¸º 1 åˆ™ä»å¯¹åº” peer ä¸Šæ‹‰å–ä¸€ä¸ª tokenï¼Œå¦åˆ™è·³è¿‡æ­¤ peerã€‚é‚£ä¹ˆï¼Œéœ€è¦è®¡ç®— layout æ—¶ï¼Œåªéœ€æ„é€ å‡ºæ‰€æœ‰ token çš„è¿™ä¸ªäºŒè¿›åˆ¶æ•°å³å¯ã€‚

- 2.2 Node å†…çš„ mate ä¹‹é—´è¿›è¡Œ reduceï¼Œå¹¶å°† local_cardã€stranger ä¸Š token çš„ reduce ç»“æœç¼“å­˜åœ¨è·¨ç‰©ç†èŠ‚ç‚¹çš„åŒå·å¡ä¸Šã€‚

ä¸¾ä¾‹ï¼šå¦‚ GR4ã€GR12 ä¸Š token åœ¨ VNode1 ä¸Šçš„ reduce ç»“æœä¸ GR4 è¿›è¡Œ reduce åï¼Œç¼“å­˜åœ¨ GR4ã€‚GR4 ä¼šä» GR4 çš„ local_vnode_reduce_buffer[0] å’Œ GR1(mate_innode) çš„ local_vnode_reduce_buffer[1] ä¾æ¬¡æ‹‰å–æ•°æ®è¿›è¡Œ reduceã€‚æ‹‰å–è§„åˆ™ä¸ºï¼šåˆ¤æ–­åŒ…å«ä¸¤ä¸ªäºŒè¿›åˆ¶ä½ 00-11 çš„æ•°ä¸­ï¼ŒæŸä¸ªå¯¹åº”ä½æ˜¯å¦ä¸º 1ï¼Œä¸º 1 åˆ™ä»å¯¹åº”å¡æ‹‰å–ä¸€ä¸ª tokenï¼Œå¦åˆ™è·³è¿‡æ­¤ peerã€‚é‚£ä¹ˆï¼Œéœ€è¦è®¡ç®— layout æ—¶ï¼Œåªéœ€æ„é€ å‡ºæ‰€æœ‰ token çš„è¿™ä¸ªäºŒè¿›åˆ¶æ•°å³å¯ã€‚

- 2.3 Node é—´çš„ mate ä¹‹é—´è¿›è¡Œ reduceã€‚

ä¸¾ä¾‹ï¼šå¦‚ GR12 ä¸Šçš„ token åœ¨ GR4 å’Œ GR12 ä¹‹é—´è¿›è¡Œ reduceï¼Œå¹¶å­˜åˆ° GR12ã€‚

ç¬¬ä¸‰æ­¥ï¼šreorder

layout çš„è®¡ç®—è¿‡ç¨‹ Python ä»£ç ï¼š

é¦–å…ˆé‡‡ç”¨ allgather æ‰€æœ‰çš„ indices ä¿¡æ¯ï¼Œåç»­æ“ä½œæ­¥éª¤å¦‚ä¸‹ï¼Œ

- allgather è¾“å…¥ï¼šindices [4096, 8]

- allgather è¾“å‡ºï¼šindices_list = 16 * indices [4096, 8]

- å¯¹ allgather çš„ç»“æœ indices_list è°ƒç”¨å‡½æ•° get_layout() ä»¥è®¡ç®—æœ€ç»ˆçš„ layout ä¿¡æ¯

1ã€è®¡ç®—å¡å†… reduce layout

- éå† indices_list ä¸­çš„æ¯ä¸ª indicesï¼Œæ ¹æ®æ¯ä¸ª token ä¸­è®°å½•çš„ expert ä¿¡æ¯ï¼Œè®¡ç®—å¯¹åº”çš„ layout æ•°å€¼ã€‚å¦‚ indices_list[0] ä¸­ç¬¬ä¸€ä¸ª token çš„ top-8 expert ä¸º [0, 1, 200, 201, 224, 225, 253, 255] åˆ™ GR1 ä¸­å¯è®¡ç®—å‡º local_card_layout[0][1] = 0...0001116ã€‚

- è¾“å‡ºï¼šlocal_card_layout[16][n] çš„ç¬¬ä¸€ç»´ä¸º 16ï¼Œæ¯ä¸€è¡Œ local_card_layout[gpu_rank] ç”¨äºè®°å½•æ¥ gpu_rank çš„ token åœ¨å½“å‰å¡ä¸­ 16 ä¸ª expert ä¸Šçš„åˆ†å¸ƒï¼Œè¿™ä¸ªåˆ†å¸ƒç”¨åŒ…å« 16 ä¸ªäºŒè¿›åˆ¶ä½çš„æ•°è¡¨ç¤ºï¼Œå¦‚ 0...0001 è¡¨ç¤ºè¿™ä¸ª token ä»…è¢« dispatch åˆ°äº†å®ƒçš„ç¬¬ä¸€ä¸ª expert buffer ä¸­ã€‚

2ã€è®¡ç®— VNode å†… reduce layout

- - åˆ†åˆ«éå†å½“å‰ gpu rank åŠå…¶ mate_innernodeã€mate_internodeã€stranger çš„ indicesï¼Œåˆ¤æ–­å…¶ä¸­æ¯ä¸ª token æ˜¯å¦è¢« dispatch åˆ°å½“å‰ VNode çš„ 4 ä¸ªå¡ä¸Šã€‚

- - è¾“å‡º 1ï¼šlocal_vnode_layout[n] è¡¨ç¤ºä¸€ä¸ªä¸€ç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ç”¨æ¥å­˜å‚¨æœ¬å¡ token åœ¨ peer1ã€peer2ã€peer3ã€peer4 ä¸Š token ä¸Šçš„åˆ†å¸ƒï¼Œè¿™ä¸ªåˆ†å¸ƒç”¨åŒ…å« 4 ä¸ªäºŒè¿›åˆ¶ä½çš„æ•°è¡¨ç¤ºï¼Œå¦‚ 0011 è¡¨ç¤ºå½“ä¸‹ token è¢« dispatch åˆ°äº†å½“å‰ gpu rank å’Œå®ƒçš„ç¬¬ä¸€ä¸ª peer ä¸Šã€‚

- è¾“å‡º 2ï¼šlocal_vnode_layout_for_innermate[n]ï¼Œè§£é‡Šå¦‚è¾“å‡º 1ã€‚

- è¾“å‡º 3ï¼šlocal_vnode_layout_for_intermate[n]ï¼Œè§£é‡Šå¦‚è¾“å‡º 1ã€‚

- è¾“å‡º 4ï¼šlocal_vnode_layout_for_stranger[n]ï¼Œè§£é‡Šå¦‚è¾“å‡º 1ã€‚

3ã€æœºå†… mate_innode é—´çš„ reduce layout

- - éå†å½“å‰ gpu rank çš„ mate_intermte çš„ indicesï¼Œè®¡ç®—å…¶åœ¨å½“å‰ Node ä¸­çš„ä¸¤ä¸ª VNode ä¸Šçš„åˆ†å¸ƒã€‚

- è¾“å‡º 1ï¼šinner_node_layout[4096] ä¸ºé•¿åº¦æ˜¯ 4096 çš„ä¸€ç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ç”¨æ¥å­˜å‚¨å½“å‰ gpu rank ä¸Š token åœ¨åœ¨å½“å‰ VNode å’Œé‚»æ¥æœºå†… VNode ä¸Šåˆ†å¸ƒï¼Œè¿™ä¸ªåˆ†å¸ƒç”¨åŒ…å« 2 ä¸ªäºŒè¿›åˆ¶ä½çš„æ•°è¡¨ç¤ºï¼Œå¦‚ 11 è¡¨ç¤ºå½“ä¸‹ token è¢« dispatch åˆ°äº†å½“å‰ VNode å’Œå®ƒçš„é‚»æ¥æœºå†… VNode ä¸Šäº†ã€‚

- è¾“å‡º 2ï¼šinner_node_layout[4096] ä¸ºé•¿åº¦æ˜¯ 4096 çš„ä¸€ç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ç”¨æ¥å­˜å‚¨å½“å‰ gpu rank çš„ mate_internode ä¸Š token åœ¨åœ¨å½“å‰ VNode å’Œé‚»æ¥æœºå†… VNode ä¸Šåˆ†å¸ƒï¼Œè¿™ä¸ªåˆ†å¸ƒç”¨åŒ…å« 2 ä¸ªäºŒè¿›åˆ¶ä½çš„æ•°è¡¨ç¤ºï¼Œå¦‚ 11 è¡¨ç¤ºå½“ä¸‹ token è¢« dispatch åˆ°äº†å½“å‰ VNode å’Œå®ƒçš„é‚»æ¥æœºå†… VNode ä¸Šäº†ã€‚

4ã€æœºé—´ mate_internode é—´çš„ reduce layout

- - éå†å½“å‰ gpu rank å’Œ mate_internode çš„ indices[gpu_rank]ã€indices[mate_internodeâ€˜ gpu rank]ï¼Œåˆ¤æ–­å…¶ä¸­æ¯ä¸ª token æ˜¯å¦è¢« dispatch åˆ°å½“å‰ Node çš„ 8 ä¸ªå¡å’Œé‚»æ¥ Node çš„ 8 ä¸ªå¡ä¸Šï¼›

- è¾“å‡º 1ï¼šinner_node_layout[4096] ä¸ºé•¿åº¦æ˜¯ 4096 çš„ä¸€ç»´æ•°ç»„ï¼Œå…¶ä¸­æ¯ä¸ªå…ƒç´ ç”¨æ¥å­˜å‚¨æœ¬å¡ä¸Š token åœ¨åœ¨å½“å‰ Node å’Œé‚»æ¥ Node ä¸Šåˆ†å¸ƒï¼Œè¿™ä¸ªåˆ†å¸ƒç”¨åŒ…å« 2 ä¸ªäºŒè¿›åˆ¶ä½çš„æ•°è¡¨ç¤ºï¼Œå¦‚ 11 è¡¨ç¤ºå½“ä¸‹ token è¢« dispatch åˆ°äº†å½“å‰ node å’Œå®ƒçš„é‚»æ¥ Node ä¸Šäº†ã€‚

æŠ˜å æºç 

| |

|---|

|`from` `collections` `import` `namedtuple`<br><br>`# ç»“æ„ä½“å®šä¹‰`<br><br>`permuteinfo` `=` `namedtuple(``'token_num'``,` `'base_addr'``)`<br><br>`permutelayout` `=` `namedtuple(``'src'``,` `'dest'``,` `'prob'``)`<br><br>`# æœ¬å¡å†…åšreduceï¼Œå¹¶å°†ç»“æœç¼“å­˜åœ¨local_card_reduce_bufferä¸­ï¼Œå¤§å°ä¸º16ï¼Œå°†æ¥è‡ªä¸åŒgpu rankçš„tokenç»è¿‡reduceåçš„ç»“æœæ”¾åœ¨ä¸åŒçš„ç¼“å­˜ä¸­`<br><br>`local_card_expert_buffer` `=` `[expert1_buffer_addr, ..., expert15_buffer_addr]` `# å¡å†…åšreduceï¼Œsrcçš„é¦–åœ°å€`<br><br>`local_card_reduce_buffer` `=` `[gr1_buffer_addr, ..., gr15_buffer_addr]` `# grä¸ºgpu rankç¼©å†™ã€‚å¡å†…åšreduceçš„desté¦–åœ°å€`<br><br>`# æœ¬VNodeå†…åšreduceï¼Œä¼šå°†å½“å‰gpu rankã€innermateã€intermateåŠstrangerçš„tokenè¿›è¡Œreduceï¼Œsrcä¸ºä¸Šä¸€æ­¥çš„destï¼Œdestä¸ºlocal_vnode_reduce_buffer`<br><br>`local_vnode_reduce_buffer` `=` `[local_vnode_addr, local_vnode_innermate_addr, local_vnode_intermate_addr, local_vnode_stranger_addr]`<br><br>`# æœ¬Nodeå†…åšreduceï¼Œä¼šå°†å½“å‰gpu rankå’Œå…¶intermateä¸Šçš„tokenåœ¨å½“å‰gpu rankå’Œå…¶innermateä¸Šè¿›è¡Œreduceï¼Œsrcä¸ºä¸Šä¸€æ­¥çš„destï¼ˆlocal_vnode_intermate_addr + local_vnode_stranger_addrï¼‰ï¼Œdestä¸ºlocal_node_reduce_buffer`<br><br>`local_node_reduce_buffer` `=` `[local_node_card_reduce_buffer, local_node_intermate_addr]`<br><br>`# Nodeé—´åšreduceï¼Œä¼šå°†å½“å‰gpu rankçš„tokenåœ¨å½“å‰gpu rankå’Œå…¶intermateä¸Šè¿›è¡Œreduceï¼Œsrcä¸ºä¸Šä¸€æ­¥çš„destï¼Œdestä¸º inter_node_reduce_buffer`<br><br>`inter_node_reduce_buffer` `=` `[]`<br><br>`# é¦–å…ˆè®¡ç®—å¡å†…reduceçš„layout`<br><br>`# indices_listä¸ºallgatherä¹‹åçš„è¾“å‡ºï¼ŒåŒ…å«æ¯ä¸ªgpu_rankçš„å…¨é‡indices`<br><br>`def` `get_local_card_reduce_layout(indices_list, gpu_rank):`<br><br> `local_card_reduce_layout` `=` `[[]` `for` `i` `in` `range``(``16``)]`<br><br> `for` `gpu_rank, indices` `in` `enumerate``(indices_list):`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `layout_code` `=` `0`<br><br> `for` `exp` `in` `indices[i]:`<br><br> `if` `exp >``=` `start_exp_idx` `and` `exp < end_exp_idx:`<br><br> `layout_code` `+``=` `(``1` `<< exp)`<br><br> `local_card_reduce_layout[gpu_rank].append(layout_code)`<br><br>`# è®¡ç®—æœ¬VNodeå†…åšreduceçš„layout`<br><br>`def` `get_local_vnode_reduce_layout(indices_list, gpu_rank):`<br><br> `peer_list` `=` `[(gpu_rank` `%` `4``)` `+` `i` `for` `i` `in` `range``(``4``)` `if` `(gpu_rank` `%` `4``)` `+` `i !``=` `gpu_rank]`<br><br> `peer1_start_exp, peer1_end_exp` `=` `peer_list[``0``]` `*` `16``, (peer_list[``0``]` `+` `1``)` `*` `16`<br><br> `peer2_start_exp, peer2_end_exp` `=` `peer_list[``1``]` `*` `16``, (peer_list[``1``]` `+` `1``)` `*` `16`<br><br> `peer3_start_exp, peer3_end_exp` `=` `peer_list[``2``]` `*` `16``, (peer_list[``2``]` `+` `1``)` `*` `16`<br><br> `self_start_exp, self_end_exp` `=` `16` `*` `gpu_rank,` `16` `*` `(gpu_rank` `+` `1``)`<br><br> `local_card_reduce_layout` `=` `[[]` `for` `i` `in` `range``(``4``)]`<br><br> `for` `gpu_rank, indices` `in` `enumerate``(indices_list):`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `layout_code` `=` `0`<br><br> `for` `exp` `in` `indices[i]:`<br><br> `if` `exp >``=` `start_exp_idx` `and` `exp < end_exp_idx:`<br><br> `layout_code` `+``=` `(``1` `<< exp)`<br><br> `local_card_reduce_layout[gpu_rank].append(layout_code)`<br><br> `def` `compute_layout(indices, reduce_layout):`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `layout_code` `=` `0`<br><br> `for` `exp` `in` `indices[i]:`<br><br> `if` `exp >``=` `self_start_expand exp < self_end_exp :`<br><br> `layout_code` `+``=` `1`<br><br> `if` `exp >``=` `peer1_start_exp < exp < peer1_end_exp:`<br><br> `layout_code` `+``=` `(``1` `<<` `1``)`<br><br> `if` `exp >``=` `peer2_start_exp < exp < peer2_end_exp:`<br><br> `layout_code` `+``=` `(``1` `<<` `2``)` <br><br> `if` `exp >``=` `peer3_start_exp < exp < peer3_end_exp:`<br><br> `layout_code` `+``=` `(``1` `<<` `3``)` <br><br> `reduce_layout[gpu_rank].append(layout_code)`<br><br> `# è®¡ç®—gpu rankã€innermateã€intermateã€strangerä¸Šçš„tokenåœ¨æœ¬VNodeçš„å››å¼ å¡ä¸Šåˆ†å¸ƒ`<br><br> `compute_layout(indices_list[gpu_rank], local_card_reduce_layout[``0``])`<br><br> `compute_layout(indices_list[gpu_rank], local_card_reduce_layout[``1``])`<br><br> `compute_layout(indices_list[gpu_rank], local_card_reduce_layout[``2``])`<br><br> `compute_layout(indices_list[gpu_rank], local_card_reduce_layout[``3``])`<br><br> `return` `local_card_reduce_layout`<br><br>`# è®¡ç®—Nodeå†…åšreduceçš„layoutï¼šéå†å½“å‰gpu rankçš„mate_intermteçš„indicesï¼Œè®¡ç®—å…¶åœ¨å½“å‰Nodeä¸­çš„ä¸¤ä¸ªVNodeä¸Šçš„åˆ†å¸ƒã€‚`<br><br>`def` `get_local_node_reduce_layout(indices_list, gpu_rank):`<br><br> `intermte_rank` `=` `get_intermate_rank()` `# å‡è®¾get_intermate_rank()å¯ä»¥è·å¾—å…¶intermateçš„gpu rankç¼–å·`<br><br> `current_vnode` `=` `gpu_rank` `%` `4`<br><br> `neighbor_vnode` `=` `current_vnode` `+` `(``1` `if` `current_vnode` `%` `2` `=``=` `0` `else` `-``1``)`<br><br> `current_vnode_start_exp, current_vnode_end_exp` `=` `current_vnode` `*` `64``, (current_vnode` `+` `1``)` `*` `64`<br><br> `neighbor_vnode_start_exp, neigbor_vnode_end_exp` `=` `neighbor_vnode` `*` `64``, ( neighbor_vnode` `+` `1``)` `*` `64`<br><br> `inner_node_layout` `=` `[]`<br><br> `for` `i` `in` `range``(``4096``):`<br><br> `for` `exp` `in` `indices_list[intermate_rank]:`<br><br> `if` `exp >``=` `current_vnode_start_exp` `and` `exp < current_vnode_end_exp:`<br><br> `layout_code` `+``=` `1`<br><br> `if` `exp >``=` `neighbor_vnode_start_exp` `and` `exp < neigbor_vnode_end_exp:`<br><br> `layout_code` `+``=` `(``1` `<<` `1``)`<br><br> `inner_node_layout.append(layout_code)`<br><br> `return` `inner_node_layout`<br><br>`# è®¡ç®—è·¨Nodeåšreduceçš„layout`<br><br>`def` `get_inter_node_reduce_layout():`<br><br> `pass`|

combine layout ç¤ºæ„å›¾ï¼š

## 2ã€with Port-10

æ“ä½œæ­¥éª¤ï¼š

ç¬¬ä¸€æ­¥ï¼šæœ¬å¡ä¸Šçš„ reduceã€‚

ç¬¬äºŒæ­¥ï¼šæœ¬ VNode ä¸Šçš„ reduceã€‚

ç¬¬ä¸‰æ­¥ï¼šè·¨ VNode çš„ reduceã€‚

æ“ä½œ Python ä»£ç ï¼š

åŒ…å«åœ¨ without-10 çš„æ“ä½œä¸­ã€‚

ç¤ºæ„å›¾ï¼š

åŒ…å«åœ¨ without-10 çš„ç¤ºæ„å›¾ä¸­ã€‚

106 é›†ç¾¤è§„æ¨¡åŠè¶…å‚è®¾å®šï¼š16 æœºï¼ŒPP16DP1

|TP4DP2|EP8|16|1|cpu optimizer|True|True|

|kernel size|kernel size|||mem size|||

||(mb*seqlen/experts*topk*DP)*hidden*ffn_hidden<br><br>(1*ACEHOLDER}(1*4096/256*hidden*2)*8*2048<br><br>256*7168*2048||||||

166 é›†ç¾¤è®­ç»ƒè§„æ¨¡åŠè¶…å‚è®¾å®šï¼š

()

|8 æœº| | | | | | |16 æœº| | | | | | |

|---|---|---|---|---|---|---|---|---|---|---|---|---|---|

|non-moe layer|moe layer( Die é—´ EP)|global batchsize|micro batchsize|optimizer|recomputer|offload|non-moe layer|moe layer(Die é—´ DP)<br><br>(8 æœºçš„ Die é—´æ‰©å±•)|global batchsize|micro batchsize|optimizer|recomputer|offload|

|TP4DP2(â†’DP8 4*)|EP8|16|1|cpu optimizer|True|True|TP4DP2(â†’DP8)|EP8|16|2|cpu optimizer|True|True|

|kernel size|kernel size|||mem size|||||||mem size|||

||(4*)256*7168*2048|||||||(4*7168*)(256)*1*2048||||||

||||||||non-moe layer|moe layer(Die é—´ EP)|global batchsize|micro batchsize|optimizer|recomputer|offload|

||||||||DP8|EP16|16|2/4||||

|||||||||kernel size||||||

|||||||||2048/4096*7168*2048||||||

||||||||**non-moe layer**|**moe layer(Die é—´ TP****)**|**global batchsize**|**micro batchsize**|**optimizer**|**recomputer**|**offload**|

||||||||TP4DP2(â†’DP8)|EP16|16|2|cpu optimizer|True|True|

|||||||||kernel size||||||

|||||||||2048*7168*2048||||||

éœ€æ±‚ç®—å­ï¼š

1ã€moe layer(Die é—´ DP)ï¼Œsuccl éœ€è¦æ”¯æŒåŒ Die all2all æ—¶ä¸åŒçš„åˆ‡åˆ†ã€‚

2ã€router æ”¯æŒ 166ã€‚

3ã€MLA ä¸­ mma ç®—å­ã€‚

![]([https://conf01.birentech.com/download/attachments/206286443/image2025-3-4_16-0-40.png?version=1&modificationDate=1741075241000&api=v2](https://conf01.birentech.com/download/attachments/206286443/image2025-3-4_16-0-40.png?version=1&modificationDate=1741075241000&api=v2))

NV é›†ç¾¤è§„æ¨¡ï¼š256 æœºï¼Œ2048 å¡

|TP1|EP64|16|2|3072--->15360|æœªçŸ¥|/|True|/|

|1|top|8||

|2|transformer layer|61||

|3|hidden dimension to|7168||

|4|parameters are randomly initialized with a standard deviation|0.006||

|5|n heads *7168* to|128||

|6|per-head dimension _ğ‘›__â„_ to .|128||

|7|KV compression dimension _ğ‘‘__â„_ is set to|512||

|8|query compression dimension _ğ‘‘__ğ‘_ â€² is set to|1536||

|9|decoupled queries and key, we set the per-head dimension _ğ‘‘__ğ‘_ to|64||

|10|substitute all FFNs except for the first three layers with MoE layers|||

|11|Each MoE layer consists of 1 shared expert and 256 routed experts|||

|12|intermediate hidden dimension of each expert is|2048||

|13|Among the routed experts, 8 experts will be activated for each token|||

|14|each token will be ensured to be sent to at most 4 nodes|||

|15|multi-token prediction depth _ğ‘‘__â„ ğ‘…_ is set to 1|||

|16|37B are activated for each token|||

|17|AdamW optimizer _ğ›½_1 = 0.9, _ğ›½_2 = 0.95|||

|18|maximum sequence length to 4K during pre-training|||

|19|14.8T tokens|||

> æ­¤å‰è®¨è®ºï¼š

>

> one kernel groupGemm å¯¹æ¯” suBLAS for loop API ï¼ˆ16x) ç›®å‰å­˜åœ¨ä¸¤å¤§éš¾ç‚¹ï¼š

>

> 1, shape ä¸å‡è¡¡ï¼Œ cpu costmodel éš¾ä»¥ fit into inside kernel

>

> 2, å¦‚æœå³çŸ©é˜µ size per die è¶³å¤Ÿå¤§ï¼Œå¡æ»¡ 16SPCã€‚ åˆ™ç­‰åŒäº for loop 16x. one kernel åªæ”¶è· 15x kernel launch æ”¶ç›Š. ä½†æŸå¤± costmodel ï¼Œ DTG å¸¦å®½ï¼Œå¤±å»æ„ä¹‰.

>

> [group gemm for BR10x è®¨è®º ï¼ˆDec 2024å¹´)]([https://conf01.birentech.com/pages/viewpage.action?pageId=195921488](https://conf01.birentech.com/pages/viewpage.action?pageId=195921488))

DS MoE ä¸­å‘ç”Ÿçš„æ–°å˜åŒ–

1ï¼‰ size per die å˜å° N=1024.

2ï¼‰ åæœŸ Shape å¯èƒ½å¯ä»¥å‡è¡¡ï¼Œ indicate costmodel å¯ä»¥ç­–ç•¥å›ºåŒ–åˆ° kernel é‡Œã€‚

æ•…æ­¤ æœ‰å¯èƒ½åšå‡ºä¸€ä¸ªå®ç°å›ºå®šå¥½ outPartion/loadOnce/quadbuffer ç­–ç•¥çš„ï¼Œ ä¸é€šç”¨çš„ ä¸äº§å“åŒ– ä¸ fit suBLAS/cuBLAS interface çš„ ä¸€ä¸ª groupGemm for åæœŸã€‚

æ­¤ one kernel groupGemm éœ€åŒäº‹æ»¡è¶³ ä¸Šè¿° 1) & 2) æ¡ä»¶ ï¼šå³ å·¦å³çŸ©é˜µ size å°ï¼Œä¸” å‡è¡¡ã€‚

A seq1024 é¢„æœŸæ”¶ç›Šï¼š

N = 1024

for loop æ–¹æ¡ˆï¼š size1024,æ¯æ¬¡ kernel å¤§çº¦æœ‰ 4 ä¸ª SPC really å·¥ä½œã€‚ç›®æµ‹æµ‹è¯•= 51T. (1024, 1024, 7168)

ä½¿ç”¨ AiB æ¨¡æ‹Ÿ= 236T. ä½† group gemm ä¸­ B ä¸å†å…±äº«æ—  DTG å¸¦å®½ã€‚è€ƒè™‘ DTG è¡°å‡ï¼Œå‡è®¾ä½¿ç”¨ NUMA å¯ä»¥è¾¾åˆ° 200Tã€‚å‡è®¾ B ä½¿ç”¨ UMAã€‚é¢„è®¡ä»æœ‰ 150Tï¼Œgood enough. (16, 1024, 1024, 7168)

N=2048

for loop æ–¹æ¡ˆï¼šæµ‹è¯•çº¦æœ‰ 89TFLOPSï¼Œ16 ä¸ª spc éƒ½å·¥ä½œäº† (1024, 2048, 7168)

çš„é¢„æœŸæ”¶ç›Šï¼Œé€šè¿‡ AiB æ¨¡æ‹Ÿ=265TFLOPSï¼Œç”¨ UMA ä¼°è®¡æœ‰ 165 TFLOPS (16, 1024, 2048, 7168)

A seq2048 é¢„æœŸæ”¶ç›Šï¼š

N=1024

for loop æ–¹æ¡ˆï¼šæµ‹è¯•çº¦æœ‰ 90TFLOPSï¼Œ16 ä¸ª spc éƒ½å·¥ä½œäº† (2048, 1024, 7168)

çš„é¢„æœŸæ”¶ç›Šï¼Œé€šè¿‡ AiB æ¨¡æ‹Ÿ=244TFLOPSï¼Œç”¨ UMA ä¼°è®¡æœ‰ 155 TFLOPS (16, 2048, 1024, 7168)

N=2048

for loop æ–¹æ¡ˆï¼šæµ‹è¯•çº¦æœ‰ 108TFLOPSï¼Œ16 ä¸ª spc éƒ½å·¥ä½œäº† (2048, 2048, 7168)

çš„é¢„æœŸæ”¶ç›Šï¼Œé€šè¿‡ AiB æ¨¡æ‹Ÿ=272TFLOPSï¼Œç”¨ UMA ä¼°è®¡æœ‰ 170 TFLOPS (16, 2048, 2048, 7168)

å¯ä»¥å…ˆç”¨ 3UMA å®ç°

æƒ…æ™¯é™å®šï¼š

deepseek ä¸­ä¸“å®¶çš„ç»´åº¦éƒ½æ¯”è¾ƒå°ï¼Œhidden size åªæœ‰ 2048ï¼Œ per die åˆ™å˜ä¸º 1024ï¼Œ ä¸‹åŒ

MMA å‚æ•°ï¼ŒMNKï¼ˆ1024ï¼Œ2048ï¼Œ7168ï¼‰,æ€»å…± 16 ä¸ªä¸“å®¶ã€‚

(1024, 7168) @ (7168, 2048), ä¸€å…±åš 32 æ¬¡ã€‚(up/gate å„ä¸€æ¬¡ï¼Œæ€»å…± 32 æ¬¡), **fwd, åæœŸå¯ä»¥ä½¿ç”¨ one groupGemm æ–¹æ¡ˆã€‚bpa, bpw å› ä¸ºè¾“å…¥çŸ©é˜µå˜æ¢ é reduce ç»´åº¦è‡³å°‘ä¸€ä¸ªä»ç„¶ä¸å° 7168ï¼Œä»ä½¿ç”¨ for loop æ–¹æ¡ˆã€‚**

(1024, 2048) @ (2048, 7168), ä¸€å…±åš 16 æ¬¡ã€‚ï¼ˆdown ä¸€æ¬¡ï¼‰**bpa, åæœŸå¯ä»¥ä½¿ç”¨ one groupGemm æ–¹æ¡ˆï¼Œfwd, bpw, ä»ç„¶ä½¿ç”¨ for loop æ–¹æ¡ˆã€‚åŸå› ä¸ŠåŒ**

å¯¹æ¯” naive loop å’Œ numa weight çš„æ–¹æ¡ˆçš„æ€§èƒ½ã€‚

deepseek ä¸­ä¸€ä¸ªä¸“å®¶çš„æ€»å‚æ•°å¦‚ä¸‹ï¼š

7168 * 2048 * 2 * 3 / 1024 / 1024 / 1024 = 0.082G

16 ä¸ªä¸“å®¶æ˜¯ 0.082 * 16 = 1.31G

deepseek æ€»å…± 256 ä¸ªä¸“å®¶ï¼Œå¦‚æœ EP é€šä¿¡åªåœ¨æœºå†…ï¼Œåˆ™æ¯å¼ å¡ 32 ä¸ªä¸“å®¶ï¼Œæ¯ä¸ª moe mlp æ¶ˆè€—æ˜¾å­˜ 2.62Gã€‚

è€Œä¸”æ¯ä¸ªä¸“å®¶çš„æƒé‡ç»´åº¦éƒ½æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥è€ƒè™‘æŠŠä¸“å®¶çš„æƒé‡æ¢æˆ NUMAï¼Œè¿™æ ·åœ¨ load weight çš„æ—¶å€™ï¼Œå¸¦å®½ä¼šæœ‰å¾ˆå¤§æå‡ (50%ï¼Œæ•°æ®æ¥è‡ª supa æŒ‡å—)ã€‚å¯èƒ½åœ¨å°ä¸“å®¶ä¸‹å–å¾—æ¯” naive loop æ›´å¥½çš„æ€§èƒ½ã€‚

ä¸Šå±‚æ¡†æ¶éœ€è¦å¯¹åº”çš„è°ƒæ•´ EP ç­–ç•¥ï¼Œä¿è¯æ¯å¼ å¡è‡³å°‘æœ‰ 16 ä¸ªä¸“å®¶ï¼ˆBR166 ç”± die é—´å¹¶è¡Œç­–ç•¥å†³å®šï¼‰ã€‚æ³¨ï¼šå¦‚æœ weight ä½¿ç”¨ UMA4ã€UMA8ï¼Œå¯ä»¥å¯¹åº”çš„å‡å°‘ä¸“å®¶æ•°çš„çº¦æŸã€‚

- [1ã€Background]([https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-1%E3%80%81Background](https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-1%E3%80%81Background))

- [2ã€Introduction]([https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-2%E3%80%81Introduction](https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-2%E3%80%81Introduction))

- [3ã€Solution]([https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-3%E3%80%81Solution](https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-3%E3%80%81Solution))

- [4ã€å®éªŒæ•°æ®]([https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-4%E3%80%81%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE](https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-4%E3%80%81%E5%AE%9E%E9%AA%8C%E6%95%B0%E6%8D%AE))

- [5ã€8SPCé€‚é…æ–¹æ¡ˆ]([https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-5%E3%80%818SPC%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88](https://conf01.birentech.com/pages/viewpage.action?pageId=206294805#id-1.3DIE%E9%97%B4EP%E7%AE%97%E5%AD%90%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88-5%E3%80%818SPC%E9%80%82%E9%85%8D%E6%96%B9%E6%A1%88))

## 1ã€Background

åŒ DIE EP ä¸Šé™è¾ƒé«˜ï¼ˆtcore åˆ©ç”¨ç‡ï¼‰ï¼Œæœ¬æ–‡æ¡£ä¸ºé€‚é…åŒ DIE EP è®¾è®¡äº†ä¸€ä¸ª non-duplicate kernel launch æ–¹æ¡ˆã€‚

## 2ã€Introduction

ç›®å‰ BR166 ä¸Šçš„ kernel éƒ½æ˜¯ duplicate modeï¼Œä¸¤ä¸ª DIE å¤„ç†ç›¸åŒ shape çš„ tensorï¼Œå¼•å…¥åŒ DIE EP ä¼šå¯¼è‡´ä¸¤ä¸ª DIE ä¸Š suBLAS çš„å·¦çŸ©é˜µä¸ä¸€æ ·ï¼ˆæ¯ä¸ªä¸“å®¶åˆ†é…åˆ°çš„ token æ•°ä¼šå­˜åœ¨ä¸ä¸€è‡´ï¼‰ã€‚

## 3ã€Solution

**åˆ†å¸ƒå¼ç­–ç•¥**ï¼š

å•æœº EP16ï¼ˆEP8+DIE é—´ EPï¼‰ï¼Œæ¯å¼ å¡ 16 ä¸ªä¸“å®¶ï¼Œdie0ã€die1 æœ‰ 16 ä¸ª DIE é—´ä¸“å®¶ç»„ï¼ˆåŒå±äºä¸€ä¸ª UMA16 çš„å«ä¸€ä¸ª DIE é—´ä¸“å®¶ç»„ï¼‰

**æ¡†æ¶å±‚**ï¼š

éœ€è¦ç¡®å®šåŒä¸€ä¸ª DIE é—´ä¸“å®¶ç»„çš„æœ€å¤§è¾“å…¥ token æ•°ï¼Œä¸¤è€…ä¹‹é—´å–æœ€å¤§å€¼æ¥ç”³è¯· UMA16 ç©ºé—´ã€‚

**ç®—å­å±‚ (åœ¨ sublas ç®—å­ä¹‹å‰è°ƒç”¨ï¼Œç¡®ä¿æ¸…é›¶ï¼Œå¯ä»¥ä¿è¯ blas api ä¸å˜)**ï¼š

æŒ‰ç…§åŒä¸€ä¸ªä¸“å®¶ç»„çš„æœ€å¤§è¾“å…¥ token æ•°æ¥é€‰æ‹© kernelï¼›

éœ€ä½¿ç”¨åŒä¸€ä¸ª UMA16 æŒ‡é’ˆæ„é€ ä¸¤ä¸ª shape ä¸ä¸€è‡´çš„ usharpï¼Œä¼ å…¥è®¡ç®— kernelï¼›

kernel æ ¹æ®å½“å‰ die index é€‰æ‹©ä¸åŒçš„ input usharp

**ä¼ªä»£ç ï¼š**

UMA16 device_pointer: **d_p**(input), **d_p_w**(weight)

weight shape: **K**x**N**

input tokens: **M0**, **M1**

host: (æ„å»º M0xK, M1xK ä¸¤ä¸ª usharp, ä½¿ç”¨åŒä¸€ä¸ª UMA16 device pointer)

A0 = matrix2d(M0, K, nullptr, d_p);

A1 = matrix2d(M1, K, nullptr, d_p);

B = matrix2d(K, N, nullptr, d_p_w);

device: (æ ¹æ® die index é€‰æ‹©ä¸åŒçš„ usharp idï¼Œdie_0 use M0xKï¼Œ die_1 use M1xK)

__device__ mma(int uid_0, int uid_1, int uid_2, int M0, int M1, int N, int K) {

int input_uid;

int input_m;

// get die index

if (die_idx == 0) {

input_uid = uid_0;

input_m = M0;

} else {

input_uid = uid_1;

input_m = M1

}

input_tensor = gen_matrix(input_uid, input_m, K);

weight_tensor = gen_matrix(uid_2, K, N);

// call mma as usual

}

## 4ã€å®éªŒæ•°æ®

è€ƒè™‘åˆ° die é—´ TPï¼Œè¿˜æœ‰ up/gate åˆå¹¶çš„å¯èƒ½

N å– 1024ï¼Œ2048ï¼Œ4096

M ä» 32 åˆ° 6144 éå†ï¼Œé—´éš” 32

K=7168

ä»¥ä¸‹æ˜¯å®éªŒç»“æœï¼Œçºµåæ ‡æ˜¯ tcore åˆ©ç”¨ç‡

å¼€å¯ bf16ccï¼Œfullstack version:20250212-804.lkg

![]([https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-8-15.png?version=1&modificationDate=1740726496000&api=v2](https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-8-15.png?version=1&modificationDate=1740726496000&api=v2))

![]([https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-8-47.png?version=1&modificationDate=1740726527000&api=v2](https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-8-47.png?version=1&modificationDate=1740726527000&api=v2))

![]([https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-9-26.png?version=1&modificationDate=1740726567000&api=v2](https://conf01.birentech.com/download/attachments/206294805/image2025-2-28_15-9-26.png?version=1&modificationDate=1740726567000&api=v2))

ç»“è®ºï¼š

1. N=4096 ä¸Šé™æœ€é«˜ï¼Œæ­¤æ—¶å¹¶è¡Œç­–ç•¥æ˜¯åŒ die EPï¼Œup/gate åˆå¹¶

2. M=2048 å’Œ M=4096 æ€§èƒ½å·®åˆ«ä¸æ˜¯ç‰¹åˆ«å¤§ï¼Œç‰¹åˆ«æ˜¯åœ¨ N=4096 çš„æƒ…å†µä¸‹ï¼›å¼€å¯åŒ DieEP å¯ä»¥èŠ‚çœæ˜¾å­˜ï¼Œåªéœ€è¦ä¸€åŠçš„ activation ç©ºé—´ï¼ˆå°½ç®¡ moe éƒ¨åˆ†ä¼šå­˜åœ¨éƒ¨åˆ† paddingï¼Œä½†æ˜¯é moe éƒ¨åˆ†æ˜¾å­˜éœ€æ±‚å‡åŠï¼‰ï¼Œå°±å¯ä»¥è·å– 90% çš„æ€§èƒ½

## 5ã€8SPC é€‚é…æ–¹æ¡ˆ

![]([https://conf01.birentech.com/download/attachments/206294805/image2025-3-26_16-8-50.png?version=1&modificationDate=1742976531000&api=v2](https://conf01.birentech.com/download/attachments/206294805/image2025-3-26_16-8-50.png?version=1&modificationDate=1742976531000&api=v2))

A0/A1 æ˜¯åŒä¸€ä¸ª UMA16 çš„ä¸åŒ regionï¼ŒB0/B1 æ˜¯å¦ä¸€ç»„ UMA16ï¼Œä»£è¡¨ 4 ä¸ªä¸åŒçš„è¾“å…¥ã€‚A0 å’Œ A1(B0 å’Œ B1) çš„é€»è¾‘ shape ä¸€è‡´ï¼Œä½†æ˜¯å®é™…æ˜¯ 4 ä¸ªä¸åŒçš„ä¸“å®¶çš„è¾“å…¥ï¼ˆå­˜åœ¨ padding 0ï¼‰ï¼ŒA/B çš„é€»è¾‘ shape ä¸ä¸€è‡´ï¼ˆå’Œ 106 ç°åœ¨çš„ä¸¤ä¸ªä¸“å®¶ç±»ä¼¼ï¼‰ã€‚

é€šè¿‡è®¾ç½® duplicate modeï¼Œå¯ä»¥åªåˆ›å»ºä¸¤ä¸ª kernelNodeï¼Œä¿æŒç°åœ¨çš„ GroupMMA çš„ api ä»¥åŠæ•´ä½“é€»è¾‘å’Œ 106 ä¸€è‡´ã€‚

> 1ã€åŠŸèƒ½æ’æœŸä¸æ–¹æ¡ˆåˆ—è¡¨

>

> ~~2ã€ä»¥ä¸‹è“è‰²ã€ç»¿è‰²å¸¦å®½æ•°æ®åˆ†åˆ«å½’å±ï¼šubb v1ï¼Œubb v2ï¼ˆå°½é‡é‡‡ç”¨ ubb v2ï¼Œç¼ºå¤±åˆ™ç”¨ ubb v1ã€‚[[Multiple GPU][BR166][v2]dma non-fusedå•æœºæ€§èƒ½æ•°æ®]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933))ï¼Œ[[Multiple GPU][BR166]spc sendrecv/alltoall eagermode æ€§èƒ½æ•°æ®]([https://conf01.birentech.com/pages/viewpage.action?pageId=202031875](https://conf01.birentech.com/pages/viewpage.action?pageId=202031875))ï¼‰~~

>

> 3ã€DeepEP çš„åŸºæœ¬åŸç†ï¼šå› ä¸º NV æœºå†…å¸¦å®½æ˜¯æœºé—´å¸¦å®½çš„ 3.4 å€ï¼ˆ153 / 45ï¼‰ï¼Œæ‰€ä»¥å°†æœºé—´å¼‚å·å¡ä¹‹é—´çš„ all2all æµé‡è½¬åŒ–åˆ°æœºå†…è¿›è¡Œï¼Œè¿›è€Œå®ç°åŠ é€Ÿã€‚BR ä¸Šä¸¤æœºé—´å’Œæœºå†…åŒæ ·è¿‘ä¼¼ 3ï¼ˆSPC 27.9 / 12ï¼‰å€ send/recv å¸¦å®½çš„å…³ç³»ã€‚

# ä¸€ã€ç®—å­æ€§èƒ½è¯„ä¼°ä¸å¹¶è¡Œç­–ç•¥é¢„ä¼°

## 1ã€ç®—å­æ€§èƒ½è¯„ä¼°

ç›®å‰æµ‹è¯•äº†å‰å‘çš„æ•°æ®ï¼Œè€ƒè™‘äº† N=1024ï¼Œ2048ï¼Œ4096ï¼ˆåŒ dieEPï¼Œåˆå¹¶ up,gateï¼‰ï¼Œä»å‰å‘çš„æ€§èƒ½æ•°æ®æ¥çœ‹ï¼Œè¿˜æ˜¯åŒ dieEP ä¸Šé™æ›´é«˜ï¼Œè€Œä¸”å¯ä»¥åœ¨ M=2000 çš„æ—¶å€™å°±å–å¾—ä¸é”™çš„åˆ©ç”¨ç‡ã€‚

## 2ã€ç­–ç•¥ä¸æ˜¾å­˜ç†è®ºå ç”¨

| | | | | | | |

|---|---|---|---|---|---|---|

|106 åå…­æœº| | | | | | |

|non-moe layer|moe layer|global batchsize|micro batchsize|optimizer|recomputer|offload|

|TP4DP2|EP8|16|1|cpu optimizer|True|True|

|kernel size|kernel size|||mem size|||

||(mb_ğ·_topk*seqlen/experts*ACEHOLDER}(1*4096/256*DP)*hidden*ffn_hidden<br><br>(1*2)*hidden*2048<br><br>256*8*2048||||||

|æ˜¾å­˜ç†è®ºé¢„ä¼°|| | | | | |

|166 å…«æœº| | | | | | |

|non-moe layer|moe layer( Die é—´ EP)|global batchsize|micro batchsize|optimizer|recomputer|offload|

|TP4DP2(â†’DP8 4*)|EP8|16|1|cpu optimizer|True|True|

|kernel size|kernel size|||mem size|||

||(4*)256*7168*2048||||||

|æ˜¾å­˜ç†è®ºé¢„ä¼°|stage1 weight with state 48.94 GB, activation 121.76 GB, total 170.71 GB| | | | | |

|166 åå…­æœº| | | | | | |

|non-moe layer|moe layer(Die é—´ EP)|global batchsize|micro batchsize|optimizer|recomputer|offload|

|DP8|EP16|16|2/4|chunk adam 8bit|False|False|

||kernel size||||||

||2048/4096*7168*2048||||||

|æ˜¾å­˜ç†è®ºé¢„ä¼°|mb2: stage1 weight with state 24.47 GB, activation 260.92 GB, total 285.39 GB<br><br>mb4: stage1 weight with state 24.47 GB, activation 521.84 GB, total 546.31 GB| | | | | |

# äºŒã€å•æœºé€šä¿¡æ–¹æ¡ˆ

1ã€å•æœºæ–¹æ¡ˆï¼šå•æœºå†… all2all æ•°æ®é‡é‡å‘ 3.5_ å€Å’_ï¼Œallgather é‡å‘ _8 å€Å’_ã€‚

- æ•°æ®é‡ï¼šè‹¥é‡‡ç”¨ non-moe layer é‡‡ç”¨ TP1DP8, moe layer é‡‡ç”¨ EP8ï¼ˆåŠ ä¸Š Die é—´ EPï¼Œåˆ™å˜ä¸º EP16ï¼‰

- allgatherï¼š 2 * 4096 * 7168 * sizeof(BF16) = 112 MBï¼Œ112 MB * 8 = 896 MBã€‚(ä¹˜ä»¥ 8 æ˜¯è®¡ç®—é€šä¿¡åæ¯ä¸ª Rank é€šä¿¡çš„æ€»çš„æ•°æ®é‡)

- all2allvï¼š112 MB * 3.5 = 392 MBã€‚ï¼ˆä¹˜ä»¥ 3.5 æ˜¯é‡‡ç”¨ DeepEP çš„æ–¹å¼ï¼Œæ¯ä¸ª token åœ¨æœºå†…éœ€è¦é‡å¤å‘é€çš„æ¬¡æ•°ï¼‰

ï¼ˆæ­§ä¹‰è¯´æ˜ï¼šæ— è®ºé‡‡ç”¨ all2allvï¼Œäº¦æˆ–æ˜¯é‡‡ç”¨ DeepEP çš„ NVLink send/recvï¼Œåœ¨ SCCL ä¸­çš„ all2all å®ç°æ–¹å¼é‡‡ç”¨ " å¾ªç¯ send/recv" èƒ½æä¾›çš„ all2allv æˆ–å¹¶è¡Œ send/recv æ€§èƒ½åº”è¯¥ä¸€è‡´ã€‚ï¼‰

- å¸¦å®½åŠè€—æ—¶ï¼š

allgatherï¼šSPC ç‰ˆæœ¬ï¼Œ896 MB / [128.6 GB/s]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance)) = 6.8 msï¼›DMA ç‰ˆæœ¬ï¼š896 MB / 88 GB/s = 9.9 msã€‚

all2allï¼šSPC ç‰ˆæœ¬ï¼Œ392 MB / 54.8 GB/s = 7.15 msï¼›DMA ç‰ˆæœ¬ï¼š392 MB / 16.9 GB/s = 23.2 msã€‚

- ä¸“å®¶è®¡ç®—è€—æ—¶ï¼šå®æµ‹ M/K/N=2048/7168/4096 æ—¶ï¼Œå•ä¸ª expert çš„è€—æ—¶ä¸º 0.6 msï¼Œ9(=256 / 16 + 1 share) ä¸ªä¸“å®¶æ€»è€—æ—¶ 11.9 msã€‚

- ä¼ ç®—å¹¶è¡Œï¼šDMA é€šä¿¡å’Œä¸“å®¶è®¡ç®—æ—¶é—´è¾ƒæ¥è¿‘ max (9.9, 11.9ï¼‰= 11.9 msï¼›è‹¥é‡‡ç”¨ SPC é€šä¿¡ï¼Œæ€»è€—æ—¶ä¸º 6.8 + 11.9 = 18.7ã€‚å­˜åœ¨è¾ƒé«˜çš„å¹¶è¡ŒåŒ–ä»·å€¼ã€‚

> *7168*ï¼šæ¯ä¸ª token è½¬å‘çš„ top-8 ä¸ªä¸“å®¶æœ€å°‘éœ€è¦è½¬å‘ 0 æ¬¡ï¼ˆå…¨éƒ¨ expert ä½äºæœ¬ EP Rankï¼‰ï¼Œæœ€å¤šéœ€è¦è½¬å‘ 7 æ¬¡ï¼Œç®€å•å–å…¶å‡å€¼ ä¸º (0 + 7) / 2 = 3.5ï¼Œå³æ¯ä¸ª token å¹³å‡éœ€è¦è½¬å‘ 3.5 æ¬¡ï¼›

>

> *7168*ï¼šæ¯ä¸ª token éƒ½è½¬å‘ç»™äº†å…¶ä»– EP Rankï¼Œå³æ•°æ®é‡æ‰©å¼ ä¸ºäº†åŸæ¥çš„ 8 å€ã€‚

# ä¸‰ã€ä¸¤æœºé€šä¿¡æ–¹æ¡ˆ

1ã€ä¸¤æœºæ–¹æ¡ˆï¼šæœºé—´åŒå·å¡ send/recvã€æœºå†… allgather

- çº¦æŸ

- - DeepEP æœºå†…è½¬å‘æ•°æ®æ˜¯æœºé—´çš„ _3.5 å€Å’_ã€‚

- æœºå†… send/recv æ˜¯æœºé—´çš„ï¼ˆ24 GB/s / 12 GB/s = ï¼‰2 å€ã€‚

- é€šä¿¡æ•°æ®é‡åŠå¸¦å®½

- ç­–ç•¥ï¼šè‹¥é‡‡ç”¨ non-moe layer é‡‡ç”¨ TP1DP16, moe layer é‡‡ç”¨ EP16ï¼ˆåŠ ä¸Š Die é—´ EPï¼Œåˆ™å˜ä¸º EP32ï¼‰

- æ•°æ®é‡ï¼šæœºé—´ send/recv æ•°æ®é‡ 2 * 4096 * 7168 * sizeof(BF16) = 112 MBï¼›æœºå†… allgather æ•°æ®é‡ 112 MB * 16 = 1.75 GBã€‚

- SPC ç‰ˆæœ¬ï¼šæœºé—´ send/recv å¸¦å®½ [12 GB/s]([https://conf01.birentech.com/pages/viewpage.action?pageId=209781377](https://conf01.birentech.com/pages/viewpage.action?pageId=209781377))ï¼ˆè€—æ—¶ 112 MB / 12 GB/s = 9.11 msï¼‰ï¼Œæœºå†… fuse allgather [128.6 GB/s]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance))[]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance))ï¼ˆè€—æ—¶ 1.75 GB / 128.6 GB/s = 13.6 msï¼‰ã€‚

- DMA ç‰ˆæœ¬ï¼šæœºé—´ send/recv å¸¦å®½ 12 GB/sï¼ˆè€—æ—¶ 112 MB / 12 GB/s = 9.11 msï¼‰ï¼Œæœºå†… fuse allgather 88 GB/s ï¼ˆè€—æ—¶ 1.75 GB / 88 GB/s = 19.8 msï¼‰ã€‚

- åŸç†ï¼šæœºå†…ä» DeepEP çš„ send/recv æ”¹ä¸º allgather çš„åŸå› æ˜¯æœºå†… send/recv å¸¦å®½å¹¶æ²¡æœ‰æœºé—´çš„ 3 å€ä»¥ä¸Šï¼Œè™½ç„¶ allgather ä¼šåŠ  16 / 3.5= 4.6 å€å¤šå‘é€æ•°æ®ï¼Œä½† allgather çš„å¸¦å®½ä¹Ÿæ˜¯å‰è€…çš„ 4.8 - 5.9 å€ï¼ˆSPC 128.6 / 27 =4.8 å€ã€DMA 88 / 15 = 5.9 å€ï¼‰ã€‚åŒæ—¶ï¼Œç•™ä¸‹äº†â€ä¼ ç®—å¹¶è¡Œâ€œçš„å¯èƒ½æ€§ï¼Œå¹¶èƒ½é‡ç”¨ä¸ºå•æœº allgather å¼€å‘çš„èåˆç®—å­ã€‚

- ä¸“å®¶è®¡ç®—è€—æ—¶ï¼šè‹¥ TCore åˆ©ç”¨ç‡ä¸å•æœºç›¸è¿‘ï¼Œä¸” token æ•°æ®å˜å¤šä¸€å€è€Œä¸“å®¶æ•°å‡å°‘ä¸€å€ï¼Œåˆ™è€—æ—¶ä¸å•æœºæŒå¹³ä»ä¿æŒ 11.9 msã€‚

- DeepEP æ–¹æ¡ˆåœ¨ä¸¤æœºä¸‹çš„æ€§èƒ½è¯„ä¼°ï¼š[é“¾æ¥]([https://conf01.birentech.com/pages/viewpage.action?pageId=212454370](https://conf01.birentech.com/pages/viewpage.action?pageId=212454370))ã€‚ç®€è¦ä¿¡æ¯å¦‚ä¸‹è¡¨ï¼š

|æ•°æ®é‡|- NVï¼š2 * 4096 * 7168 * sizeof(FP8) = 56 MBã€‚ï¼ˆFP8 dispatching and BF16 combiningï¼‰<br>- BRï¼š2 * 4096 * 7168 * sizeof(BF16) = 112 MBã€‚|

|ç“¶é¢ˆ|- åœ¨ NV ä¸Šï¼Œç”±äºæœºå†…é€šè¿‡ NVLink è½¬å‘çš„æ•°æ®é‡å¤§çº¦æ˜¯æœºé—´ IB å‘é€æ•°æ®é‡çš„ 2.33 å€â™£ï¼Œä½†æœºå†… NVLink çš„å¸¦å®½æ˜¯æœºé—´å¸¦å®½çš„ (160 GB/s / 50 GB/s = )3.2 å€ï¼Œæ‰€ä»¥ï¼Œ**ç“¶é¢ˆ**ä¸»è¦åœ¨æœºé—´å‘é€çš„ 56 MB æ•°æ®çš„å¸¦å®½ã€‚<br>- åœ¨ BR ä¸Šï¼Œæœºå†…æœºé—´çš„æ•°æ®å€ç‡å…³ç³»åŒä¸Šï¼Œæœºé—´ã€æœºå†…å¸¦å®½åˆ†åˆ«ä¸º 12 GB/sã€24 GB/sï¼ˆæœºå†…ä¸º DMA å¸¦å®½ï¼ŒSPC ç‰ˆæœ¬å¯ä»¥æ›´é«˜ï¼Œä¸Šé™ä¸º 32 GB/sï¼‰ï¼Œæœºå†…å¸¦å®½å˜ä¸ºæœºé—´å¸¦å®½çš„ 2 å€ï¼Œæ•…**ç“¶é¢ˆ**åŒæ ·æ˜¯æœºé—´å‘é€çš„ 112 MB æ•°æ®çš„å¸¦å®½ã€‚|

|é€šä¿¡è€—æ—¶|BRï¼š112 MB / 12 GB/s = 9.11 msã€‚ï¼ˆå‡è®¾ï¼‰|

- ä¼ ç®—å¹¶è¡Œï¼šDMA é€šä¿¡å’Œä¸“å®¶è®¡ç®—çš„ max(9.1 + 9.9ï¼Œ11.9ï¼‰= 19 msï¼›é‡‡ç”¨ SPC ç‰ˆæœ¬ï¼Œæ€»è€—æ—¶åˆ™ä¸º 9.1 + 6.8 + 11.9 = 27.8 msï¼›é‡‡ç”¨ DeepEP æ–¹æ¡ˆï¼Œæ€»è€—æ—¶ 9.11 + 11.9 = 21.01 msã€‚å­˜åœ¨å°‘é‡çš„å¹¶è¡ŒåŒ–ä»·å€¼ã€‚

> 2.33 å€â™£ï¼šæ¯ä¸ª token è½¬å‘çš„ top-8 ä¸ªä¸“å®¶æœ€å°‘éœ€è¦è½¬å‘ 0 æ¬¡ï¼ˆå…¨éƒ¨ expert ä½äºæœ¬ EP Rankï¼‰ï¼Œæœ€å¤šéœ€è¦è½¬å‘ 7 æ¬¡ï¼Œç®€å•å–å…¶å‡å€¼ ä¸º (0 + 7) / 2 = 3.5ï¼Œå³é¡»åœ¨æœºå†…è½¬å‘ 3.5 æ¬¡ï¼Œä½† DeepSeek V3 é™å®šæœ€å¤šå‘ç»™ 3 ä¸ªèŠ‚ç‚¹ï¼Œå–æœ€å°‘ 0 æ¬¡è·¨æœºè½¬å‘å’Œæœ€å¤š 3 æ¬¡è·¨æœºè½¬å‘çš„å‡å€¼ä¸º 1.5ï¼Œä»¥æ­¤ç®—å‡ºæœºå†…æ•°æ®ä¸ºæœºé—´æ•°æ®çš„ 2.33 å€ã€‚

# å››ã€å››æœºæ–¹æ¡ˆ EP64

æš‚ä¸è€ƒè™‘å¤§äº 2 æœºä»¥ä¸Šæ–¹æ¡ˆï¼Œç­‰å¾… BR DeepEP å®ç°ã€‚åŸå› å¦‚ä¸‹ï¼š

- æ•°æ®é‡ï¼šé¦–å…ˆ mb2 å¯ä»¥å¢å¤§åˆ° mb4ï¼Œè‹¥é‡‡ç”¨ non-moe layer é‡‡ç”¨ TP1DP32, moe layer é‡‡ç”¨ EP32ï¼ˆåŠ ä¸Š Die é—´ EPï¼Œåˆ™å˜ä¸º EP64ï¼‰ï¼Œå•å¡æ•°æ®é‡ 4 * 4096 * 7168 * sizeof(BF16) = 224 MBã€‚

- allgather æ–¹æ¡ˆï¼šæ•°æ®é‡ 4 æœº * 8 å¡ * 224 MB = 7 GBã€‚å³ä¾¿åªè€ƒè™‘æœºå†… allgatherï¼Œæœºå†…é€šä¿¡æ—¶é•¿é«˜è¾¾ 7 GB / [128.6 GB/s]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance)) = 54.4msï¼ˆè¡Œä¸é€šï¼‰

- é‡‡ç”¨ DeepEP æ–¹æ¡ˆï¼šæœºé—´æ•°æ®é‡ 224 MB * 3/4 * 3 = 504 MBã€‚(3/4 æ˜¯å¯¹å‘å‘å…¶ä»–èŠ‚ç‚¹çš„ token çš„é¢„ä¼°) è€—æ—¶ 504 MB / 12 GB/s = 42 msã€‚

- ä¸“å®¶è®¡ç®—è€—æ—¶ï¼šè‹¥ TCore åˆ©ç”¨ç‡ä¸å•æœºç›¸è¿‘ï¼Œä¸” token æ•°æ®å˜å¤šä¸€å€è€Œä¸“å®¶æ•°å‡å°‘ä¸€å€ï¼Œåˆ™è€—æ—¶ä¸å•æœºæŒå¹³ä»ä¿æŒ 11.9 msã€‚

- å¤§ EP æ—¶ï¼Œall2all dispatch æ–¹æ¡ˆæ•°æ®é‡æ˜æ˜¾ä½äº allgather dispatch æ–¹æ¡ˆï¼Œallgather æ–¹æ¡ˆéœ€è¦å½’æ‹¢çš„æ•°æ®å¤ªå¤šï¼Œ

- é€šä¿¡æ•°æ® 128 MBï¼Œ1 æœºâ†’ 2 æœºâ†’ 4 æœºï¼ˆå¡é—´â—Šï¼‰all2all æ€§èƒ½è¡°å‡è¶‹åŠ¿ï¼š15.03 GB/sâ†’ 3.3 GB/sâ†’ ?ã€‚ï¼ˆ_8 å€Å’_ï¼‰

äº”ã€ä¸åŒ EP è§„æ¨¡æ€§èƒ½å¯¹æ¯”

|å•æœº EP16|allgather|88||2.5|||||||||||

|ä¸¤æœº EP32|æœºé—´ s/r æœºå†… ag|10 , 88|||||||||||||

|å››æœº EP64|DeepEP|æœºé—´ 10|||||||||||||

äº”ã€åŠŸèƒ½åˆ—è¡¨åŠæ’æœŸ

|allgather ç‰ˆæœ¬æ€§èƒ½å¯¹é½<br><br>- ç®—å­æ€§èƒ½å¯¹é½<br>- é€šä¿¡æ€§èƒ½å¯¹é½|3.22 - 3.29||||1ã€å•æœºå†… all2all å‘é€æ•°æ®é‡æ˜¯æœ€ä½³çŠ¶æ€â™¥çš„ 3.5 å€ï¼Œallgather é€šä¿¡æ•°æ®é‡æ˜¯æœ€ä½³çŠ¶æ€çš„ 8 å€ã€‚ï¼ˆ_3.5 å€Å’_ï¼‰<br><br>2ã€ç›®å‰ï¼Œå•æœº allgather å¸¦å®½ 71 GB/sï¼Œall2all å¸¦å®½ 15 GB/sã€‚æ—¢ allgather æ•°æ®é‡å³ä¾¿ all2all ä¸¤å€ï¼Œé‡‡ç”¨ allgather é€šä¿¡æ—¶é—´ 4.766 ms ä»ä½äº all2all 4.766 msã€‚<br><br>3ã€åŸºäºä¸Šé¢ "2"ï¼Œè‹¥é‡‡ç”¨ SPC all2all å¸¦å®½ä¸º 58 GB/sã€‚è¿™æ—¶é€šä¿¡æ—¶é—´å˜ä¸º 4.766 msï¼Œä½†å‰é¢ä¼šå¢åŠ  permute æ“ä½œï¼Œè€—æ—¶ä¸º 4.766 msã€‚<br><br>3ã€[03-05è·‘é€šç‰ˆæ€§èƒ½profiling]([https://conf01.birentech.com/pages/viewpage.action?pageId=209782746](https://conf01.birentech.com/pages/viewpage.action?pageId=209782746))<br><br>4ã€[æ€§èƒ½å¯¹æ¯”]([https://conf01.birentech.com/pages/viewpage.action?pageId=212438129](https://conf01.birentech.com/pages/viewpage.action?pageId=212438129))|

|Die é—´ EP, EP16<br><br>- Die é—´ EP é€‚é…å¼€å‘<br>- æ¥å…¥ 8 SPC æ–¹æ¡ˆ|3.29 - 4.11||||ç›®å‰æµ‹è¯•äº†å‰å‘çš„æ•°æ®ï¼Œè€ƒè™‘äº† N=1024ï¼Œ2048ï¼Œ4096ï¼ˆåŒ dieEPï¼Œåˆå¹¶ up,gateï¼‰ï¼Œä»å‰å‘çš„æ€§èƒ½æ•°æ®æ¥çœ‹ï¼Œè¿˜æ˜¯åŒ dieEP ä¸Šé™æ›´é«˜ï¼Œè€Œä¸”å¯ä»¥åœ¨ M=2000 çš„æ—¶å€™å°±å–å¾—ä¸é”™çš„åˆ©ç”¨ç‡ã€‚|

|non-moe TP4DP2â†’ DP8 æ˜¾å­˜ä¼˜åŒ–<br><br>- DP8 æ˜¾å­˜ä¼˜åŒ–|3.22 - 4.11|||||

|offloadã€recompute è°ƒä¼˜<br><br>- é€‚é…<br>- è°ƒä¼˜|4.11 - 4.18|||||

|INT8 ä¼˜åŒ–|4.18 - 4.30|||||

|interleave 1f1b<br><br>- é€‚é…<br>- æ€§èƒ½è°ƒä¼˜|4.18 - 4.30|||||

|ç²¾åº¦å¯¹é½|5.1||||ä¾èµ– EP16 A2A é€šä¿¡åº“|

|ä¸¤æœºé€‚é… EP32|5.1 -||||ä¾èµ–è·¨æœº A2A é€šä¿¡æ€§èƒ½|

|||||||

referenceï¼š

1ã€å¸¦å®½è®¡ç®—å…¬å¼ [[https://github.com/NVIDIA/nccl-tests/blob/master/doc/PERFORMANCE.md](https://github.com/NVIDIA/nccl-tests/blob/master/doc/PERFORMANCE.md)]([https://github.com/NVIDIA/nccl-tests/blob/master/doc/PERFORMANCE.md](https://github.com/NVIDIA/nccl-tests/blob/master/doc/PERFORMANCE.md))

> ç›®çš„ï¼šä¸¤æœºä¸å•æœºçš„å·®å¼‚åŠŸèƒ½é¡¹ã€‚

# ä¸€ã€åˆ†å¸ƒå¼ç­–ç•¥

å•æœº EP16 ç­–ç•¥â†’ä¸¤æœº EP32 ç­–ç•¥ï¼šTP1DP8EP**16**PP**16** â†’ TP1DP16EP**32**PP**8**

| | | | | | | |

|---|---|---|---|---|---|---|

|166 åå…­æœº| | | | | | |

|non-moe layer|moe layer(Die é—´ EP)|global batchsize|micro batchsize|optimizer|recomputer|offload|

|TP1DP16/TP2DP8|EP32|960|2/4|chunk adam 8bit|True|True|

||kernel size||||||

||4096_â—Šï¼šæœ€ç»ˆæ–¹æ¡ˆä¸ºDieé—´EPï¼Œæš‚ç¼ºæ•…æš‚æ—¶å¼•ç”¨å¡é—´æ•°æ®_2048||||||

|æ˜¾å­˜ç†è®ºé¢„ä¼°|TP1DP16 + mb2: stage1 weight with state27.94GB, activation 251.45 GB, total 279.40 GB<br><br>TP2DP8 + mb4: stage1 weight with state 25.38 GB, activation 251.45 GB, total276.83 GB| | | | | |

# äºŒã€è®¡ç®—ç®—å­ä¸æ€§èƒ½

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-7-24.png?version=1&modificationDate=1745302045000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-7-24.png?version=1&modificationDate=1745302045000&api=v2))

expert + swigelu fwd/bwd çš„ TCore åˆ©ç”¨ç‡ï¼š

1ã€EP32 æ—¶ï¼Œä¸¤ç§ç­–ç•¥å’Œå¯¹åº” shapeï¼š

- MB2â†’ MB4, TP2DP8+EP32ï¼Œ4096 * 7168 * 4096ï¼Œå¯¹åº”åˆ©ç”¨ç‡ä¸º 52%ã€‚å‰åå‘è€—æ—¶â†’ï¼ˆåŸºäºå•æœºé™ä½ 25%ï¼Œæ¯ä¸ª EP Rank å¤„ç†çš„ expert æ•°é‡å‡åŠ 16â†’ 8ï¼Œä½†æ¯ä¸ª expert è®¡ç®—çš„ token åŠ å€ï¼‰ã€‚

- MB2, TP1DP8â†’ TP1DP16+EP32ï¼Œ4096 * 7168 * 4096, å¯¹åº”åˆ©ç”¨ç‡ä¸º 52%ã€‚(_æœ€ä½³çŠ¶æ€â™¥è¡¨ç¤ºæ¯ä¸ª token æ´¾å‘çš„ä¸“å®¶å±äºåŒä¸€ä¸ª EP Rank_)

2ã€EP16 æ—¶å¯¹åº”åˆ†å¸ƒå¼ç­–ç•¥å’Œ shapeï¼š MB2, TP1DP8+EP16, 2046 * 7168 * 4096, å¯¹åº”åˆ©ç”¨ç‡ä¸º 41%+ã€‚

- non-moe layer å‰å‘è€—æ—¶ï¼š49.682 ms

- mma + rope + KV_Transformï¼š14 ms

- kernel0_single_mha_fwd_0ï¼š8.962 ms

- mmaï¼š2.901 ms

- routerï¼š2.4 ms

- _all_gather_base_fusionï¼š11.307 ms

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-55-33.png?version=1&modificationDate=1745304934000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-55-33.png?version=1&modificationDate=1745304934000&api=v2))

- moe layer å‰å‘è€—æ—¶ï¼š41.435 ms

- dynamic_ep_tp_permutation_fwd_stage1ï¼š0.388 ms

- dynamic_ep_tp_permutation_fwd_stage2ï¼š4.824 ms

- Grouped Gemmï¼š13.155 ms

- dynamic_unpermutation_fwdï¼š5.410 ms

- _reduce_scatter_base_fusionï¼š17.897 ms (*7168*)

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-58-7.png?version=1&modificationDate=1745305088000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_14-58-7.png?version=1&modificationDate=1745305088000&api=v2))

- shared_expert å‰åå‘è€—æ—¶ï¼š11.494 ms

- å‰å‘ï¼š3.255 ms

- åå‘ï¼š8.167 ms

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_15-34-19.png?version=1&modificationDate=1745307259000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_15-34-19.png?version=1&modificationDate=1745307259000&api=v2))

- moe layer åå‘è€—æ—¶ï¼š

- _all_gather_base_fusionï¼š11.365 ms

- dynamic_ep_tp_unpermutation_bwd_generalï¼š7.691 ms

- Grouped Gemmï¼š36.732 ms

- dynamic_permutation_bwdï¼š5.150 ms

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_15-36-6.png?version=1&modificationDate=1745307367000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_15-36-6.png?version=1&modificationDate=1745307367000&api=v2))

- non-moe layer åå‘è€—æ—¶ï¼š62.786 ms

- _reduce_scatter_base_fusionï¼š17.505 ms

- router_bwdï¼š2.68 ms

- mma(bpa/bpw) + shape_transformï¼š8.302 ms

- kernel0_single_mha_bwd_0ï¼š

- KV_Transform_Bwd + Rope_Bwd_Yarn_Tp + mma(bpa/bpw)ï¼š13.151 ms

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_16-16-14.png?version=1&modificationDate=1745309775000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-22_16-16-14.png?version=1&modificationDate=1745309775000&api=v2))

3ã€å•æœº EP16 ä¸ä¸¤æœº EP32 å„æ“ä½œç¯èŠ‚è€—æ—¶å¯¹æ¯”

- éƒ¨åˆ†ç®—å­æ€§èƒ½ä¼šå˜å¥½ï¼šå¦‚æœé‡‡ç”¨ TP1DP16 çš„è¯ï¼Œmha çš„è¾“å…¥ shape ä¸å˜ï¼Œæ€§èƒ½ä¸å˜ï¼ˆè“è‰²è¡¨ç¤ºï¼‰ï¼›permute/unpermute è¾“å…¥ shape å˜å¤§ï¼Œæ€§èƒ½å¯èƒ½ä¼šå˜å·®ï¼ˆé»„è‰²è¡¨ç¤ºï¼‰ï¼›Grouped Gemm çš„ shape å˜ä¸º 4096_**preferred**_4096ï¼Œæ€§èƒ½å¯æå‡ 25%ï¼ˆç»¿è‰²è¡¨ç¤ºï¼‰ã€‚

- é€šä¿¡æ€§èƒ½ä¼šå˜å·®ï¼šåˆ†ä¸ºä¸¤é˜¶æ®µï¼Œæœºé—´åŒ send/recv + æœºå†… allgatherï¼ˆé»„è‰²è¡¨ç¤ºï¼‰ï¼Œä¸”åˆ‡æ¢ä¸º non-fuse succl api ä¹‹åï¼Œé€šä¿¡åéœ€è¦æ¥ä¸€ä¸ª Die é—´ reorderã€‚

|EP16 (ms)|14|9|2.9|2.4|11.3 (fuse succl api)|5.2|13.155|5.410|17.9 (fuse succl api)|3.3|84.565|

|EP32 (ms)|14 (shape ä¸å˜)|9 (shape ä¸å˜)|2.9 (shape ä¸å˜)|2.4 (â†)|9.11 + 9.6 + 8.8 = 27.51|â¬†_è¿™ä¸ªå·²ç»å˜æˆnon-fused succl apiäº†ï¼Œå› ä¸ºæ²¡æœ‰32 SPCæœºå™¨ï¼Œæ²¡æœ‰æ¯”è¾ƒå‡†ç¡®çš„è€—æ—¶trace_3/4=9.9|â¬†*2=10.82 (æ•°æ®åŠ å€)|9.11 + 10.4 + 8.8 = 28.31|3.3|118.54|

||åå‘æ“ä½œ|KV_Transform_Bwd + Rope_Bwd_Tp + mma(bpa/bpw)|kernel0_single_mha_bwd_0|mma(bpa/bpw) + shape_transform|router_bwd|_reduce_scatter_base_fusion|permutation_bwd|Grouped Gemm|unpermutation_bwd|_all_gather_base_fusion|shared_expert||

|EP16 (ms)|13.151|15.527|8.302|2.68|17.505 (fuse succl api)|5.150|36.732|7.691|11.365|8.167|126.27|

|EP32 (ms)|13.151|15.527 (shape ä¸å˜)|8.302 (shape ä¸å˜)|2.68 (â†)|9.11 + 9.6 + 8.8 = 27.51|â¬†*7168*3/4=27.5|â¬†*2=15.4 (æ•°æ®åŠ å€)|9.11 + 10.4 + 8.8 = 28.31|8.167|156.847|

å·¦è¾¹æ˜¯ ep16ï¼Œå³è¾¹æ˜¯ ep32ã€‚ç»“è®ºæ˜¯**send/recv+allgather çš„æ–¹å¼ EP32 ç›¸å¯¹ EP16 ä¸ä¼šæœ‰æ€§èƒ½æ”¶ç›Šï¼Œéœ€è¦é€‚é… DeepEP æ–¹å¼ï¼Œæ‰æ˜¯ç»ˆè§£ã€‚**

![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-23_11-25-33.png?version=1&modificationDate=1745378734000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-23_11-25-33.png?version=1&modificationDate=1745378734000&api=v2))![]([https://conf01.birentech.com/download/attachments/216692568/image2025-4-23_11-25-50.png?version=1&modificationDate=1745378751000&api=v2](https://conf01.birentech.com/download/attachments/216692568/image2025-4-23_11-25-50.png?version=1&modificationDate=1745378751000&api=v2))

# ä¸‰ã€é€šä¿¡æ–¹æ¡ˆä¸æ€§èƒ½

1ã€ä¸¤æœºæ–¹æ¡ˆï¼šæœºé—´åŒå·å¡ send/recvã€æœºå†… allgather

- çº¦æŸ

- - DeepEP æœºå†…è½¬å‘æ•°æ®æ˜¯æœºé—´çš„ *2=10.4(æ•°æ®åŠ å€)|â¬†*ã€‚

- æœºå†… send/recv æ˜¯æœºé—´çš„ï¼ˆ24 GB/s / 12 GB/s = ï¼‰2 å€ã€‚

- é€šä¿¡æ•°æ®é‡åŠå¸¦å®½

- ç­–ç•¥ï¼šè‹¥é‡‡ç”¨ non-moe layer é‡‡ç”¨ TP1DP16, moe layer é‡‡ç”¨ EP16ï¼ˆåŠ ä¸Š Die é—´ EPï¼Œåˆ™å˜ä¸º EP32ï¼‰

- æ•°æ®é‡ï¼šæœºé—´ send/recv æ•°æ®é‡ 2 * 4096 * 7168 * sizeof(BF16) = 112 MBï¼›æœºå†… allgather æ•°æ®é‡ 112 MB * 16 = 1.75 GBã€‚

- SPC ç‰ˆæœ¬ï¼šæœºé—´ send/recv å¸¦å®½ [12 GB/s]([https://conf01.birentech.com/pages/viewpage.action?pageId=209781377](https://conf01.birentech.com/pages/viewpage.action?pageId=209781377))ï¼ˆè€—æ—¶ 112 MB / 12 GB/s = 9.11 msï¼‰ï¼Œæœºå†… fuse allgather [128.6 GB/s]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance))[]([https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance](https://conf01.birentech.com/display/SOF/%5BMultiple+GPU%5DBR166+UBBV2+SPC+fusion+performance))ï¼ˆè€—æ—¶ 1.75 GB / 128.6 GB/s = 13.6 msï¼‰ã€‚

- DMA ç‰ˆæœ¬ï¼šæœºé—´ send/recv å¸¦å®½ 12 GB/sï¼ˆè€—æ—¶ 112 MB / 12 GB/s = 9.11 msï¼‰ï¼Œæœºå†… fuse allgather [182]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933)) GB/s ï¼ˆè€—æ—¶ 1.75 GB / [182]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933)) GB/s = 9.6 msï¼‰ã€‚æœºå†… fuse reducescatter []([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933))[169]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933)) GB/s ï¼ˆè€—æ—¶ 1.75 GB / [169]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933)) GB/s = 10.4 msï¼‰ã€‚å¦‚æœè°ƒç”¨ non-fuse succl api åˆ™åé¢éœ€è¦å†ä»‹ç» Die é—´ reorder 1.75 GB / 200 GB/s = 8.8 msã€‚

- åŸç†ï¼šæœºå†…ä» DeepEP çš„ send/recv æ”¹ä¸º allgather çš„åŸå› æ˜¯æœºå†… send/recv å¸¦å®½å¹¶æ²¡æœ‰æœºé—´çš„ 3 å€ä»¥ä¸Šï¼Œè™½ç„¶ allgather ä¼šåŠ  16 / 3.5= 4.6 å€å¤šå‘é€æ•°æ®ï¼Œä½† allgather çš„å¸¦å®½ä¹Ÿæ˜¯å‰è€…çš„ 4.8 - 5.9 å€ï¼ˆSPC 128.6 / 27 =4.8 å€ã€DMA 88 / 15 = 5.9 å€ï¼‰ã€‚åŒæ—¶ï¼Œç•™ä¸‹äº†â€ä¼ ç®—å¹¶è¡Œâ€œçš„å¯èƒ½æ€§ï¼Œå¹¶èƒ½é‡ç”¨ä¸ºå•æœº allgather å¼€å‘çš„èåˆç®—å­ã€‚

- ä¸“å®¶è®¡ç®—è€—æ—¶ï¼šè‹¥ TCore åˆ©ç”¨ç‡ä¸å•æœºç›¸è¿‘ï¼Œä¸” token æ•°æ®å˜å¤šä¸€å€è€Œä¸“å®¶æ•°å‡å°‘ä¸€å€ï¼Œåˆ™è€—æ—¶ä¸å•æœºæŒå¹³ä»ä¿æŒ 11.9 msã€‚

- DeepEP æ–¹æ¡ˆåœ¨ä¸¤æœºä¸‹çš„æ€§èƒ½è¯„ä¼°ï¼š[é“¾æ¥]([https://conf01.birentech.com/pages/viewpage.action?pageId=212454370](https://conf01.birentech.com/pages/viewpage.action?pageId=212454370))ã€‚ç®€è¦ä¿¡æ¯å¦‚ä¸‹è¡¨ï¼š

|æ•°æ®é‡|- NVï¼š2 * 4096 * 7168 * sizeof(FP8) = 56 MBã€‚ï¼ˆFP8 dispatching and BF16 combiningï¼‰<br>- BRï¼š2 * 4096 * 7168 * sizeof(BF16) = 112 MBã€‚|

|ç“¶é¢ˆ|- åœ¨ NV ä¸Šï¼Œç”±äºæœºå†…é€šè¿‡ NVLink è½¬å‘çš„æ•°æ®é‡å¤§çº¦æ˜¯æœºé—´ IB å‘é€æ•°æ®é‡çš„ 2.33 å€â™£ï¼Œä½†æœºå†… NVLink çš„å¸¦å®½æ˜¯æœºé—´å¸¦å®½çš„ (160 GB/s / 50 GB/s = )3.2 å€ï¼Œæ‰€ä»¥ï¼Œ**ç“¶é¢ˆ**ä¸»è¦åœ¨æœºé—´å‘é€çš„ 56 MB æ•°æ®çš„å¸¦å®½ã€‚<br>- åœ¨ BR ä¸Šï¼Œæœºå†…æœºé—´çš„æ•°æ®å€ç‡å…³ç³»åŒä¸Šï¼Œæœºé—´ã€æœºå†…å¸¦å®½åˆ†åˆ«ä¸º 12 GB/sã€24 GB/sï¼ˆæœºå†…ä¸º DMA å¸¦å®½ï¼ŒSPC ç‰ˆæœ¬å¯ä»¥æ›´é«˜ï¼Œä¸Šé™ä¸º 32 GB/sï¼‰ï¼Œæœºå†…å¸¦å®½å˜ä¸ºæœºé—´å¸¦å®½çš„ 2 å€ï¼Œæ•…**ç“¶é¢ˆ**åŒæ ·æ˜¯æœºé—´å‘é€çš„ 112 MB æ•°æ®çš„å¸¦å®½ã€‚|

|é€šä¿¡è€—æ—¶|BRï¼š112 MB / 12 GB/s = 9.11 msã€‚ï¼ˆå‡è®¾ï¼‰|

- ä¼ ç®—å¹¶è¡Œï¼šDMA é€šä¿¡å’Œä¸“å®¶è®¡ç®—çš„ max(9.1 + 9.9ï¼Œ11.9ï¼‰= 19 msï¼›é‡‡ç”¨ SPC ç‰ˆæœ¬ï¼Œæ€»è€—æ—¶åˆ™ä¸º 9.1 + 6.8 + 11.9 = 27.8 msï¼›é‡‡ç”¨ DeepEP æ–¹æ¡ˆï¼Œæ€»è€—æ—¶ 9.11 + 11.9 = 21.01 msã€‚å­˜åœ¨å°‘é‡çš„å¹¶è¡ŒåŒ–ä»·å€¼ã€‚

> 2.33 å€â™£ï¼šæ¯ä¸ª token è½¬å‘çš„ top-8 ä¸ªä¸“å®¶æœ€å°‘éœ€è¦è½¬å‘ 0 æ¬¡ï¼ˆå…¨éƒ¨ expert ä½äºæœ¬ EP Rankï¼‰ï¼Œæœ€å¤šéœ€è¦è½¬å‘ 7 æ¬¡ï¼Œç®€å•å–å…¶å‡å€¼ ä¸º (0 + 7) / 2 = 3.5ï¼Œå³é¡»åœ¨æœºå†…è½¬å‘ 3.5 æ¬¡ï¼Œä½† DeepSeek V3 é™å®šæœ€å¤šå‘ç»™ 3 ä¸ªèŠ‚ç‚¹ï¼Œå–æœ€å°‘ 0 æ¬¡è·¨æœºè½¬å‘å’Œæœ€å¤š 3 æ¬¡è·¨æœºè½¬å‘çš„å‡å€¼ä¸º 1.5ï¼Œä»¥æ­¤ç®—å‡ºæœºå†…æ•°æ®ä¸ºæœºé—´æ•°æ®çš„ 2.33 å€ã€‚

>

> *2=10.3 (æ•°æ®åŠ å€)|â¬†*ï¼šæ¯ä¸ª token è½¬å‘çš„ top-8 ä¸ªä¸“å®¶æœ€å°‘éœ€è¦è½¬å‘ 0 æ¬¡ï¼ˆå…¨éƒ¨ expert ä½äºæœ¬ EP Rankï¼‰ï¼Œæœ€å¤šéœ€è¦è½¬å‘ 7 æ¬¡ï¼Œç®€å•å–å…¶å‡å€¼ ä¸º (0 + 7) / 2 = 3.5ï¼Œå³æ¯ä¸ª token å¹³å‡éœ€è¦è½¬å‘ 3.5 æ¬¡ï¼›

>

> _3.5 å€Å’_ï¼šæ¯ä¸ª token éƒ½è½¬å‘ç»™äº†å…¶ä»– EP Rankï¼Œå³æ•°æ®é‡æ‰©å¼ ä¸ºäº†åŸæ¥çš„ 8 å€ã€‚

# å››ã€å…¶ä»–

[åŸºäºUBBv2+RDMAçš„DeepEPæ–¹æ¡ˆ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220662460](https://conf01.birentech.com/pages/viewpage.action?pageId=220662460))ã€‚

## Reference

1ã€[1.5åŠŸèƒ½å¼€å‘åˆ—è¡¨]([https://conf01.birentech.com/pages/viewpage.action?pageId=212445319](https://conf01.birentech.com/pages/viewpage.action?pageId=212445319))

2ã€[[Multiple GPU][BR166][v2]dma non-fusedå•æœºæ€§èƒ½æ•°æ®]([https://conf01.birentech.com/pages/viewpage.action?pageId=212436933](https://conf01.birentech.com/pages/viewpage.action?pageId=212436933))

> ç›®çš„ï¼šDeepEP ä»£ç æ¢³ç†ï¼Œä¸ºå®ç° BR ä¸Š DeepEP åšå‚è€ƒã€‚ç›¸äº¤ NV ä¸Šå®ç°ï¼ŒBR ä¸Šå®ç°å¯é’ˆå¯¹ç‰¹å®šçš„å•æœº EP16ã€ä¸¤æœº EP32 å’Œå››æœº EP64 è§„æ¨¡è¿›è¡Œå¼€å‘ã€‚

1ã€ç›®å½•ç»“æ„

|â–¾ csrc/ <br> â–¸ kernels/ <br> CMakeLists.txt <br> config.hpp <br> deep_ep.cpp <br> deep_ep.hpp <br> event.hpp||â–¾ csrc/ <br> â–¾ kernels/ <br> api.cuh <br> buffer.cuh <br> CMakeLists.txt <br> configs.cuh <br> exception.cuh <br> ibgda_device.cuh <br> [[internode.cu](http://internode.cu/)]([http://internode.cu/](http://internode.cu/)) <br> [internode_ll.cu](http://internode_ll.cu/) <br> [[intranode.cu](http://intranode.cu/)]([http://intranode.cu/](http://intranode.cu/)) <br> launch.cuh <br> [[runtime.cu](http://runtime.cu/)]([http://runtime.cu/](http://runtime.cu/)) <br> utils.cuh||â–¾ deep_ep/ <br> __init__.py <br> [buffer.py](http://buffer.py/) <br> utils.py||â–¾ third-party/ <br> nvshmem.patch|

2ã€python ä»£ç 

class Buffer

- const num_sms

- func __init__ï¼šé€šè¿‡å¯¹ self.runtime å˜é‡èµ‹å€¼ä¸º C++ ç‰ˆæœ¬çš„ deep_ep_cpp.Buffer æ¥å®ç°å¯¹åº•å±‚ç¼“å­˜ç©ºé—´çš„é€šä¿¡æ“ä½œã€‚

- func set_num_sms

- func capture

- func get_low_latency_rdma_size_hint

- func get_local_buffer_tensor

- func get_dispatch_config

- func get_combine_config

- func get_dispatch_layout

- **func dispatchï¼šé€šè¿‡æˆå‘˜å˜é‡ self.runtime è°ƒç”¨ C++ å®ç°çš„ self.runtime.intranode_dispatch() æˆ–é€šè¿‡è°ƒç”¨ self.internode_dispatch() å®ç°å¯¹ self.runtime.internode_dispatch() çš„è°ƒç”¨ã€‚**

- **func combineï¼šä¸ä¸Šé¢ dispatch çš„è°ƒç”¨é€»è¾‘ç›¸ä¼¼ã€‚**

- **func internode_dispatchï¼šå¯¹ self.runtime.internode_dispatch() è¿›è¡Œè°ƒç”¨ï¼Œå®ç°æœºé—´çš„ dispatch()ã€‚**

- **func internode_combineï¼šä¸ä¸Šé¢ disptch çš„è°ƒç”¨é€»è¾‘ç›¸ä¼¼ã€‚**

- func clean_low_latency_bufferï¼š

- func low_latency_dispatchï¼šé€šè¿‡è°ƒç”¨ self.runtime.low_latency_combine() å®ç°çš„ä½å»¶è¿Ÿç‰ˆæœ¬ dispatchã€‚

- func low_latency_combineï¼šä¸ä¸Šé¢ disptch çš„è°ƒç”¨é€»è¾‘ç›¸ä¼¼ã€‚

- func get_next_low_latency_combine_bufferï¼š

ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼Œå…ˆé€šè¿‡ get_dispatch_layout() è·å– dispath çš„æ¯ä¸ª ep rankã€rdma rankã€expert é€šè®¯åçš„å¤§å°ï¼Œä»¥ä¾¿æå‰ç”³è¯·ç©ºé—´ã€‚

æŠ˜å æºç 

| |

|---|

|`def` `dispatch_forward(x: Union[torch.Tensor,` `Tuple``[torch.Tensor, torch.Tensor]],`<br><br> `topk_idx: torch.Tensor, topk_weights: torch.Tensor,`<br><br> `num_experts:` `int``, previous_event: Optional[EventOverlap]` `=` `None``)` `-``> \`<br><br> `Tuple``[Union[torch.Tensor,` `Tuple``[torch.Tensor, torch.Tensor]], torch.Tensor, torch.Tensor,` `List``,` `Tuple``, EventOverlap]:`<br><br> ``# NOTES: an optional `previous_event` means a CUDA event captured that you want to make it as a dependency``<br><br> `# of the dispatch kernel, it may be useful with communication-computation overlap. For more information, please`<br><br> `` # refer to the docs of `Buffer.dispatch` ``<br><br> `global` `_buffer`<br><br> `# Calculate layout before actual dispatch`<br><br> `num_tokens_per_rank, num_tokens_per_rdma_rank, num_tokens_per_expert, is_token_in_rank, previous_event` `=` `\`<br><br> `_buffer.get_dispatch_layout(topk_idx, num_experts,`<br><br> `previous_event``=``previous_event, async_finish``=``True``,`<br><br> `allocate_on_comm_stream``=``previous_event` `is` `not` `None``)`<br><br> `# Do MoE dispatch`<br><br> `# NOTES: the CPU will wait for GPU's signal to arrive, so this is not compatible with CUDA graph`<br><br> ``# For more advanced usages, please refer to the docs of the `dispatch` function``<br><br> `recv_x, recv_topk_idx, recv_topk_weights, num_recv_tokens_per_expert_list, handle, event` `=` `\`<br><br> `_buffer.dispatch(x, topk_idx``=``topk_idx, topk_weights``=``topk_weights,`<br><br> `num_tokens_per_rank``=``num_tokens_per_rank, num_tokens_per_rdma_rank``=``num_tokens_per_rdma_rank,`<br><br> `is_token_in_rank``=``is_token_in_rank, num_tokens_per_expert``=``num_tokens_per_expert,`<br><br> `previous_event``=``previous_event, async_finish``=``True``,`<br><br> `allocate_on_comm_stream``=``True``)`<br><br> ``# For event management, please refer to the docs of the `EventOverlap` class``<br><br> `return` `recv_x, recv_topk_idx, recv_topk_weights, num_recv_tokens_per_expert_list, handle, event`|

3ã€c++ ä»£ç 

å‡ ä¸ªä¸»è¦æ¥å£ä»‹ç»å¦‚ä¸‹ï¼š

- get_dispatch_layoutï¼štoken æ•°æ®é€šä¿¡å‰ï¼Œå…ˆå°†

- internode_combine

- internode_dispatch

- intranode_combine

- intranode_dispatch

- sync

4ã€cuda ä»£ç 

åˆå§‹åŒ–ç›¸å…³çš„æ–‡ä»¶ï¼š

buffer.cuh

[[runtime.cu](http://runtime.cu/)]([http://runtime.cu/](http://runtime.cu/))

æœºé—´é€šä¿¡ï¼š

[[internode.cu](http://internode.cu/)]([http://internode.cu/](http://internode.cu/))

[internode_ll.cu](http://internode_ll.cu/)

æœºå†…é€šä¿¡ï¼š

csrc/kernels/[[intranode.cu](http://intranode.cu/)]([http://intranode.cu/](http://intranode.cu/))ï¼šä¸»è¦ç”¨äºåœ¨å¤šä¸ª GPU ä¹‹é—´è¿›è¡Œæ•°æ®é€šä¿¡å’Œèšåˆã€‚DeepEP æ˜¯ä¸€ä¸ªç”¨äºåˆ†å¸ƒå¼æ·±åº¦å­¦ä¹ è®­ç»ƒçš„æ¡†æ¶ï¼Œå®ƒé€šè¿‡ä¼˜åŒ–é€šä¿¡å’Œè®¡ç®—é‡å æ¥æé«˜è®­ç»ƒæ•ˆç‡ã€‚è¿™æ®µä»£ç ä¸»è¦æ¶‰åŠçš„æ˜¯æ•°æ®èšåˆçš„éƒ¨åˆ†ï¼Œå³åœ¨å¤šä¸ª GPU ä¹‹é—´æ”¶é›†å’Œåˆå¹¶æ•°æ®ã€‚

- notify_dispatch æ ¸å‡½æ•°ï¼šä¸»è¦ç›®çš„æ˜¯é€šçŸ¥å…¶ä»– GPU æœ‰æ•°æ®å¯ä»¥æ¥æ”¶ï¼Œå¹¶ç­‰å¾…æ•°æ®å‡†å¤‡å¥½ã€‚ä»£ç ä¸­ä½¿ç”¨äº† CUDA çš„å…±äº«å†…å­˜å’ŒåŸå­æ“ä½œæ¥åŒæ­¥ä¸åŒ GPU ä¹‹é—´çš„æ•°æ®çŠ¶æ€ã€‚

æŠ˜å æºç 

| |

|---|

|`template``<``int` `kNumRanks>`<br><br>`__global__` `void` `notify_dispatch(``const` `int` `numtokensperrank,` `int` `moerecvcountermapped, ...) {`<br><br> `// è·å–å½“å‰çº¿ç¨‹çš„rankå’Œlane id`<br><br> `int` `rank = ...;`<br><br> `int` `laneid = ...;`<br><br> `// è·å–channel tail idx`<br><br> `int` `cachedchanneltailidx = ld_acquire_sys_global(channeltailidx.buffer());`<br><br> `// Ready to copy`<br><br> `if` `(cachedchannelheadidx != cachedchanneltailidx) {`<br><br> `sharedchanneltailidx[responsiblerank] = cachedchanneltailidx;`<br><br> `}`<br><br> `// Timeout check`<br><br> `if` `(clock64() - starttime > NUMTIMEOUTCYCLES) {`<br><br> `printf``(``"DeepEP timeout for dispatch receivers, rank %d, responsiblechannel %d, tokens remained: %dn"``, rank, responsiblechannel, numtokenstorecv);`<br><br> `trap();`<br><br> `}`<br><br> `// Synchronize queue tail`<br><br> `asm` `volatile``(``"bar.sync %0, %1;"` `::` `"r"``(responsiblerank),` `"r"``(numthreadsperrank));`<br><br> `cachedchanneltailidx = sharedchanneltailidx[responsiblerank];`<br><br> `// Copy data`<br><br> `int` `numrecvtokens = cachedchanneltailidx - cachedchannelheadidx;`<br><br> `for` `(``int` `chunkidx = recvwarpidinrank; chunkidx < numrecvtokens; chunkidx += numrecvwarpsperrank) {`<br><br> `int` `tokenidxinbuff...k64();`<br><br> `while` `(channeltailidx[recvlaneid] < expectedhead and expectedhead > 0) {`<br><br> `// Timeout check`<br><br> `if` `(clock64() - starttime > NUMTIMEOUTCYCLES) {`<br><br> `printf``(``"DeepEP timeout for combine receivers, rank %d, responsiblechannel %d, expect %dn"``, rank, responsiblechannel, expectedhead);`<br><br> `trap();`<br><br> `}`<br><br> `}`<br><br> `}`<br><br>`}`|

- æ•°æ®èšåˆï¼šåœ¨å¤šä¸ª GPU ä¹‹é—´è¿›è¡Œæ•°æ®èšåˆçš„é€»è¾‘ã€‚å®ƒä½¿ç”¨äº† CUDA çš„ warp åŒæ­¥å’Œå…±äº«å†…å­˜æ¥é«˜æ•ˆåœ°è¿›è¡Œæ•°æ®èšåˆã€‚

æŠ˜å æºç 

| |

| -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |

| `// Broadcast current heads`<br><br> `int` `num_topk_ranks = 0, topk_ranks[kNumRanks], slot_indices[kNumRanks];`<br><br> `#pragma unroll`<br><br> `for` `(``int` `i = 0; i < kNumRanks; ++ i) {`<br><br> `auto expected_head_i = __shfl_sync(0xffffffff, expected_head, i);`<br><br> `if` `(expected_head_i >= 0) {`<br><br> `slot_indices[num_topk_ranks] = expected_head_i % num_recv_buffer_tokens;`<br><br> `topk_ranks[num_topk_ranks ++] = i;`<br><br> `}`<br><br> `}`<br><br> `// Reduce data`<br><br> `#pragma unroll`<br><br> `for` `(``int` `i = recv_lane_id; i < hidden_int4; i += 32) {`<br><br> `// Read buffers`<br><br> `int4 recv_value_int4[kNumRanks];`<br><br> `#pragma unroll`<br><br> `for` `(``int` `j = 0; j < num_topk_ranks; ++ j)`<br><br> `recv_value_int4[j] = ld_nc_global(channel_x_buffers[topk_ranks[j]].buffer() + slot_indices[j] * hidden_int4 + i);`<br><br> `// Reduce all-to-all results`<br><br> `float` `values[kDtypePerInt4] = {0};`<br><br> `#pragma unroll`<br><br> `for` `(``int` `j = 0; j < num_topk_ranks; ++ j) {`<br><br> `auto recv_value_dtypes =` `reinterpret_cast``<``const` `dtype_t*>(&recv_value_int4[j]);`<br><br> `#pragma unroll`<br><br> `for` `(``int` `k = 0; k < kDtypePerInt4; ++ k)`<br><br> `values[k] +=` `static_cast``<``float``>(recv_value_dtypes[k]);`<br><br> `}`<br><br> ``// Cast back to `dtype_t` and write``<br><br> `int4 out_int4;`<br><br> `auto out_dtypes =` `reinterpret_cast``<dtype_t*>(&out_int4);`<br><br> `#pragma unroll`<br><br> `for` `(``int` `j = 0; j < kDtypePerInt4; ++ j)`<br><br> `out_dtypes[j] =` `static_cast``<dtype_t>(values[j]);`<br><br> `recv_int4[token_idx * hidden_int4 + i] = out_int4;`<br><br> `}`<br><br> `` // Reduce `topk_weights` ``<br><br> `if` `(recv_lane_id < num_topk) {`<br><br> `float` `value = 0;`<br><br> `#pragma unroll`<br><br> `for` `(``int` `i = 0; i < num_topk_ranks; ++ i)`<br><br> `value += ld_nc_global(channel_topk_weights_buffers[topk_ranks[i]].buffer() + slot_indices[i] * num_topk + recv_lane_id);`<br><br> `recv_topk_weights[token_idx * num_topk + recv_lane_id] = value;`<br><br> `}`<br><br> `// Update head`<br><br> `if` `(recv_lane_id < kNumRanks)`<br><br> `warp_channel_head_idx[recv_warp_id][recv_lane_id] = (expected_head < 0) ? -expected_head - 1 : expected_head + 1;`<br><br> `}`<br><br> `// Retired`<br><br> `__syncwarp();`<br><br> `if` `(recv_lane_id == 0)`<br><br> `warp_retired[recv_warp_id] =` `true``;`<br><br> `}` |

- asdf

5ã€è°ƒç”¨ç¬¬ä¸‰æ–¹åº“ nvshmem å®ç°çš„å†…å®¹

è°ƒç”¨çš„æ–‡ä»¶ csrc/kernels/ibgda_device.cuhï¼Œè¯¥æ–‡ä»¶ä¸­å®ç°çš„ä¸»è¦æ¥å£åŒ…æ‹¬ï¼š

- ç”¨äºå°†ä¸»æœºå­—èŠ‚åºè½¬æ¢ä¸ºç½‘ç»œå­—èŠ‚åºï¼ˆå¤§ç«¯åºï¼‰

__device__ static __forceinline__ uint64_t HtoBE64(uint64_t x) { ... }

__device__ static __forceinline__ uint32_t HtoBE32(uint32_t x) { ... }

__device__ static __forceinline__ uint16_t HtoBE16(uint16_t x) { ... }

- é˜Ÿåˆ—å¯¹ç®¡ç†

__device__ static __forceinline__ nvshmemi_ibgda_device_state_t* ibgda_get_state() { ... }

__device__ static __forceinline__ nvshmemi_ibgda_device_qp_t* ibgda_get_rc(int pe, int id) { ... }

__device__ static __forceinline__ void ibgda_lock_acquire(int *lock) { ... }

__device__ static __forceinline__ void ibgda_lock_release(int *lock) { ... }

__device__ static __forceinline__ void ibgda_update_dbr(nvshmemi_ibgda_device_qp_t *qp, uint32_t dbrec_head) { ... }

__device__ static __forceinline__ void ibgda_ring_db(nvshmemi_ibgda_device_qp_t *qp, uint16_t prod_idx) { ... }

__device__ static __forceinline__ void ibgda_post_send(nvshmemi_ibgda_device_qp_t *qp, uint64_t new_prod_idx) { ... }

- è¿œç¨‹å†…å­˜å†™æ“ä½œ

__device__ static __forceinline__ void ibgda_write_rdma_write_inl_wqe(nvshmemi_ibgda_device_qp_t *qp, const uint32_t *val, uint64_t raddr, __be32 rkey, uint16_t wqe_idx, void **out_wqes, uint32_t imm) { ... }

__device__ static __forceinline__ void ibgda_write_rdma_write_wqe(nvshmemi_ibgda_device_qp_t *qp, uint64_t laddr, __be32 lkey, uint64_t raddr, __be32 rkey, uint32_t bytes, uint16_t wqe_idx, void **out_wqes) { ... }

- è¿œç¨‹é”®è·å–

__device__ static __forceinline__ uint64_t ibgda_get_lkey_and_rkey(uint64_t laddr, __be32 *lkey, uint64_t raddr, int dst_pe, uint64_t *out_raddr, __be32 *out_rkey) { ... }

__device__ static __forceinline__ void ibgda_get_rkey(uint64_t addr, int dst_pe, uint64_t *out_raddr, __be32 *out_rkey) { ... }

- WQE ç®¡ç†

__device__ static __forceinline__ uint64_t ibgda_reserve_wqe_slots(nvshmemi_ibgda_device_qp_t *qp, uint32_t num_wqes) { ... }

__device__ static __forceinline__ void* ibgda_get_wqe_ptr(nvshmemi_ibgda_device_qp_t* qp, uint16_t wqe_idx) { ... }

__device__ static __forceinline__ void ibgda_write_empty_recv_wqe(void *out_wqe) { ... }

- RDMA æ“ä½œ

__device__ static __forceinline__ void nvshmemi_ibgda_rma_p(int *rptr, const int value, int dst_pe, int qp_id, uint32_t imm = std::numeric_limits<uint32_t>::max()) { ... }

template <bool kAlwaysDoPostSend> __device__ static __forceinline__ void ibgda_submit_requests(nvshmemi_ibgda_device_qp_t *qp, uint64_t base_wqe_idx, uint32_t num_wqes, int message_idx = 0) { ... }

template <bool kAlwaysDoPostSend = false> __device__ static __forceinline__ void nvshmemi_ibgda_put_nbi_warp(uint64_t req_rptr, uint64_t req_lptr, size_t bytes, int dst_pe, int qp_id, int lane_id, int message_idx) { ... }

__device__ static __forceinline__ void ibgda_write_amo_add_wqe(nvshmemi_ibgda_device_qp_t *qp, const int &value, uint64_t laddr, __be32 lkey, uint64_t raddr, __be32 rkey, uint16_t wqe_idx, void **out_wqes) { ... }

__device__ __forceinline__ void nvshmemi_ibgda_amo_nonfetch_add(void *rptr, const int& value, int pe, int qp_id, bool is_local_copy = false) { ... }

- `nvshmemi_ibgda_rma_p`ï¼šè¿œç¨‹å†…å­˜å†™æ“ä½œã€‚

- `ibgda_submit_requests`ï¼šæäº¤è¯·æ±‚ã€‚

- `nvshmemi_ibgda_put_nbi_warp`ï¼šæ‰¹é‡æäº¤è¯·æ±‚ã€‚

- `ibgda_write_amo_add_wqe`ï¼šåŸå­åŠ æ³•æ“ä½œã€‚

- `nvshmemi_ibgda_amo_nonfetch_add`ï¼šéå†…è”åŸå­åŠ æ³•æ“ä½œ

Reference

1ã€[[https://github.com/deepseek-ai/DeepEP](https://github.com/deepseek-ai/DeepEP)]([https://github.com/deepseek-ai/DeepEP](https://github.com/deepseek-ai/DeepEP))

> ä¸‡å¡åŒ…æ‹¬ UBBv2 + OCS TOPO

>

>

>

> æ­¤æ–‡æ¡£æè¿°äº†æ–¹æ¡ˆåŸå‹ï¼Œå…·ä½“è¿˜éœ€è¦ä¸ SUCCL å›¢é˜Ÿè¿›ä¸€æ­¥è®¨è®ºã€‚

>

> æœ‰ä¸¤ç‚¹éœ€è¦åœ¨æ­¤æå‰å£°æ˜ï¼š

>

> 1ã€å•æœº EP16 çš„æƒ…å½¢ä¸‹ï¼Œå‡è®¾é€šè¿‡ top-8 é€‰æ‹©çš„ä¸“å®¶æ˜¯å‡åŒ€åˆ†å¸ƒåœ¨ EP0(expert-0, expert-1) ï½ EP15(expert-254, expert-255) å…±è®¡ 16 ä¸ª EP Rank ä¸Šï¼Œè¿™ 16 ä¸ª EP Rank å¯¹åº” 8 ä¸ª gpu rankï¼Œæ•…æ¯ä¸ª token éœ€è¦å‘é€åˆ°æ¯ä¸ª gpu rank ä¸Šçš„æ¦‚ç‡ä¸º Combination(32, 1)^8 / Combination(256, 8)ï¼Œå³é‡‡ç”¨ allgather æ˜¯ä¸€ç§è¾ƒä½æ•ˆçš„æ–¹å¼ã€‚é€šè¿‡ DeepEP çš„æ–¹å¼ï¼Œç›¸äº¤ allgather ä¸ä»…å¯ä»¥å‡å°‘æ•°æ®ä¼ è¾“ï¼Œè¿˜èƒ½è¿›ä¸€æ­¥æ¶ˆé™¤ permutation æ“ä½œï¼Œè‹¥å°† reorder è¿›è¡Œèåˆï¼Œåˆ™éœ€è¦é‡‡ç”¨ SPC è¿›è¡Œ reorder å’Œé€šä¿¡ï¼Œè¿™æ—¶ä¼šå¤±å»äº†â€œä¼ ç®—å¹¶è¡Œâ€çš„æœºä¼šã€‚å½“â€œä¼ ç®—å¹¶è¡Œâ€æ–¹æ¡ˆå¯ä»¥å°†é€šä¿¡å…¨éƒ¨ overlap æ‰æ—¶ï¼Œåªæœ‰åœ¨ DeepEP æ–¹æ¡ˆçš„æ€»è€—æ—¶å°äº permutation æ“ä½œæ—¶ï¼Œæ‰ä¼šæœ‰æ”¶ç›Šã€‚

>

> 2ã€è·¨ä¸¤æœº EP32 æƒ…å½¢ä¸‹ï¼Œå¯¹æœºå™¨æ•°åŠ å€ï¼ˆ16 æœºâ†’ 32 æœºï¼‰ï¼Œéœ€è¦ä¿è¯å•ä¸ª transformer layer æ‰§è¡Œæ—¶é—´ä¿æŒä¸å˜ï¼Œæ‰èƒ½ä½¿**TGS**ä¸é™ä½ï¼Œå½“é‡‡ç”¨ mb2 æ—¶ï¼Œç”±äºéœ€è¦ä¼ è¾“çš„æ•°æ®é‡åŠ å€ï¼Œä¼šåœ¨é€šä¿¡éƒ¨åˆ†å½¢æˆç“¶é¢ˆï¼Œå•ä¸ª transformer layer æ‰§è¡Œæ—¶é—´ä¼šå˜é•¿ï¼Œä¸”æ˜¾å­˜ä¿æŒä¸å˜ï¼Œæ­¤æ—¶æ€§èƒ½ç›¸è¾ƒå•æœº EP16 ä¼šæœ‰æ‰€é™ä½ï¼›è‹¥é‡‡ç”¨ mb1 æ—¶ï¼Œè™½ç„¶å¢åŠ äº†æœºé—´åŒå·å¡é—´çš„æ•°æ®ä¼ è¾“å»¶æ—¶ (56 MB / 11 GB/s = 5 ms)ï¼Œä½†æœºå†…ä¼ è¾“æ•°æ®é‡ä¸å•æœºæ—¶æŒå¹³ï¼Œmoe layer çš„ dipatch å’Œ combine æ“ä½œ shape å’Œå•æœºä¸€è‡´ï¼Œæ­¤å¤–ï¼Œæ˜¾å­˜ä½¿ç”¨ç‡é™ä½ä¸€åŠï¼Œå¯èƒ½é€šè¿‡é™ä½é‡è®¡ç®—æ¯”ä¾‹ï¼Œä»¥æ‰¾è¡¥å›è·¨æœºé€šä¿¡çš„è€—æ—¶ã€‚

- [ä¸€ã€æ•´ä½“æµç¨‹]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%B8%80%E3%80%81%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B))

- [äºŒã€å•æœºä¸­dispatchå’Œcombineæ“ä½œæµç¨‹]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%BA%8C%E3%80%81%E5%8D%95%E6%9C%BA%E4%B8%ADdispatch%E5%92%8Ccombine%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%BA%8C%E3%80%81%E5%8D%95%E6%9C%BA%E4%B8%ADdispatch%E5%92%8Ccombine%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B))

- [ä¸‰ã€EP32ä¸¤æœºé€šä¿¡æ–¹æ¡ˆä¸æ€§èƒ½é¢„ä¼°]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%B8%89%E3%80%81EP32%E4%B8%A4%E6%9C%BA%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E4%B8%8E%E6%80%A7%E8%83%BD%E9%A2%84%E4%BC%B0](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%B8%89%E3%80%81EP32%E4%B8%A4%E6%9C%BA%E9%80%9A%E4%BF%A1%E6%96%B9%E6%A1%88%E4%B8%8E%E6%80%A7%E8%83%BD%E9%A2%84%E4%BC%B0))

- [å››ã€64æœºEP64]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E5%9B%9B%E3%80%8164%E6%9C%BAEP64](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E5%9B%9B%E3%80%8164%E6%9C%BAEP64))

- [äº”ã€å¿…è¦æ€§ä¸æ€§èƒ½æ”¶ç›Š]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%BA%94%E3%80%81%E5%BF%85%E8%A6%81%E6%80%A7%E4%B8%8E%E6%80%A7%E8%83%BD%E6%94%B6%E7%9B%8A](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E4%BA%94%E3%80%81%E5%BF%85%E8%A6%81%E6%80%A7%E4%B8%8E%E6%80%A7%E8%83%BD%E6%94%B6%E7%9B%8A))

- [å…­ã€UBBV2-Port10åˆ©ç”¨]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E5%85%AD%E3%80%81UBBV2-Port10%E5%88%A9%E7%94%A8](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#id-3.UBBv2+RDMA%E7%BD%91%E7%BB%9C%E4%B8%8A%E7%9A%84DeepEP-%E5%85%AD%E3%80%81UBBV2-Port10%E5%88%A9%E7%94%A8))

# ä¸€ã€æ•´ä½“æµç¨‹

æ•´ä½“æ€è·¯æ˜¯åœ¨å‰å‘æ—¶ï¼Œå°† hidden state åœ¨è¿›è¡Œ dispatch å‰è½¬æ¢ä¸º plain buffer (pb) rowmajorï¼Œä¹‹åè¿›è¡Œ dispatchã€grouped-gemm å’Œ combine æ“ä½œï¼Œcombine å®Œæˆåå†å°† pb rowmajor è½¬æ¢å› colmajorã€‚åå‘æ“ä½œä¸ä¹‹ç›¸åã€‚

è™šçº¿ä¸­é‡‡ç”¨ sublas groupgemm token, weights, output å…¨éƒ¨çš„æ˜¯ row major æ–¹å¼æ‰§è¡Œï¼Œå‰åå‘éƒ½æ˜¯ã€‚

![]([https://conf01.birentech.com/download/attachments/187556309/BR166%20new%202024_11_11_slave_mirror_master.png?version=2&modificationDate=1731381885000&api=v2](https://conf01.birentech.com/download/attachments/187556309/BR166%20new%202024_11_11_slave_mirror_master.png?version=2&modificationDate=1731381885000&api=v2))

# äºŒã€å•æœºä¸­ Dispatch å’Œ Combine æ“ä½œæµç¨‹

## 1ã€dispatch_fwd

> åç§°å®šä¹‰ï¼š

>

> EP Rankï¼šå•æœº EP16 æ—¶ï¼Œå…«ä¸ª GPU å¡å…±åŒæ‰¿è½½ 16 ä¸ª EP Rankï¼Œæ¯ä¸ª EP Rank ä¸­æœ‰ 16 ä¸ª expertã€‚

>

> GPU Rankï¼ˆå¯¹åº” DeepEP ä¸­çš„ rdma rankï¼‰ï¼šå•æœºæ—¶ï¼Œä¸€ä¸ª GPU Rank ä¸­åŒ…å«ä¸¤ä¸ª EP Rankï¼Œå…± 32 ä¸ª expertã€‚

>

> DP Rankï¼šå¯¹åº” MLA éƒ¨åˆ†çš„ DPã€‚

æ•´ä½“æµç¨‹å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ¯ä¸ªæ—¶é—´æ­¥è¿›è¡Œçš„æ“ä½œå¦‚ä¸‹ï¼š

- t0ï¼šreorder hidden state with colmajor â†’ send staging buffer with rowmajorï¼Œå°†æ´¾å‘åˆ°ä¸åŒ expert çš„ token æ‹·è´åˆ° expert æ‰€åœ¨çš„ GPU Rank çš„ staging buffer ä¸­ï¼ˆé‡‡ç”¨ bucket æœºåˆ¶ï¼‰

- - æ–¹å¼ä¸€ï¼šå°† 112MB colmajor ç›´æ¥è½¬æ¢ä¸º 112 MB rowmajorï¼Œå†é‡‡ç”¨ SPC è¿›è¡Œ**DeepEP**æ–¹å¼è¿›è¡Œè½¬å‘ã€‚

- æ–¹å¼ 2ï¼Œ3 ä¸å†è€ƒè™‘ å¤æ‚ä¸”æ€§èƒ½ä¸ä¸€å®šæœ‰æ”¶ç›Šã€‚

- ~~æ–¹å¼äºŒï¼šå°† 112MB colmajor è½¬æ¢ä¸º rowmajorï¼ŒåŒæ—¶å°†å‘é€åˆ°ä¸åŒ gpu rank çš„æ•°æ®æ‹·è´åˆ° gpu rank bufferï¼Œæ­¤æ—¶å‘é€ç¼“å†²åŒºå¤§å°ä¼šå˜æˆ 7 * 112 MBï¼Œå†è°ƒç”¨**all2all**è¿›è¡Œé€šä¿¡ï¼Œé€šä¿¡ç»“æŸåï¼ŒæŠŠæ¥æ”¶åˆ°çš„æ•°æ®æ‹·è´åˆ° expert buffer ä¸­ã€‚~~

- ~~æ–¹å¼ä¸‰ï¼šåœ¨è¿›è¡Œ reorder è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨ staging buffer with bucketï¼Œæ ¹æ® indices ä¿¡æ¯ï¼Œå°†é˜¶æ®µæ€§ reorder è¾“å‡ºåŒæ­¥é‡‡ç”¨**DMA è¿›è¡ŒåŒæ­¥**è½¬å‘ã€‚ï¼ˆä¸‹é¢è¯´æ˜ä»¥â€œæ–¹å¼ä¸‰â€è¿›è¡Œï¼‰~~

- t1ï¼šåœ¨ reorder+copy è¿‡ç¨‹ä¸­ï¼Œbucket å¡«æ»¡åï¼Œåˆ™å°†æ•°æ®è½¬å‘åˆ°ç›¸åº”çš„ gpu_rank ä¸­ã€‚ç”±äºå¡«æ»¡å‘é€åˆ°ä¸åŒ gpu rank çš„ bucket çš„æ—¶æœºå¹¶ä¸ç¡®å®šï¼Œæ‰€ä»¥åœ¨è¿›è¡Œç‚¹åˆ°ç‚¹ send/recv æ—¶ï¼Œæ˜¯ä¹±åºå‘é€çš„ï¼ŒåŸºäºæ­¤å¯è¿›è¡Œå¦‚ä¸‹å‡ ç§æ”¹è¿›ï¼š

- - 1ã€é‡‡ç”¨æ›´å¤§çš„ bucket sizeï¼Œæé™ä¸º 112Mï¼Œç”±äºé€‰æ‹©çš„ä¸“å®¶å¯èƒ½å‡åŒ€åˆ†å¸ƒåœ¨ä¸åŒçš„ EP Rank ä¸Šï¼Œæ­¤æ—¶ï¼Œéœ€è¦çš„æ€»ç¼“å­˜å¤§å°ä¸º 1 * 112MB â‰¤ Size â‰¤ 8 * 112 MBã€‚ç­‰æ‰€æœ‰ reorder+copy_to_stagingbuffer æ“ä½œå®Œï¼Œå†è¿›è¡Œä¼ è¾“ã€‚ç¼ºç‚¹æ˜¯ä¸èƒ½åœ¨ reorder è¿‡ç¨‹ä¸­ï¼Œè¿›è¡ŒåŒæ­¥é€šä¿¡ï¼›ä¼˜ç‚¹æ˜¯èƒ½å¯¹é€šä¿¡è¿›è¡Œæ’æµæ°´ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚

- 2ã€/

- t2ï¼šæ¥æ”¶ç«¯ï¼Œå°† gpu_rank staging buffer ä¸­çš„ token æ ¹æ® indices æ‹·è´åˆ°ç›¸åº” expert buffer ä¸­ï¼Œä¸ºä¸‹ä¸€æ­¥ Grouped GEMM è®¡ç®—åšå‡†å¤‡ã€‚

## 2ã€dispatch_bwd

ä¸ combine_fwd æ“ä½œä¸€è‡´

## 3ã€combine_fwd

## 4ã€combine_bwd

ä¸ dispatch_fwd æ“ä½œä¸€è‡´

# ä¸‰ã€EP32 ä¸¤æœºé€šä¿¡æ–¹æ¡ˆä¸æ€§èƒ½é¢„ä¼°

ï¼ˆ32 æœº TP1DP16PP16EP32, mb1 ç­–ç•¥ä¸‹ï¼‰

internode : éœ€è¦åŒ—å‘äº’è” è´Ÿè´£ inter-node èŠ‚ç‚¹é—´ï¼Œèµ° NIC ç½‘å¡ï¼Œé€šè¿‡ switch äº’è” ã€‚ è¿œç«¯è®¿é—®ï¼Œä½¿ç”¨ RDMA

## 1ã€æœºé—´ send/recv + æœºå†… Allgather

ï¼ˆä¼˜ç‚¹åœ¨äºå¯ä»¥å®Œå…¨é‡ç”¨å•æœºæ—¶ï¼Œé€šä¿¡è®¡ç®—å¹¶è¡Œçš„æ–¹æ¡ˆï¼Œåœ¨ microbatch ä¹‹é—´ overlap DMA é€šä¿¡å’Œè®¡ç®—ï¼Œç¼ºç‚¹åœ¨äºå¼•å…¥ permuation/unpermuationï¼‰

- ç”±äºæ¯ä¸ª token é€‰æ‹©çš„ expert åŒæ—¶ä½äºä¸¤å°æœºå™¨ä¸Šçš„æ¦‚ç‡éå¸¸æ¥è¿‘äº 1ï¼Œæ•…æœºé—´ send/recv æ•°æ®é‡ 56 MBï¼Œè€—æ—¶ 5 æ¯«ç§’

- ä½¿ç”¨ Node Limited Routing ç†è®ºå¯ä»¥äººä¸ºè®© expert é€‰ 1 ä¸ªæœºå™¨çš„ top8.

- æœºå†…é‡‡ç”¨ fused succl api allgather 112MB æ•°æ®éœ€è¦ 11.3 msï¼Œå°†å…¶åˆ†ä¸ºä¸¤éƒ¨åˆ†ä¸”åˆ†ä¸¤æ­¥è¿›è¡Œæ“ä½œï¼š

- ç¬¬ä¸€æ­¥ï¼šåœ¨è¿›è¡Œæœºé—´ send/recv åŒæ—¶ï¼Œå…ˆå°†å·²æœ‰çš„ 56MB è¿›è¡Œ allgatherï¼Œè€—æ—¶ 5.6msã€‚

- ç¬¬äºŒæ­¥ï¼šå†å¯¹ send/recv è¿‡æ¥çš„ 56MB æ•°æ®ï¼Œè¿›è¡Œ allgatherï¼Œè€—æ—¶ 5.6ms

- permutationï¼šå¦‚ä¸Šå›¾ç¤ºï¼Œå°† permutation åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œå„è‡ªè€—æ—¶ 3 msã€‚

æ€»è€—æ—¶ï¼š14.2 ms ï¼ˆVS. å•æœº EP16 allgather + permute: 16.5 msï¼‰

## 2ã€æœºé—´ send/recv + æœºå†… DeepEP

ï¼ˆä¼˜ç‚¹åœ¨äºé‡‡ç”¨ SPC è¿›è¡Œé€šä¿¡åï¼Œæœºé—´ send/recv å¯ä»¥ä» 11-12 GB/s æå‡åˆ° 16-17 GB/sï¼Œå½“ç„¶å¯ä»¥é‡‡ç”¨ DMA è¿›è¡Œæœºé—´ send/recvã€‚åŒæ—¶ï¼Œæœºå†…çš„å¯é‡‡ç”¨ DeepEP çš„å®ç°æ–¹å¼ï¼Œä»¥æ¶ˆé™¤ permuation/unpermuationï¼‰

- æœºé—´è¿›è¡Œ send/recv 56 MBï¼Œè€—æ—¶ 5ms

- æœºå†…é‡‡ç”¨ DeepEP çš„æ–¹å¼ï¼Œéœ€è¦è½¬å‘çš„æ•°æ®é‡ 4 * 112 MB = 448 MBï¼Œè€—æ—¶ 448 MB / **100 GB/s** = 4.48 msï¼ˆ**è¿™é‡Œå‡è®¾ DeepEP Dispatch å¸¦å®½ä¸º 100 GB/s**ï¼‰ã€‚å°†å…¶åˆ†ä¸ºä¸¤æ­¥è¿›è¡Œæ“ä½œï¼š

- - ç¬¬ä¸€æ­¥ï¼šåœ¨è¿›è¡Œæœºé—´ send/recv åŒæ—¶ï¼Œå…ˆå°†å·²æœ‰çš„ 56MB è¿›è¡Œ DeepEPï¼Œè€—æ—¶ 4.9 msã€‚

- ç¬¬äºŒæ­¥ï¼šå†å¯¹ send/recv è¿‡æ¥çš„ 56MB æ•°æ®ï¼Œè¿›è¡Œ DeepEPï¼Œè€—æ—¶ 2.24 msã€‚

è‹¥é‡‡ç”¨æ­¤æ–¹æ¡ˆï¼Œå³ä¾¿æœºé—´ send/recv å¯ä»¥è¢«æœºå†…çš„ DeepEP overlapï¼Œä»éœ€è€—æ—¶ 7.14 msã€‚

## 3ã€SCCL å®ç°æ–¹å¼åŠæ€§èƒ½é¢„ä¼°

### 3.1 (åŸºäº EP32ï¼ˆ16 å¡ 32DIEï¼‰ï¼Œæ¯ä¸ª DIE 2K tokenï¼Œ28M per die)

å®ç°æ–¹å¼ä¸»è¦åˆ†ä¸º 4 æ­¥ï¼Œé¢„è®¡å®é™…ä¸²è¡Œæ€»æ—¶é—´é¢„ä¼°ä¸º 10.25ms

æ€§èƒ½æè‡´ä¼˜åŒ–æƒ…å†µä¸‹ï¼Œå¯å°†ç¬¬ä¸‰æ­¥å’Œç¬¬äºŒæ­¥ä¸­çš„ nic forward pipeline å¹¶è¡Œï¼ŒåŠ ä¸Šè¾ƒä¸ºç†æƒ³çš„ç½‘ç»œå¸¦å®½ï¼Œæ­¤æ—¶ç†è®ºä¸Šæ€»çš„æœ€ä¼˜æ€§èƒ½é¢„ä¼°ä¸º 8.5ms å·¦å³

~~åŸæœ‰ Weidong, guodong æ–¹æ¡ˆ ï¼ˆç–‘ä¼¼ AllGather æ–¹æ¡ˆï¼Œ æ­¤æ–¹æ¡ˆç”±äºæœ‰å†—ä½™è¢«å„æ–¹æ”¾å¼ƒ ä¸å†åˆ†æï¼‰ï¼š~~

1. ~~reorder + send (OCS å¤ç”¨ä»£ç ï¼Œ 8 SPC, send æ˜¯ allgather å—ï¼Ÿï¼‰~~

2. ~~é€šä¿¡é‡ï¼š28M per die, å¸¦å®½ï¼š200GB/s å·¦å³, é¢„è®¡è€—æ—¶ï¼š0.15ms~~

3. ~~**nic forward** ï¼ˆinter-nodeï¼Œ OCS æ²¡è¿™ partï¼Œ port1 column éœ€è¦ 1 ä¸ª SPC for RDMA) + p2p forward (OCS topo ä¸åŒï¼Œ2.b è·Ÿ 3.a æ˜¯åŒä¸€ä¸ª device function, 8 SPC 4+4 )~~

4. ~~nic forwardï¼ˆé€šä¿¡é‡ï¼š56Mï¼Œé€šä¿¡æ¦‚ç‡ï¼š1 - (1/2)^8 = 1ï¼Œç†è®ºå¸¦å®½ï¼š**13GB/s(with RoCEv2, IB 15-16GB/s)**ï¼Œé¢„è®¡å®æµ‹ä¸ºç†è®ºçš„ 80%ï¼Œé¢„è®¡ç†è®ºè€—æ—¶ï¼š**4.3ms**ï¼Œé¢„è®¡å®é™…è€—æ—¶ï¼š5.4msï¼‰~~

5. ~~NLR : è·¨çº§å‡ ç‡é™ä½ 50%ã€‚Base æ–¹æ¡ˆ ä¸é‡‡ç”¨ã€‚~~

6. ~~p2p forwardï¼ˆç›´è¿è½¬å‘ï¼Œé€šä¿¡é‡ 1ï¼š56Mï¼Œ é€šä¿¡ 1 æ¦‚ç‡ï¼š1 - (12/16)^8 = 0.9ï¼Œé€šä¿¡é‡ 2ï¼š56Mï¼Œ é€šä¿¡ 2 æ¦‚ç‡ï¼š0.4ï¼Œå¸¦å®½ï¼š20GB/s * 2ï¼Œ é¢„è®¡è€—æ—¶ï¼š1.75msï¼‰~~

7. ~~p2p forward ï¼ˆintra-node å•æœºå†…ï¼Œè·Ÿ OCS topo ä¸åŒ å•ä»£ç å¯èƒ½å¤ç”¨ï¼Œ9 SPC ï¼š 4+4 )~~

8. ~~ä¸ç¬¬äºŒæ­¥ä¸­çš„ p2p forward è¿‘ä¼¼ï¼Œé¢„è®¡è€—æ—¶ï¼š1.75ms~~

9. ~~reorder ï¼ˆOCS å¤ç”¨ä»£ç ï¼Œ8SPCï¼‰~~

10. ~~é€šä¿¡é‡ï¼š28M * topk per die, å¸¦å®½ï¼š200GB/s å·¦å³ ,, é¢„è®¡è€—æ—¶ï¼š0.15ms * topk = 1.2ms~~

~~ä¸¤æœºæ€»è€—æ—¶ï¼š~~

- ~~ç†è®ºè€—æ—¶ (çº¢è‰²æ“ä½œå¯å¹¶è¡Œ)ï¼š0.15 + 4.3 + 1.75 + 1.75 + 1.2 = 9.15 msï¼Œç¬¬ 2ã€3 æ­¥å¹¶è¡Œåï¼Œ7.4 msã€‚~~

- ~~é¢„è®¡å®é™…è€—æ—¶ (çº¢è‰²æ“ä½œå¯å¹¶è¡Œ)ï¼š0.15 + 5.4 + 1.75 + 1.75 + 1.2 = 10.25 msï¼Œ**ç¬¬ 2.aã€3 æ­¥å¹¶è¡Œå**ï¼Œ8.5 msã€‚ ç†è®ºä¸Š 2a.2b ä¸åŒçš„ token ä¹Ÿå¯ä»¥ pipeline æ¥å£è®¾è®¡å·²ç»é¢„ç•™ã€‚~~

æ¯ die ç‹¬ç«‹ virtual rank æ–¹æ¡ˆ

æ¯ä¸ª die å¤„ç† 2048 ä¸ª tokenï¼Œä¸€ä¸ª token æ—¶ 7168 ä¸ª BF16 = 28MB æ•°æ®ã€‚

1. reorder (OCS å¤ç”¨ä»£ç ï¼Œ 8 SPCï¼‰

2. é€šä¿¡é‡ï¼š28M per die, å¸¦å®½ï¼š600GB/s å·¦å³ï¼ˆ**_3.5 å€Å’_**ï¼‰, é¢„è®¡è€—æ—¶ï¼š0.05msã€‚ 28MB = batch1 _8å€Å’_7168*sizeof(BF16)

3. **nic forward** ï¼ˆinter-nodeï¼Œ OCS æ²¡è¿™ partï¼Œ port1 column éœ€è¦ 1 ä¸ª SPC for RDMA) + p2p forward (OCS topo ä¸åŒï¼Œ2.b è·Ÿ 3.a æ˜¯åŒä¸€ä¸ª device function, 8 SPC 4+4 )

4. nic forwardï¼ˆé€šä¿¡é‡ï¼š56Mï¼Œé€šä¿¡æ¦‚ç‡ï¼š1 - (1/2)^8 = 1ï¼Œç†è®ºå¸¦å®½ï¼š**13GB/s(with RoCEv2, IB 15-16GB/s)**ï¼Œé¢„è®¡å®æµ‹ä¸ºç†è®ºçš„ 80%ï¼Œé¢„è®¡ç†è®ºè€—æ—¶ï¼š**4.3ms**ï¼Œé¢„è®¡å®é™…è€—æ—¶ï¼š5.4msï¼‰

5. NLR : è·¨çº§å‡ ç‡é™ä½ 50%ã€‚Base æ–¹æ¡ˆ ä¸é‡‡ç”¨ã€‚

6. ~~p2p forwardï¼ˆç›´è¿è½¬å‘ï¼Œé€šä¿¡é‡ 1ï¼š56Mï¼Œ é€šä¿¡ 1 æ¦‚ç‡ï¼š1 - (12/16)^8 = 0.9ï¼Œé€šä¿¡é‡ 2ï¼š56Mï¼Œ é€šä¿¡ 2 æ¦‚ç‡ï¼š0.4ï¼Œå¸¦å®½ï¼š20GB/s * 2ï¼Œ é¢„è®¡è€—æ—¶ï¼š1.75msï¼‰~~

7. ã€€ **1. æœºå†…æ•°æ®é€šä¿¡é‡ä¸º: 28 MB per dieï¼Œå¸¦å®½ä¸º $20GB/s$ ï¼Œé¢„è®¡è€—æ—¶ 1.4 ms**

8. p2p forward ï¼ˆintra-node å•æœºå†…ï¼Œè·Ÿ OCS topo ä¸åŒ å•ä»£ç å¯èƒ½å¤ç”¨ï¼Œ9 SPC ï¼š 4+4 )

9. ~~ä¸ç¬¬äºŒæ­¥ä¸­çš„ p2p forward è¿‘ä¼¼ï¼Œé¢„è®¡è€—æ—¶ï¼š1.75ms~~

10. **2. æœºé—´æ•°æ®é€šä¿¡é‡ä¸º: 28 MB per dieï¼Œå¸¦å®½ä¸º $20GB/s$ ï¼Œé¢„è®¡è€—æ—¶ 1.4 ms**

11. reorder ï¼ˆOCS å¤ç”¨ä»£ç ï¼Œ8SPCï¼‰

12. é€šä¿¡é‡ï¼š28M * 8 ä¸“å®¶ per per die, å¸¦å®½ï¼š600GB/s å·¦å³ ï¼ˆ**_ æ¯ die ç‹¬ç«‹ HBM çš„ 600GB/s å¸¦å®½ _**ï¼‰,é¢„è®¡è€—æ—¶ï¼š0.05ms * topk = 0.4ms

VirtualNode æ–¹æ¡ˆé‡Œã€‚ intranode æœ€é•¿çš„è·¯å¾„ 2xP2P + 1D2D. ç”¨ä¿å®ˆçš„æ–¹å¼æ¥é¢„è®¡æ˜¯ 2.8msã€‚ä½† UBBv2 çš„ç“¶é¢ˆä¸åœ¨ intranode ,

è€Œæ˜¯ inter-node çš„ RDMA. RDMA çš„é€šä¿¡åœ¨ 4.3ms(å®é™… 80% åˆ©ç”¨ç‡ 5.4ms). intranode æ— è®ºæ˜¯ 2.8ms è¿˜æ˜¯ 3.0ms èƒ½è¢« RDMA éšè—ï¼Œ å¯¹å¤§å±€å½±å“ä¸å¤§ ã€‚

inter-node å¾ˆä¸å¹¸æ¯ä¸ª token å»å¯¹æ–¹ node èµ° RDMA çš„å‡ ç‡å‡ ä¹æ˜¯ 100%ï¼ˆ 1 - (1/2)^8 ~= 1ï¼‰ã€‚æ‰€ä»¥å°±æ— è„‘å‘ç»™å¯¹æ–¹ node çš„ mate å°±å¥½äº†ã€‚

æ—¢ç„¶å…¨å‘ç»™å¯¹æ–¹ï¼Œé‚£æ¥ä¸‹æ¥å°±æ˜¯è¦éœ€è¦è®¾è®¡åˆé€‚çš„ RDMA çš„ pipe ç²’åº¦ ï¼ˆeg. 128. 256 token æ¯æ¬¡) æ›´å¥½çš„åˆ©ç”¨ RDMA çš„å¸¦å®½æ¯”è¾ƒå…³é”®ã€‚

### 3.2 (åŸºäº EP16ï¼ˆ8 å¡ 16DIEï¼‰ï¼Œæ¯ä¸ª DIE 4K tokenï¼Œ56M per die)

å®ç°æ–¹å¼ä¸»è¦åˆ†ä¸º 4 æ­¥:

1. reorder

2. é€šä¿¡é‡ï¼š56M per die, å¸¦å®½ï¼š200GB/s å·¦å³, é¢„è®¡è€—æ—¶ï¼š0.3ms

3. 2.a p2p forward1 (inter-group via mate) + 2.b (intra-group) p2p forward2

4. p2p forward1ï¼ˆé€šä¿¡é‡ï¼š112Mï¼Œé€šä¿¡æ¦‚ç‡ï¼š1-(4/8)^8=1ï¼Œç†è®ºå¸¦å®½ï¼š20GB/s * 2ï¼Œé¢„è®¡è€—æ—¶ï¼š2.8msï¼‰

5. p2p forward2ï¼ˆé€šä¿¡é‡ï¼š112Mï¼Œé€šä¿¡æ¦‚ç‡ï¼š1-(7/8)^8=0.66ï¼Œç†è®ºå¸¦å®½ï¼š20GB/s * 2ï¼Œé¢„è®¡è€—æ—¶ï¼š1.9msï¼‰

6. ~~permutation~~

7. ~~ä¸ç¬¬äºŒæ­¥ä¸­çš„ 2b p2p forward2 è¿‘ä¼¼ï¼Œé¢„è®¡è€—æ—¶ï¼š1.9ms.~~

8. ~~2.3 å…¶å®åœ¨ä¸€èµ·çš„~~

9. reorder

10. é€šä¿¡é‡ï¼š56M * topk per die, å¸¦å®½ï¼š200GB/s å·¦å³, é¢„è®¡è€—æ—¶ï¼š0.3ms * topk = 2.4ms

å•æœºæ€»è€—æ—¶ï¼ˆå•æœºæ—¶ token num å˜ä¸º 4k per dieï¼‰ï¼š

- 0.3 + 2.8 + 1.9 + 1.9 + 2.4 = 9.3 msï¼Œç¬¬ 2ã€3 æ­¥å¹¶è¡Œå 7.4 msã€‚ ç›¸æ¯” AllGather + permutation æ–¹æ¡ˆçš„ 15-16ms ä»ç„¶æœ‰ä¼˜åŠ¿ã€‚

mate éœ€è¦æœ‰ä¸€å— buffer ç”¨æ¥è½¬å‘.

### 3.3 äººåŠ›é¢„ä¼°&å¼€å‘è®¡åˆ’

[[RDMA + GPU][Develop Plan]]([https://conf01.birentech.com/pages/viewpage.action?pageId=224551230](https://conf01.birentech.com/pages/viewpage.action?pageId=224551230))

# å››ã€64 æœº EP64

ï¼ˆå¯¹åº”é…ç½® TP1EP64DP32PP16MB1ï¼‰

- å•å¡ä¸Šçš„æ•°æ®é‡ 56 MBï¼Œæœ€åæƒ…å†µä¸‹ï¼Œæ¯ä¸ªå¡ä¸Šçš„æ‰€æœ‰çš„æ•°æ®éƒ½éœ€è¦å‘é€åˆ°å…¶ä»– 3 å°æœåŠ¡å™¨ä¸Šï¼Œå¢åŠ çš„æœºé—´é€šä¿¡é‡å˜æˆä¸¤æœºçš„ä¸‰å€ã€‚

- æœºå†…ä»æ•°æ®é‡æœ€å·®æƒ…å†µä¸‹ï¼Œä» 112 MB å˜æˆ 224 MBã€‚

- ä½†ä½¿ç”¨ Deepseek çš„ Node Limited Routing([Node-Limited Routing (NLR) - SLO(Libraries) - Confluence]([https://conf01.birentech.com/pages/viewpage.action?pageId=220680515](https://conf01.birentech.com/pages/viewpage.action?pageId=220680515))): ç†è®ºä¸Šèµ°å‡å°‘ inter-node é€šä¿¡é‡ å¢å¤§ intra-node é€šä¿¡é‡

# äº”ã€å¿…è¦æ€§ä¸æ€§èƒ½æ”¶ç›Š

æ³¨ 1ï¼šä¸‹è¡¨ä¸­ç¬¬#1 è¡Œä¸º base caseï¼Œæ˜¾å­˜ä½¿ç”¨é‡çº¦ä¸º max reserved = 61264MBï¼Œå¯¹åº”ä¸‹è¡¨ä¸­è®¡ç®—å…¬å¼ä¸ºï¼ˆA + Mï¼‰ã€‚

æ³¨ 2ï¼šçº¢è‰²æ ‡æ³¨ä¸ºç°æœ‰æ–¹æ¡ˆæ”¹ä¸ºæœ¬ DeepEP æ–¹æ¡ˆåï¼Œé€šä¿¡éƒ¨åˆ†è€—æ—¶çš„å˜åŒ–ã€‚

|1|16|1|16|8|16|2|4|2048|16|A(tt) + M(lp)|t1|t2|16.5 â†’ 6.2|||

|2|16|1|32|16|8|1|8|2048|8|A/2 + M|t1/2|t2||||

|3|16|1|32|16|8|2|8|4096|8|A + 2M|t1|2t2||||

|||||||||||||||||

|4|32|1|32|16|16|1|4|2048|8|A/2 + M/2|t1/2|t2/2|17.6 â†’ 12|||

|5|32|1|32|16|16|2|4|4096|8|A + M|t1|t2||||

|6|32|1|32|16|16|4|4|8192|8|2A + 2M|2t1|2t2||||

|||||||||||||||||

|7|64|1|64|32|16|1|4|4096|4|A/2 + M/2|t1/2|t2/2||||

## 1ã€å¿…è¦æ€§

- æ˜¾å­˜ï¼š

- - åœ¨â€œç­–ç•¥ 1â€æ—¶ï¼Œå°† token åˆ†å‘è°ƒåˆ°å¼ºåˆ¶å‡è¡¡æ¨¡å¼ï¼Œå•å¡æ˜¾å­˜ç”¨é‡ 60-63 GBã€‚

- åœ¨â€œç­–ç•¥ 4â€æ—¶ï¼Œé¢„ä¼°æ˜¾å­˜æ¶ˆè€—å°†å˜ä¸ºâ€œç­–ç•¥ 1â€çš„ä¸€åŠã€‚ä»¥åº”å¯¹ä¸å‡è¡¡æ—¶çš„æç«¯æ˜¾å­˜ç”¨é‡ã€‚

- åœ¨â€œç­–ç•¥ 7â€æ—¶ï¼Œæ˜¾å­˜ç”¨é‡åŒâ€œç­–ç•¥ 4â€ã€‚

- ç®—å­æ€§èƒ½ä¿è¯ï¼šGrouped GEMM çš„è¾“å‡º shape(m/k/n)

- - m=1024 æ—¶ï¼ŒTCore åˆ©ç”¨ç‡ä¸º 34%ã€‚

- m=2048 æ—¶ï¼ŒTCore åˆ©ç”¨ç‡ä¸º 42%ã€‚

- m=4096 æ—¶ï¼ŒTCore åˆ©ç”¨ç‡ä¸º 53%ï¼Œèƒ½å‡å°‘ 1/4 çš„ Grouped-GEMM è®¡ç®—æ—¶é—´ã€‚

## 2ã€æ€§èƒ½æ”¶ç›Š

- å•æœº EP16 åœºæ™¯

- - å½“ä¸‹å•æœºä¸­é‡‡ç”¨ dispatch=allgather+permutation å’Œ combine=unpermutation+reducescatter çš„æ–¹æ¡ˆï¼Œé€šä¿¡è€—æ—¶å  e2e çš„ **21%**ã€‚

- å½“åˆ‡æ¢ä¸º DeepEP å®ç°åï¼Œdispatch é€šä¿¡è€—æ—¶ä» 16.5 ms é™è‡³ 6.2 msï¼Œé€šä¿¡è€—æ—¶é™ä½ 62.4%ï¼Œå¯¹ e2e çš„æå‡ 62.4% * 21% = **13%**ã€‚

- ä¸¤æœº EP32 åœºæ™¯

- - æ€§èƒ½æ”¶ç›Šæ¥æº 1ï¼šé€šä¿¡è€—æ—¶ä»å•æœº 16.5ms ä¸‹é™è‡³ 10.5 msï¼Œé€šä¿¡è€—æ—¶é™ä½ 36.4%ï¼Œç›¸å¯¹å•æœºå¯¹ e2e çš„æå‡ 36.4% * 21% = **7.6%**ã€‚

- æ€§èƒ½æ”¶ç›Šæ¥æº 2ï¼šæ˜¾å­˜ä» 60GB ä¸‹é™è‡³ 30GB åï¼Œå¯ä»¥é€‚å½“å‡å°‘éƒ¨åˆ†ç®—å­çš„ä»è®¡ç®—ï¼Œä»¥æå‡æ€§èƒ½ã€‚stage1 çš„æ˜¾å­˜ç›¸å¯¹å ç”¨è¾ƒé«˜ï¼Œå•å±‚å¯é‡Šæ”¾ 2 GB æ˜¾å­˜å ç”¨ï¼ˆå…·ä½“å‡å°‘é‡è®¡ç®—æ“ä½œå¯å‚è§ [1.7offload with recompute]([https://conf01.birentech.com/display/solution/1.7offload+with+recompute](https://conf01.birentech.com/display/solution/1.7offload+with+recompute))ï¼‰ï¼Œe2e æå‡çº¦**5%-10%**ã€‚

# å…­ã€UBBV2-Port10 åˆ©ç”¨

> äº’è”æ–¹å¼ä¸ºå°†åŒä¸€ä¸ªæœºæ¶ä¸Šçš„ä¸¤å°æœåŠ¡å™¨çš„æ‰€æœ‰åŒå·å¡çš„ GPU Port-10 é‡‡ç”¨é“œç¼†è¿›è¡Œäº’è”ã€‚

## 1ã€å¸¦å®½æ”¶ç›Š

- PPï¼šä»…ä½¿ç”¨åˆ°ä¸¤æœº send/recvï¼Œ10 - 17 GB/s â†’ 29 GB/sï¼ˆæ­¤å¸¦å®½ä¸ºä¸è·¨ Die åœºæ™¯ä¸­å¸¦å®½ï¼Œè·¨ Die æ—¶ï¼Œæ€§èƒ½ä¼šé€‚å½“é™ä½ï¼‰

- DPï¼šä½¿ç”¨åˆ°çš„ allgather/reducescatter æ¥å£çš„å¸¦å®½ä¸ºèšåˆå¸¦å®½ï¼Œ

- - ä¸¤æœºæ—¶ï¼Œä¸¤å€ send/recv å¢ç›Šã€‚

- å››æœºæ—¶ï¼Œ

- æ›´å¤šæœºåœºæ™¯ä¸­ï¼Œå¯é€šè¿‡å¤šçº§ç­–ç•¥ï¼Œåˆ†çº§è¿›è¡Œé€šä¿¡ã€‚

- EPï¼šè·¨æœºé‡‡ç”¨ DeepEP åœºæ™¯ä¸‹ï¼Œè·¨æœºå¸¦å®½ï¼Œ

- - ä¸¤æœº send/recvï¼Œ10 - 17 GB/s â†’ 29 GB/sã€‚

- å››æœº send/recv å¸¦å®½ï¼Œ13 GB/s â†’ 26 - 28 GB/sã€‚

## 2ã€ç«¯åˆ°ç«¯æ”¶ç›Š

- dense æ¨¡å‹ï¼š3%

- moe 567Bï¼š5 - 10%

- DeepSeek V3:

- - EP32 åœºæ™¯ä¸‹ï¼Œe2e æ”¶ç›Š 3.5%ã€‚

- EP32 åœºæ™¯ä¸‹ï¼Œe2e æ”¶ç›Š ï¼Ÿï¼Ÿã€‚

## 3ã€æˆæœ¬å¢åŠ 

ubbv2 æ¥å…‰å£ï¼š2k+

é“œç¼† (æ¯ä¸¤æœºå…±ç”¨ 8 æ ¹ï¼Œ1k/æ ¹)ï¼š4k

æ€»è®¡ï¼š6k+/server

## Reference

1ã€[[BR100(BR166) SCCL Arch][SCCL dev plan]]([https://conf01.birentech.com/pages/viewpage.action?pageId=171773456](https://conf01.birentech.com/pages/viewpage.action?pageId=171773456))

2ã€[2.DeepEPä»£ç æ¢³ç†]([https://conf01.birentech.com/pages/viewpage.action?pageId=220664903](https://conf01.birentech.com/pages/viewpage.action?pageId=220664903))

3ã€[[BR166] EP16 Alltoallvæ–¹æ¡ˆè®¾è®¡ä¸æ€§èƒ½è¯„ä¼°]([https://conf01.birentech.com/pages/viewpage.action?pageId=216674175](https://conf01.birentech.com/pages/viewpage.action?pageId=216674175))

[èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883)) æˆä¸ºç¬¬ä¸€ä¸ªèµåŒè€…

- æ— æ ‡ç­¾

- [ç¼–è¾‘æ ‡ç­¾]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883#) "ç¼–è¾‘æ ‡ç­¾ (è¾“å…¥â€œlâ€)")

## 6 è¯„è®º

1. [![ç”¨æˆ·å›¾æ ‡: E01078]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01078](https://conf01.birentech.com/display/~E01078))

### [Weidong Zhang(Cliffside)]([https://conf01.birentech.com/display/~E01078](https://conf01.birentech.com/display/~E01078)) å‘è¡¨

Xia Can 5-26 16:18:51

2.1 ms

![]([https://conf01.birentech.com/download/attachments/220667883/image2025-5-26_20-4-50.png?version=1&modificationDate=1748261091000&api=v2](https://conf01.birentech.com/download/attachments/220667883/image2025-5-26_20-4-50.png?version=1&modificationDate=1748261091000&api=v2))

[2, 4096, 7168] 256 ä¸ªä¸“å®¶ topK8ï¼Œå†æŒ‰ç…§ 32 ä¸ªä¸“å®¶ä¸€ç»„åˆ’åˆ†ï¼Œè¾“å‡º 8 ä¸ª buffer, å»é™¤é‡å¤

Xia Can 5-26 16:21:40

=== tokens_per_local_expert_list:[5381, 5357, 5385, 5372, 5565, 5433, 5363, 5402] topk:8

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=224542682&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=224542682&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [äº”æœˆ 26, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=224542682#comment-224542682](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=224542682#comment-224542682) "äº”æœˆ 26, 2025 20:05")

2. [![ç”¨æˆ·å›¾æ ‡: E01185]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185))

### [Tingxing Dong(Tim)]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185)) å‘è¡¨

GPU ä¹‹é—´ P2P è¿çº¿æ€ä¹ˆè¿™ä¹ˆå°‘ï¼Ÿ æ‰ 4 æ ¹å—ï¼Ÿ

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=228174506&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=228174506&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [å…­æœˆ 12, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174506#comment-228174506](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174506#comment-228174506) "å…­æœˆ 12, 2025 11:00")

1. [![ç”¨æˆ·å›¾æ ‡: E01078]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01078](https://conf01.birentech.com/display/~E01078))

### [Weidong Zhang(Cliffside)]([https://conf01.birentech.com/display/~E01078](https://conf01.birentech.com/display/~E01078)) å‘è¡¨

ç”±äº M/S Die æ˜¯çš„é“¾è·¯æ˜¯ä¸€æ ·çš„ï¼Œè¿™é‡Œç”»äº†ä¸€ä¸ªç®€ç•¥å›¾ã€‚

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=228174993&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=228174993&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [å…­æœˆ 12, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174993#comment-228174993](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174993#comment-228174993) "å…­æœˆ 12, 2025 14:24")

3. [![ç”¨æˆ·å›¾æ ‡: E01185]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185))

### [Tingxing Dong(Tim)]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185)) å‘è¡¨

1 å•æœºä¸­ã€‚GPU0-4ï¼Œ GPU4-5 å¯ä»¥è§†ä¸ºä¸€ä¸ª virtual node. æ¯ä¸ª intra virtual node (VN) å¡ä¸éœ€è¦è½¬å‘ã€‚inter -VN ä¹‹é—´ éœ€è¦è½¬å‘ã€‚Node ä¸è¦çº ç»“å•æœºç‰©ç†åˆ’åˆ†ï¼Œè€Œä»é€»è¾‘åˆ’åˆ† VNã€‚ ç±»ä¼¼ OCS ä¸­ Node Limited Routing ä¸­çš„ virtual node æ¦‚å¿µã€‚ åŒæœºä¸­ï¼ŒVN æ›´å¤šäº†ã€‚

2ï¼Œè½¬å‘ä¸­ ç”±äºæœ‰çš„ token æ˜¯åœ¨ local çš„ï¼Œæ‰€ä»¥æ— è®º intraVN, interVN. æ¯ä¸€æ­¥ä¸­éƒ½ä¼´éšæœ‰ local çš„ permutation.

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=228174790&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=228174790&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [å…­æœˆ 12, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174790#comment-228174790](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174790#comment-228174790) "å…­æœˆ 12, 2025 15:20")

4. [![ç”¨æˆ·å›¾æ ‡: E01185]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185))

### [Tingxing Dong(Tim)]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185)) å‘è¡¨

uBBv2 è¿™æ ·ä¸€ä¸ª VN ä¹‹é—´çš„ TOPO å½¢æ€ä¸­ M-M+S-S both è¿çš„æƒ…å†µä¸åŒäº OCS ä¸­ M-M/S-S 2 é€‰å…¶ 1 çš„æƒ…å†µã€‚ intraVN ä»£ç éœ€è¦ä¿®æ”¹ ä¸èƒ½ç®€å•å¤ç”¨ã€‚

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=228174815&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=228174815&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [å…­æœˆ 12, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174815#comment-228174815](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=228174815#comment-228174815) "å…­æœˆ 12, 2025 15:11")

5. [![ç”¨æˆ·å›¾æ ‡: E01185]([https://conf01.birentech.com/images/icons/profilepics/default.svg](https://conf01.birentech.com/images/icons/profilepics/default.svg))]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185))

### [Tingxing Dong(Tim)]([https://conf01.birentech.com/display/~E01185](https://conf01.birentech.com/display/~E01185)) å‘è¡¨

æœ€è¿œçš„è·ç¦»éœ€è¦ä¸¤æ¬¡è½¬å‘ 2xP2P + RDMA

- [å›å¤]([https://conf01.birentech.com/pages/replycomment.action?commentId=229638184&pageId=220667883](https://conf01.birentech.com/pages/replycomment.action?commentId=229638184&pageId=220667883))

- [èµ]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883))

- [å…­æœˆ 12, 2025]([https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=229638184#comment-229638184](https://conf01.birentech.com/pages/viewpage.action?pageId=220667883&focusedCommentId=229638184#comment-229638184) "å…­æœˆ 12, 2025 17:25")

[![ç”¨æˆ·å›¾æ ‡: æ·»åŠ å¤´åƒ]([https://conf01.birentech.com/s/-bsk5pj/8703/51k4y0/_/images/icons/profilepics/add_profile_pic.svg](https://conf01.birentech.com/s/-bsk5pj/8703/51k4y0/_/images/icons/profilepics/add_profile_pic.svg))]([https://conf01.birentech.com/users/profile/editmyprofilepicture.action](https://conf01.birentech.com/users/profile/editmyprofilepicture.action))

å†™è¯„è®º..
                     