# 高性能网络

要系统性地掌握网络核心技术，尤其是 **Socket 编程** 和 **RDMA（Remote Direct Memory Access）**，需要一个**循序渐进、理论与实践结合**的学习路径。这两项技术分别代表了**传统网络通信**和**高性能网络通信**的典型范式。

---

## 二、阶段 1：打好基础（必备前置知识）

### 1. **计算机网络基础**

- 掌握 TCP/IP 协议栈（四层模型）
- 理解 **IP、TCP、UDP、ARP、ICMP** 等协议
- 重点掌握：
  - **TCP 三次握手、四次挥手**
  - **滑动窗口、拥塞控制**
  - **端口号、IP 地址、子网划分**

✅ 推荐书籍：

- 《计算机网络：自顶向下方法》（James Kurose）
- 《TCP/IP 详解 卷 1：协议》（W. Richard Stevens）

✅ 工具实践：

- `ping`, `traceroute`, `netstat`, `ss`, `tcpdump`, `Wireshark` 抓包分析

---

### 2. **操作系统基础**

- 进程、线程、文件描述符
- 系统调用机制（`read`, `write`, `select` 等）
- 内核态与用户态切换
- 缓存、DMA、中断处理

✅ 重点理解：

- **Socket 是一种文件描述符**
- **I/O 多路复用**（`select`, `poll`, `epoll`）的底层机制

---

## 三、阶段 2：掌握 Socket 编程（网络通信基石）

Socket 是**几乎所有网络应用的基础**，必须扎实掌握。

### 1. **学习内容**

| 主题 | 关键点 |
|------|--------|
| **Socket API** | `socket()`, `bind()`, `listen()`, `accept()`, `connect()`, `send()`, `recv()` |
| **TCP 编程** | 面向连接、可靠传输、服务器/客户端模型 |
| **UDP 编程** | 无连接、低延迟、需自行处理丢包 |
| **I/O 多路复用** | `select`, `poll`, `epoll`（Linux 高性能服务器核心） |
| **地址结构** | `struct sockaddr_in`, `htons`, `inet_addr` |
| **网络字节序** | `htonl`, `ntohs` 等转换函数 |

---

### 2. **动手实践项目**

✅ 项目 1：实现一个简单的 TCP 回显服务器

```c
// 服务器：接收客户端消息并原样返回
// 客户端：发送消息，接收回显
```

✅ 项目 2：支持多客户端的并发服务器

- 使用 **多进程**（`fork`）
- 使用 **多线程**（`pthread`）
- 使用 **epoll + 非阻塞 I/O**（高性能）

✅ 项目 3：HTTP 简易服务器

- 解析 HTTP 请求头
- 返回简单的 HTML 页面
- 理解 Web 协议如何基于 Socket 构建

---

### 3. **深入理解**

- **阻塞 vs 非阻塞 Socket**
- **同步 vs 异步 I/O**
- **惊群问题（Thundering Herd）**
- **C10K 问题**：如何支持 1 万并发连接？

✅ 推荐学习：

- 《UNIX 网络编程 卷 1：套接字联网 API》（W. Richard Stevens）—— **圣经级教材**
- 使用 `strace` 跟踪系统调用，理解内核交互

---

## 四、阶段 3：深入 RDMA（高性能网络核心）

RDMA 是**高性能计算（HPC）、AI 训练、分布式数据库**的关键技术，能实现**零拷贝、内核旁路、低延迟**通信。

### 1. **先理解 RDMA 的核心价值**

| 传统 TCP/IP | RDMA |
|------------|------|
| 数据路径：应用 → 内核 → 网卡 → 网络 | 应用 → 网卡 → 网络（内核旁路） |
| CPU 开销大 | CPU 几乎不参与 |
| 延迟高（~10μs） | 延迟极低（~1μs） |
| 需要数据拷贝 | 零拷贝（直接内存访问） |

> ✅ RDMA = **Remote DMA**，即远程直接内存访问

---

### 2. **RDMA 的三种实现**

| 技术 | 说明 |
|------|------|
| **InfiniBand (IB)** | 原生支持 RDMA，HPC 主流 |
| **RoCE (RDMA over Converged Ethernet)** | 在以太网上实现 RDMA（v1: 二层, v2: UDP） |
| **iWARP** | 基于 TCP 的 RDMA，较少使用 |

> ✅ 当前主流：**InfiniBand** 和 **RoCE v2**

---

### 3. **RDMA 编程模型（Verbs API）**

RDMA 使用 **libibverbs** 库，编程接口称为 **Verbs API**，比 Socket 复杂。

#### 核心概念

| 概念 | 说明 |
|------|------|
| **Queue Pair (QP)** | 发送队列（SQ）和接收队列（RQ），通信的基本单元 |
| **Completion Queue (CQ)** | 存放操作完成事件（如发送完成） |
| **Memory Region (MR)** | 注册的内存区域，允许远程访问 |
| **Protection Domain (PD)** | 内存保护域 |
| **Address Handle (AH)** | 目标节点的网络地址封装 |

#### 通信类型

- **Send/Recv**：消息传递
- **Write**：远程写（无需对方参与）
- **Read**：远程读
- **Atomic**：远程原子操作（CAS）

---

### 5. **高级主题**

- **可靠连接（RC） vs 无连接（UD）**
- **共享 Receive Queue (SRQ)**
- **Multicast**
- **GPUDirect RDMA**：GPU 显存直接远程访问
- **内核旁路 vs 内核集成**（如 `SoftRoCE`）

---

## 五、阶段 4：实战与优化

### 1. **对比测试：Socket Vs RDMA**

- 实现相同功能（如 echo server）
- 测试不同消息大小下的**延迟**和**吞吐**
- 使用 `tcpdump` 和 `ibstat` 分析网络行为

### 2. **集成到高性能框架**

- 学习 **MPI** 如何使用 RDMA（如 OpenMPI + OFED）
- 学习 **NCCL** 如何利用 RDMA 进行 GPU 间通信
- 理解 **Spark** 或 **Flink** 在 RDMA 网络下的优化

### 3. **性能分析工具**

| 工具 | 用途 |
|------|------|
| `ibstat`, `iblinkinfo` | InfiniBand 网络状态 |
| `perf` | CPU 性能分析 |
| `Wireshark`（支持 RoCE） | 抓包分析 |
| `rdma-core` 工具集 | `rping`, `rdma_xclient` 测试工具 |

---

## 六、学习资源汇总

| 类型 | 推荐 |
|------|------|
| **书籍** | 《UNIX 网络编程》《RDMA Essentials》《High Performance Parallelism》 |
| **课程** | MIT 6.824（分布式系统）<br>Stanford CS244（Advanced Topics in Networking） |
| **实验室** | 使用云服务（如阿里云 HPC 实例、AWS EC2 p4d）<br>或搭建本地 InfiniBand 测试环境 |
| **社区** | RDMA-Community（邮件列表）<br>Stack Overflow（标签：`rdma`, `infiniband`） |

✅ 推荐书籍/文档：

- 《RDMA over Converged Ethernet (RoCE) 用户指南》
- [InfiniBand Trade Association 官方文档](https://www.infinibandta.org/)
- Linux 内核 `Documentation/infiniband/`

✅ 开源项目学习：

- **perftest**：InfiniBand 官方性能测试工具（`ib_send_bw`, `ib_read_lat`）
  - 源码地址：https://github.com/linux-rdma/perftest
- **rsocket**：兼容 Socket API 的 RDMA 库（透明替换）

✅ 动手实践：

1. 搭建 InfiniBand 或 RoCE 网络环境（可用云服务器或实验室）
2. 编译运行 `perftest`，测试带宽和延迟
3. 阅读 `ib_send_lat.c` 源码，理解 QP 创建、连接、通信流程
4. 尝试编写一个简单的 RDMA Send/Recv 程序

## 💡 总结

| 技术 | 学习重点 | 应用场景 |
|------|----------|----------|
| **Socket** | TCP/UDP、epoll、非阻塞 I/O | Web 服务器、微服务、通用网络应用 |
| **RDMA** | Verbs API、QP、CQ、零拷贝 | HPC、AI 训练、金融交易、分布式数据库 |
