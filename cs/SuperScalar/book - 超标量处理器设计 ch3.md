---
dateCreated: 2025-02-24
dateModified: 2025-03-04
---
# Ch 3 虚拟存储器
## 3.1 概述

**虚拟存储器（Virtual Memory）** 但基本思想是，对于一个程序来说，它的 code/data/stack 的总大小可以超过实际物理内存的大小。操作系统把当前使用的部分放到物理内存中，而把其他未使用的部分放到更下一级存储器，如 disk/flah 中。比如一个大小为 32 MB 的程序运行在物理内存只有 16 MB 的机器上，操作系统通过选择，决定各个时刻将程序中的一部分 16 MB（或更小）的内容放在物理内存中，而把其他内容放到硬盘中，并在需要的时候在物理内存和硬盘之间交换程序片段。

可以说，一个程序就是运行在虚拟存储器空间的，它的大小由处理器的位宽决定。如 32 位处理器地址范围是 $0~0xFFFFFFFF$ 即 4 GB 这个范围就是程序可以产生的地址范围，其中的某个地址就称为虚拟地址。和虚拟存储器对应的是物理存储器，它是现实中可以直接使用的存储器，其中的某个地址就称为物理地址。物理存储器的大小不能超过处理器的最大可寻址空间。

没有使用虚拟地址的系统，处理器输出的地址直接送到物理存储器。使用了虚拟地址，处理器输出虚拟地址，这个地址会经过**内存管理单元（Memory Manage Unit, MMU）** 进行地址转换。

![](assets/ch3%20虚拟存储器/使用虚拟存储器.png)

使用虚拟存储器不仅便于程序运行，还可以给程序编写带来好处。直接使用物理存储器，如果需要同时运行多个程序，每个程序需要分配一块地址空间，这限制了程序的编写，而且不能使处理器随意执行程序。这对于应用领域比较单一的嵌入式系统是没问题的。对于扩展性要求高的复杂系统，需要虚拟存储器，这时每个程序总认为它占有处理器的所有地址空间，因此程序可以任意使用处理器的地址资源。编写程序时不需要考虑地址的限制，每个程序认为处理器中只有自己在运行，这些程序放到处理器中运行的时候，由操作系统负责调度，将物理存储器动态地分配各个程序，将每个程序的虚拟地址转化为相应的物理地址。

使用虚拟存储器不仅可以降低物理存储器的容量需求，还可以带来另外的好处，如**保护和共享**。通过操作系统动态地将每个程序的虚拟地址转化为物理地址，还可以实现程序的保护，即使两个程序都使用了同一个虚拟地址，它们也会对应到不同的物理地址，保证每个程序的内容不会被其他程序随便改写。而且通过这样的方式还可以实现程序简单共享，如操作系统内核提供了打印函数，第一个程序在地址 A 使用了 printf 函数，第二个程序在地址 B 使用了 printf 函数，操作系统在地址转换赌场罪，会将地址 A 和 B 都转换为相同的物理地址，这个物理地址就是 printf 函数在物理存储器中的实际地址，这样实现了程序的共享。虽然两个程序都使用了 printf 函数，但与不会使得 printf 函数占用物理存储器的两个地方。

## 3.2 地址转换

## 3.3 程序保护

## 3.4 加入 TLB 和 Cache
